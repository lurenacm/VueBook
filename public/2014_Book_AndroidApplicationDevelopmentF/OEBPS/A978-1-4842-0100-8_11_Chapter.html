<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Performance Optimization for Android Applications on x86</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="Chap11"><div class="ChapterCopyright">© Ryan Cohen 2014</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Ryan Cohen</span> and </span><span class="Author"><span class="AuthorName">Tao Wang</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Android Application Development for the Intel<sup>®</sup> Platform</span></span><span class="ChapterDOI">10.1007/978-1-4842-0100-8_11</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">11. Performance Optimization for Android Applications on x86</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Ryan Cohen</span><sup>1 <span class="ContactIcon"/></sup> and </span><span class="Author"><span class="AuthorName">Tao Wang</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff1"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">OR, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par2" class="Para">Performance optimization is one of the most important goals every application developer wants to pursue, regardless of whether the application is for a general desktop Windows computer or an Android device. Android is a resource-limited system, and it therefore requires very strict resource utilization. Compared with a desktop system, performance optimization for Android applications is far more critical.</div><div id="Par3" class="Para">Different applications have different areas of focus regarding optimization. Performance optimization for Android systems generally falls into three categories: application running speed, code size, and power consumption. Generally speaking, storage space and cost for Android on Intel Atom processors is not a bottleneck, so this chapter focuses on performance optimization that makes applications run faster. <span class="ExternalRef"><a href="A978-1-4842-0100-8_13_Chapter.html"><span class="RefSource">Chapter 13</span></a></span> covers power-consumption optimization.</div><div id="Par4" class="Para">The chapter first introduces the basic principles of system on chip (SoC) performance optimization, followed by principles and methodology of performance optimization for Android-based development on Intel architecture. <span class="ExternalRef"><a href="A978-1-4842-0100-8_12_Chapter.html"><span class="RefSource">Chapter 12</span></a></span> discusses application development for Android on Intel architecture using the native development kit (NDK).</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Principles of Performance Optimization</h2><div id="Par5" class="Para">Optimizing an application’s performance really means optimizing the application’s <span class="EmphasisTypeItalic">execution speed</span>. The optimization aims at reducing the time needed to complete a specific task. This is achieved by making structural adjustments to the application based on either hardware or software.</div><div id="Par6" class="Para">When you’re optimizing an application’s performance, you need to follow several basic principles:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par7" class="Para">
                  <span class="EmphasisTypeItalic">Equal value principle</span>: There is no change in the result of the application’s execution after performance optimization.</div></li><li><div id="Par8" class="Para">: After performance optimization, the targeted code runs faster.</div></li><li><div id="Par9" class="Para">: Sometimes performance optimization achieves a performance improvement in some areas but degrades performance in others. You must consider combined overall performance in determining whether performance optimization is needed.</div></li></ul></div>
          </div><div id="Par10" class="Para">One of the most important considerations involves trading time and space. For example, to perform a function calculation, the values of the function can be precalculated and put into a program storage zone (memory) as a table. When a program is running, instead of spending time repeatedly calculating the function, the program can get the value directly from the table and reduce the execution time. Similarly, a search can be done on a large space using the hash method and thereby eliminate the need for a comparison operation.</div><div id="Par11" class="Para">Performance optimization is based on various techniques. The following sections describe several major ones.</div><div id="Sec2" class="Section2 RenderAsSection2"><h3 class="Heading">Reducing Instructions and Execution Frequency</h3><div id="Par12" class="Para">The technique that’s chosen most frequently to optimize performance involves reducing instructions and execution frequency. For example, from the point of view of data structures and algorithms, the instructions for comparison and exchange in bubbling sequencing need to execute <span class="EmphasisTypeItalic">O</span>(<span class="EmphasisTypeItalic">n</span>
              <sup>2</sup>) times. However, by using fast sequencing, you can reduce the instruction to <span class="EmphasisTypeItalic">O</span>(<span class="EmphasisTypeItalic">n</span> log <span class="EmphasisTypeItalic">n</span>) executions.</div><div id="Par13" class="Para">In loop optimization, code motion can extract irrelevant public code from the loop and reduce the execution time of public code from <span class="EmphasisTypeItalic">N</span> to 1, thus dramatically reducing the execution frequency. In addition, you can use inline functions supported by C and C++ to avoid embedding function-call code; you can omit the function-call instructions and the implementation of the return instructions.</div></div><div id="Sec3" class="Section2 RenderAsSection2"><h3 class="Heading">Selecting Faster Instructions</h3><div id="Par14" class="Para">You can perform the same function with different instructions. The different instructions take different machine clock cycles, and thus the execution times vary. This gives you the opportunity to choose a faster instruction.</div><div id="Par15" class="Para">Reducing computational strength is a typical example of performance optimization achieved by selecting a faster instruction set. For example, you can multiply an integer by 4 by shifting the operator two digits to the left. The shift instruction takes many fewer clock cycles and runs much faster than the multiplication or division instruction.</div><div id="Par16" class="Para">Another example is using special instructions provided by the hardware to replace generic instructions. For example, the Intel Atom processors support the Streaming SIMD Extensions (SSE) instruction set. For vector operations, you should always use SSE instructions: they run much faster thanks to instruction-level parallel processing. The ordinary addition instruction width for Intel Atom is 32 bits, whereas SSE instructions are capable of four times 32-bit data processing. As a result, optimized code using SSE instructions dramatically shortens the time consumed.</div></div><div id="Sec4" class="Section2 RenderAsSection2"><h3 class="Heading">Improving the Degree of Parallelism</h3><div id="Par17" class="Para">You can improve the degree of parallelism at multiple levels, including instruction, expression, function, and thread. Many modern embedded processors, including the Intel Atom processor, support instruction-pipeline execution. This lets you use an optimization method called <span class="EmphasisTypeItalic">instruction-level parallelism</span>. A code chain can be decomposed into several units of code that are not dependent on the chain and can be executed in parallel in the pipeline.</div><div id="Par18" class="Para">In addition, many embedded system processors, such as the Intel Atom processor, physically support the concurrent execution of threads. Using an appropriate number of concurrent threads rather than a single thread can increase running speed. In order to take advantage of thread-concurrency optimization, you need to consciously adopt multithreading technology; sometimes optimization must be done with compiler support.</div></div><div id="Sec5" class="Section2 RenderAsSection2"><h3 class="Heading">Using the Register Cache Effectively</h3><div id="Par19" class="Para">Writing and reading the cache register is much faster than doing the same with memory. The goal of cache optimization is to put data and instructions that are being used and will be used in the cache, to reduce the cache hit rate and reduce cache conflicts. Cache optimization often appears in the optimization process for a nested loop. Register optimization involves the effective use of the register and keeping frequently used data in the register as much as possible.</div><div id="Par20" class="Para">Cache is based on locality. That is, cache assumes the data to be used is located in the most recent data that is already in use or is in the vicinity of its own register. This is called the <span class="EmphasisTypeItalic">locality principle</span> or <span class="EmphasisTypeItalic">principle of locality</span>, which deeply affects hardware, software, and system design and performance. Instructions and data required by the processor are always first read by cache access. If high-speed cache has the needed data, the processor always accesses high-speed cache directly. In this situation, such an access is called a ; if high-speed cache does not contain the needed data, this is referred to as a <span class="EmphasisTypeItalic">failed hit</span> or <span class="EmphasisTypeItalic">cache miss</span>.</div><div id="Par21" class="Para">If this happens, the processor needs to copy data from memory to high-speed cache. If the corresponding location of high-speed cache is occupied by other data, data that is no longer needed in cache is expelled and written back to memory. Failed hits result in a sharp rise in access time; therefore the goal in increasing cache efficiency is to improve the hit rate and lower failure rates. Data exchange between cache and memory is done with a block unit, which is used to block-copy or write back blocks containing needed data as well as write blocks back to memory.</div><div id="Par22" class="Para">
              <span class="EmphasisTypeItalic">Locality</span> has two meanings:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par23" class="Para">: Due to temporal locality, the same data object may be reused many times. Once a data object is copied to the cache after a failed hit, there are many follow-up hits on the object. The follow-up hits run faster than the original failed hit.</div></li><li><div id="Par24" class="Para">: A block usually contains multiple data objects. Due to spatial locality, the cost of a block copy after a failed hit is shared by subsequent references to other objects.</div></li></ul></div>
            </div></div><div id="Sec6" class="Section2 RenderAsSection2"><h3 class="Heading">Performance Optimization Methodology</h3><div id="Par25" class="Para">Many methods and techniques area available for performance optimization. You can use one approach or multiple comprehensive optimization principles simultaneously, such as modifying the source code to run faster. Based on the type of criteria, optimization methods can be divided into different categories.</div><div id="Par26" class="Para">Depending on whether the optimization is associated with hardware, it is either <span class="EmphasisTypeItalic">machine-dependent optimization</span> and <span class="EmphasisTypeItalic">machine-independent optimization</span>. In machine-dependent optimization, application and code execution have nothing to do with the machine’s characteristics. These techniques are applicable to all machines. For example, moving code out of the loop, eliminating induction variables, and using strength-reduction technology can be applied to any machine or architecture (either x86 or ARM) to obtain the same optimal results.</div><div id="Par27" class="Para">Machine-dependent optimization can be done only on specific hardware or architecture. For example, switching ordinary vector instruction computing to use SSE instructions depends on many low-level details of the Intel Atom processor and can only be used on Intel processors that support SSE instructions. In general, machine-independent optimization is more complex and difficult to achieve than the machine-dependent optimization.</div></div></div><div id="Sec7" class="Section1 RenderAsSection1"><h2 class="Heading">Performance Optimization Approaches</h2><div id="Par28" class="Para">In an ideal scenario, the compiler should be able to compile any code you write and optimize it into the most efficient machine code. But the reality is that the compiler can automate only some of all possible optimizations, and the optimizations may be blocked by the optimization blocker. Depending on how much of a role human or automated tools play, performance optimization may be performed automatically by the compiler, done manually by the programmer manually, or performed with the assistance of development tools. The following sections present several approaches you can use to achieve performance optimization.</div><div id="Sec8" class="Section2 RenderAsSection2"><h3 class="Heading">Automatic Optimization by the Compiler</h3><div id="Par29" class="Para">Modern compilers can automatically complete the most common code optimizations, and this is the preferred way to optimize. This is also known as <span class="EmphasisTypeItalic">compiler optimization</span> or <span class="EmphasisTypeItalic">compiling optimization</span>. It must be triggered by appropriate extensions or switch variables.</div><div id="Par30" class="Para">C/C++ code optimization for Android applications can be achieved using the GCC compiler (one of the tools in the GNU toolchain) located in the NDK (the Android local development toolkit) or Intel Compiler (ICC). The next chapter covers this topic in detail.</div><div id="Sec9" class="Section3 RenderAsSection3"><h4 class="Heading">Performance Optimization Assisted by Development Tools</h4><div id="Par31" class="Para">It is very difficult to achieve overall, comprehensive optimization of a large program. Fortunately, for applications based on Intel architecture, many useful tools are available to help you complete the optimization. For example, Intel VTune Amplifier, Graphics Performance Analyzer (GPA), Power Monitoring Tool, and so on can help you analyze a program and complete the optimization.</div><div id="Par32" class="Para">GPA is an Intel product-development tool and can be used with Intel processors such as the Intel Atom processor as well as ARM devices. Intel Profiler is a GNU toolchain tool and can be used for all types of processors. You can use Profiler to create a profiling process that shows which areas of a program execute frequently and use more computing resources, and which areas are less frequently implemented. The profiling data provides valuable information you can use to complete the optimization.</div><div id="Par33" class="Para">A typical example of profile-guided optimization (PGO) is the optimization of the <span class="EmphasisFontCategoryNonProportional">switch</span> statement (such as the <span class="EmphasisFontCategoryNonProportional">switch</span>-<span class="EmphasisFontCategoryNonProportional">case</span> statement in C#). Based on the profile of the collected sample, after getting the frequency with which each <span class="EmphasisFontCategoryNonProportional">case</span> statement occurred, you sort the <span class="EmphasisFontCategoryNonProportional">case</span> statement in the <span class="EmphasisFontCategoryNonProportional">switch</span> statement by frequency: the most frequent statements are moved to the front (performing this statement required the fewest comparisons), to achieve optimal results with the fewest comparisons.</div><div id="Par34" class="Para">Intel GPA was originally a tool used for graphics processing unit (GPU) analysis. It has now developed into a comprehensive tool for analyzing CPU speeds, memory analysis, frame rate, and device power consumption. You can use GPA to get information about CPU load, operating frequency, and power consumption. It can guide you as you optimize an application, and it’s especially helpful for multithreaded optimization. Intel GPA is not only a speed-optimization tool but also a very handy power-optimization tool. More detailed discussion and use cases are presented later in this chapter and in <span class="ExternalRef"><a href="A978-1-4842-0100-8_13_Chapter.html"><span class="RefSource">Chapter 13</span></a></span>.</div><div id="Par35" class="Para">With optimization tools, you will no longer become disoriented or confused when trying to find a starting point for optimizing a large program. You can easily locate the areas that are most in need of optimization: the code segments that are potentially most problematic. Quickly finding the hot spots allows you to achieve optimization with less time and effort. Of course, performance optimization is complicated. The tool only plays a guiding and supporting role—the real optimization must still be completed by the compiler or manually by you.</div></div><div id="Sec10" class="Section3 RenderAsSection3"><h4 class="Heading">Using High-Performance Libraries</h4><div id="Par36" class="Para">are sets of software libraries, usually developed by a hardware OEM or special OEM, that provide commonly used operations and services. The code is carefully optimized based on a combination of processor features and has higher computing speed than ordinary code. Such high-performance databases use the full potential of the processor. For example, the Intel Integrated Performance Primitives (Intel IPP) libraries have been optimized based on SSE instructions for the processor, hyper/multithreaded parallel pipelined execution, and a waterfall process.</div><div id="Par37" class="Para">For some compute-intensive code and algorithms, using high-performance libraries is a simple, practical optimization method, just like standing on the shoulders of giants. Intel IPP can be used for mathematical calculations, signal processing, multimedia, image and graphics processing, vector calculations, and other fields. It uses a C/C++ programming interface.</div></div><div id="Sec11" class="Section3 RenderAsSection3"><h4 class="Heading">Manual Optimization</h4><div id="Par38" class="Para">You should not ignore the human factor during optimization. Some high-level global optimizations, such as optimizing algorithms and data structures, cannot be done by the compiler automatically. You must complete the optimization manually. As a programmer, in order to write efficient code, you should learn algorithms and optimization techniques to help you develop good programming habits and style. Even if the compiler can automatically complete the optimization, programmers still need to write efficient code to assist the compiler optimization at the following levels: <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par39" class="Para">
                      <span class="EmphasisTypeItalic">Source-code (high-level language) level</span>: You modify the source code to implement better algorithms or data structures to accomplish the optimization manually.</div></li><li><div id="Par40" class="Para">: Sometimes the high-level language is not enough to reach optimal results, and you need to modify the code down at the assembly-language level. In some key computing segments, although the process of assembly-level optimization is cumbersome, the performance benefit is totally worth it.</div></li><li><div id="Par41" class="Para">: This optimization is often accomplished through additions and modifications of compiler directives, such as modifying the typical compiler directive <span class="EmphasisFontCategoryNonProportional">pragma</span> and increasing the degree of parallelism in OpenMP.</div></li></ul></div>
              </div><div id="Par42" class="Para">Program-interactive optimization is a reflection of the art of programming, and the level of accomplishment enters the realm of the unity of human and machine. This is the focus of this chapter. Relatively speaking, optimizations performed at the assembly-language level or the instruction-level compiling phase require you to have comprehensive expertise about processor architecture, hardware, system, and so on. As a result, for Android systems on Intel architecture, we recommend optimizing performance at the source-code level. The following example introduces performance optimization on Android multithreaded design.</div><div id="Par43" class="Para">Optimization can be achieved in several ways that are related and structurally indivisible, although each has a unique function. The overall process is shown in Figure <span class="InternalRef"><a href="#Fig1">11-1</a></span>.<div class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img src="A978-1-4842-0100-8_11_Fig1_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig1_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-1.</span><div class="SimplePara">Recommended user optimization</div></div></div></div>
              </div><div id="Par44" class="Para">As Figure <span class="InternalRef"><a href="#Fig1">11-1</a></span> shows, manual optimization, compiler optimization, and high-performance library functions are tied together and are the final steps of optimization; you can select one of them to achieve the optimization. Both manual optimization and using high-performance libraries involve modifying the source code. Before you begin those optimizations, analyzing the program using optimization tools is a vital, beneficial step.</div></div></div></div><div id="Sec12" class="Section1 RenderAsSection1"><h2 class="Heading">Intel Graphics Performance Analyzers (Intel GPA)</h2><div id="Par45" class="Para">Intel GPA is a set of graphical tools for analysis and optimization that Intel launched a few years ago. It has evolved into a comprehensive tool for analyzing processor running state, system power, and other functions.</div><div id="Sec13" class="Section2 RenderAsSection2"><h3 class="Heading">Introduction to Intel GPA</h3><div id="Par46" class="Para">Intel GPA is only for Intel processors that support Intel Core and Intel Atom processor-based hardware platforms. It provides a GUI for CPU/GPU speed analysis and customization features. It enables you to find performance bottlenecks and optimize applications on devices based on the Intel chipset platform. Intel GPA consists of the System Analyzer, Frame Analyzer, and software development kit (SDK).</div><div id="Par47" class="Para">The Intel GPA System Analyzer 2014 R2 version supports Android platforms based on the Intel Atom processor. The features it offers include the following:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par48" class="Para">Real-time display of dozens of key indicators including CPU, GPU, and OpenGL ES API</div></li><li><div id="Par49" class="Para">Many graphics pipeline tests to isolate graphics bottlenecks</div></li><li><div id="Par50" class="Para">A host-development system that can use Microsoft Windows, Mac OS X, or Ubuntu OS</div></li></ul></div>
            </div><div id="Par51" class="Para">Intel GPA currently only supports real Android devices and does not support the analysis of emulators. It uses a typical hardware deployment model, also called , in which the host system (Windows and Ubuntu) and target device (Android Intel-based devices) are connected via USB to monitor Android applications. Intel GPA uses the Android Debug Bridge (adb) to monitor applications on target devices: the adb server runs on the Android device, and Intel GPA runs on the host system as the adb client application. This structure is shown in Figure <span class="InternalRef"><a href="#Fig2">11-2</a></span>.<div class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img src="A978-1-4842-0100-8_11_Fig2_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig2_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-2.</span><div class="SimplePara">Intel GPA configuration for monitoring applications on an Android device</div></div></div></div>
            </div><div id="Par52" class="Para">You should be cautious, given that Intel GPA requires adb to work. Both Eclipse and Dalvik Debug Monitor Server (DDMS) also use adb, so Intel GPA may not work properly if GPA, DDMS, and Eclipse are running at the same time, due to the adb conflict. It is best to turn off other Android software-development tools, such as Eclipse and DDMS, when using Intel GPA.</div><div id="Par53" class="Para">Figure <span class="InternalRef"><a href="#Fig3">11-3</a></span> shows the Intel GPA graphic interface monitoring an app running on an Android device. <div class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img src="A978-1-4842-0100-8_11_Fig3_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig3_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-3.</span><div class="SimplePara">The Intel GPA graphic interface monitoring an app running on an Android device</div></div></div></div>
            </div><div id="Par54" class="Para">As you can see, Intel GPA has two main windows and a toolbar pane. The tree structure in the left pane displays the indicators being monitored:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par55" class="Para">Under CPU are Aggregated CPU Load, CPU XX Load, CPU XX Frequency, and Target App CPU Load. CPU XX numbers are determined by how many CPUs are being monitored by Intel GPA. To get CPU information such as numbers of cores, model, and frequency, you can use the <span class="EmphasisFontCategoryNonProportional">cat /proc/cpuinfo</span> command in a terminal window. Figure <span class="InternalRef"><a href="#Fig3">11-3</a></span> is a screenshot for a Lenovo K800 smartphone, which uses a single-core Intel Atom Z2460 processor; it shows two logical processors, because s the processor supports Intel Hyper Threading Technology (Intel HTT). Thus two items are shown in CPU Load and CPU Frequency, indexed 00 and 01. In CPU XX Load, XX is the CPU number: it displays the load status for CPU XX, whereas CPU XX Frequency displays the frequency status for CPU XX. Aggregated CPU Load is the total load of the CPU. Target App CPU Load is the CPU load of the app on the target device.</div></li><li><div id="Par56" class="Para">Under Device IO are Disk Read, Disk Write, Network RX, and Network TX. These metrics list status and information for disk read, disk write, network packets sent, and network packets received over the network, respectively.</div></li><li><div id="Par57" class="Para">Under Memory are App Resident Memory and Available Memory.</div></li><li><div id="Par58" class="Para">Under Power are Current Charging and Current Discharging, which provide the status of charging and discharging.</div></li></ul></div>
            </div><div id="Par59" class="Para">In the right pane are two real-time status display windows by default. These real-time windows display an oscilloscope-like status for the specified indicators. The horizontal axis is the elapsed time, and the vertical axis is the value of the corresponding indicator. You can drag and drop an index entry from the left pane to one of two windows to display the real-time indicator of that entry. In Figure <span class="InternalRef"><a href="#Fig3">11-3</a></span>, CPU 00 Load has been dragged and dropped to the top display window, and the CPU 01 load is shown in the bottom display window; the vertical axis shows CPU utilization. The maximum is 100%. Above the real-time status display window are tools such as screen capture and pause display. You can use these tools to debug an application.</div></div><div id="Sec14" class="Section2 RenderAsSection2"><h3 class="Heading">Installing Intel GPA</h3><div id="Par60" class="Para">GPA for Windows is installed during Beacon Mountain installation (Mac OS X and Ubuntu OS host systems) or Intel INDE installation (Windows host system). For an Ubuntu host, go to the Intel web site (<span class="ExternalRef"><a href="http://intel.com/software/gpa"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://intel.com/software/gpa</span>
                </span></a></span> or <span class="ExternalRef"><a href="http://software.intel.com/en-us/vcsource/tools/intel-gpa"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://software.intel.com/en-us/vcsource/tools/intel-gpa</span>
                </span></a></span>) to download Intel GPA (this book uses version <span class="EmphasisFontCategoryNonProportional">gpa_12.5_release_187105_windows.exe</span> for the test), as shown in Figure <span class="InternalRef"><a href="#Fig4">11-4</a></span>.<div class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img src="A978-1-4842-0100-8_11_Fig4_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig4_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-4.</span><div class="SimplePara">Intel GPA software download site</div></div></div></div>
            </div></div><div id="Sec15" class="Section2 RenderAsSection2"><h3 class="Heading">Using Intel GPA on Android</h3><div id="Par61" class="Para">The following example demonstrates how to use Intel GPA to monitor applications on an Android device. In this case, the target machine is a Lenovo K800 smartphone running on an Intel Atom processor.</div><div id="Par62" class="Para">Special requirements must be met to allow Intel GPA to monitor and control applications on Android devices. Only if these set conditions are met can an application can be monitored by Intel GPA. You must follow these two steps: set the Eclipse application parameters and generate and deploy an application, and then use Intel GPA to monitor the application.</div><div id="Par63" class="Para">The name of the application used as an example here is . The operation interface is shown in Figure <span class="InternalRef"><a href="#Fig5">11-5(a)</a></span>.</div><div id="Par64" class="Para">The application is a simple game. The user interface is very basic: just a circle. When the user touches any point inside the circle and drags around, the black circle follows the touch point and moves. When the user stops touching the spot in the circle, the circle is still. The circle does not move when the user drags outside the circle (that is, the initial touch point within that circle). If the user presses the phone’s Back button, the Exit dialog box pops up. Clicking Exit exits the application, as shown in Figure <span class="InternalRef"><a href="#Fig5">11-5(b)</a></span>.<div class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img src="A978-1-4842-0100-8_11_Fig5_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig5_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-5.</span><div class="SimplePara">The <span class="EmphasisFontCategoryNonProportional">MoveCircle</span> application</div></div></div></div>
            </div><div id="Par65" class="Para">From the application interface description, the major computing tasks of the application are concentrated in dragging the circle, constantly calculating the circle’s new location, and refreshing (redrawing) the display. The application’s code framework application is similar to that in section “Dialog Box Example” of <span class="ExternalRef"><a href="A978-1-4842-0100-8_10_Chapter.html"><span class="RefSource">Chapter 10</span></a></span> on page 33, and thus the source code is skipped here.</div><div id="Par66" class="Para">Follow these steps to use Intel GPA to monitor the example application:<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par67" class="Para">Build and deploy the application in Eclipse.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par68" class="Para">Use general procedures to create an application project. Name the application <span class="EmphasisFontCategoryNonProportional">MoveCircle</span>:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">a.</span><div class="ItemContent"><div id="Par69" class="Para">Write the related code for the project. The document framework is shown in Figure <span class="InternalRef"><a href="#Fig6">11-6</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
                    </div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par70" class="Para">  <div class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img src="A978-1-4842-0100-8_11_Fig6_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig6_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-6.</span><div class="SimplePara">Document framework for the <span class="EmphasisFontCategoryNonProportional">MoveCircle</span> application</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">b.</span><div class="ItemContent"><div id="Par71" class="Para">Edit the <span class="EmphasisFontCategoryNonProportional">AndroidManifest.xml</span> file, and add the following code:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par73" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 1. &lt;manifest xmlns:android="</span>
              <span class="ExternalRef"><a href="http://schemas.android.com/apk/res/android"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://schemas.android.com/apk/res/android</span>
                </span></a></span>
              <span class="EmphasisFontCategoryNonProportional">"</span>
            </div><div id="Par74" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 2.     package="com.example.movecircle"</span>
            </div><div id="Par75" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 3.     android:versionCode="1"</span>
            </div><div id="Par76" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 4.     android:versionName="1.0" &gt;</span>
            </div><div id="Par77" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 5.</span>
            </div><div id="Par78" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 6.     &lt;uses-sdk</span>
            </div><div id="Par79" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 7.         android:minSdkVersion="8"</span>
            </div><div id="Par80" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 8.         android:targetSdkVersion="15" /&gt;</span>
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">9.     &lt;uses-permission android:name="android.permission.INTERNET"/&gt;</span></span>
              <span class="EmphasisFontCategoryNonProportional">10.</span>
            </div><div id="Par81" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11.     &lt;application</span>
            </div><div id="Par82" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12.         android:icon="@drawable/ic_launcher"</span>
            </div><div id="Par83" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">13.         android:debuggable="true"</span></span>
            </div><div id="Par84" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.         android:label="@string/app_name"</span>
            </div><div id="Par85" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.         android:theme="@style/AppTheme" &gt;</span>
            </div><div id="Par86" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.         &lt;activity</span>
            </div><div id="Par87" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.             android:name=".MainActivity"</span>
            </div><div id="Par88" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.             android:label="@string/title_activity_main" &gt;</span>
            </div><div id="Par89" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.             &lt;intent-filter&gt;</span>
            </div><div id="Par90" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.                 &lt;action</span>
            </div><div id="Par91" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.                 android:name="android.intent.action.MAIN" /&gt;</span>
            </div><div id="Par93" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.                 &lt;category android:name="android.intent.category.LAUNCHER" /&gt;</span>
              <span class="EmphasisFontCategoryNonProportional">23.             &lt;/intent-filter&gt;</span>
            </div><div id="Par94" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.         &lt;/activity&gt;</span>
            </div><div id="Par95" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.     &lt;/application&gt;</span>
            </div><div id="Par96" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.</span>
            </div><div id="Par97" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27. &lt;/manifest&gt;</span>
            </div><div id="Par99" class="Para">In line 9, you add a <span class="EmphasisFontCategoryNonProportional">uses-permission</span> elements, and  grant the application Internet write/read access. Line 13 specifies that the application is debuggable. <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">c.</span><div class="ItemContent"><div id="Par100" class="Para">Generate the application package, and deploy the application to the real target device.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par101" class="Para">Start Intel GPA on the host machine to monitor the application.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par102" class="Para">Connect the Android phone to the PC. Make sure the screen is not locked, or you may get the error “Unsuccessful Phone Connection”:</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">d.</span><div class="ItemContent"><div id="Par103" class="Para">Make sure you turn off all tools that use adb, such as Eclipse and DDMS. Otherwise, you may get the error “Unsuccessful Phone Connection.”</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">e.</span><div class="ItemContent"><div id="Par104" class="Para">(This step is optional.) Make sure adb is started and running:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par106" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">C:\Documents and Settings&gt;adb devices</span>
            </div><div id="Par107" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">List of devices attached</span>
            </div><div id="Par108" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">Medfield04749AFB        device</span>
            </div><div class="Para">
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">f.</span><div class="ItemContent"><div id="Par110" class="Para">In Windows, select Start ➤ Program ➤ Intel Graphics Performance Analyzers 2012 RS ➤ Intel GPA System Analyzer to start Intel GPA.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">g.</span><div class="ItemContent"><div id="Par111" class="Para">The Intel GPA initial window pops up, suggesting the machine to be monitored, as shown in Figure <span class="InternalRef"><a href="#Fig7">11-7</a></span>. Because the tuning target is a phone in this case, you select the phone (in this case, Medfield04749AFB) by clicking the Connect button.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par112" class="Para">  <div class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img src="A978-1-4842-0100-8_11_Fig7_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig7_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-7.</span><div class="SimplePara">Intel GPA interface for connecting to a monitored device</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">h.</span><div class="ItemContent"><div id="Par113" class="Para">Once connected, Intel GPA does an initial analysis of applications installed on the monitored smartphone, dividing apps into two groups: analyzable application and non-analyzable applications, as shown in Figure <span class="InternalRef"><a href="#Fig8">11-8</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par114" class="Para">  <div class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img src="A978-1-4842-0100-8_11_Fig8_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig8_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-8.</span><div class="SimplePara">Initial interface (apps list) after Intel GPA is connected to the monitored phone</div></div></div></div>
            </div><div id="Par115" class="Para">In the Analyzable Applications list is the example  application. If an application cannot be analyzed by Intel GPA, it is usually because the application’s parameters are not set, as described earlier in this section, or because the device is not rooted. As a good exercise, you can skip step 2b, which modifies <span class="EmphasisFontCategoryNonProportional">AndroidManifest.xml</span>; that will cause the application to disappear from the Analyzable Applications list and appear on the list of non-analyzable applications.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">i.</span><div class="ItemContent"><div id="Par116" class="Para">In the Analyzable Applications list, click the name of the application you want Intel GPA to monitor (in this case, <span class="EmphasisFontCategoryNonProportional">MoveCircle</span>). A rolling circle showing ongoing progress appears next to the app. See Figure <span class="InternalRef"><a href="#Fig9">11-9</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par117" class="Para">  <div class="Figure" id="Fig9"><div class="MediaObject" id="MO9"><img src="A978-1-4842-0100-8_11_Fig9_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig9_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-9.</span><div class="SimplePara">App initialization interface in Intel GPA</div></div></div></div>
            </div><div id="Par118" class="Para">At the same time, the application startup screen is displayed on the phone. The screen prompts you with the message Waiting For Debugger, as shown in Figure <span class="InternalRef"><a href="#Fig10">11-10</a></span>. Note that you should not click the Force Close button: wait until the message box automatically closes in the interface.<div class="Figure" id="Fig10"><div class="MediaObject" id="MO10"><img src="A978-1-4842-0100-8_11_Fig10_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig10_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-10.</span><div class="SimplePara">Initial screen on the target phone when Intel GPA starts the application to be monitored</div></div></div></div>
            </div><div id="Par119" class="Para">  
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">j.</span><div class="ItemContent"><div id="Par120" class="Para">The Intel GPA monitoring interface appears, as shown in Figure <span class="InternalRef"><a href="#Fig11">11-11</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par121" class="Para">  <div class="Figure" id="Fig11"><div class="MediaObject" id="MO11"><img src="A978-1-4842-0100-8_11_Fig11_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig11_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-11.</span><div class="SimplePara">Initial Intel GPA Monitoring interface when the application is started</div></div></div></div>
            </div><div id="Par122" class="Para">At the same time, the <span class="EmphasisFontCategoryNonProportional">MoveCircle</span> app starts to run on the phone, as shown in Figure <span class="InternalRef"><a href="#Fig12">11-12</a></span>.<div class="Figure" id="Fig12"><div class="MediaObject" id="MO12"><img src="A978-1-4842-0100-8_11_Fig12_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig12_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-12.</span><div class="SimplePara">The <span class="EmphasisFontCategoryNonProportional">MoveCircle</span> app running on the target phone</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">k.</span><div class="ItemContent"><div id="Par123" class="Para">Drag and drop CPU 00 Load to the top real-time status display panel in the display window, and drag and drop CPU 01 Load to the bottom real-time status display panel. Start to interact with <span class="EmphasisFontCategoryNonProportional">MoveCircle</span>: use your finger to click and drag the circle for a few seconds, and then stop the interaction for a few seconds. The corresponding Intel GPA monitor screen is shown in Figure <span class="InternalRef"><a href="#Fig13">11-13</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par124" class="Para">  <div class="Figure" id="Fig13"><div class="MediaObject" id="MO13"><img src="A978-1-4842-0100-8_11_Fig13_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig13_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-13.</span><div class="SimplePara">Intel GPA monitoring the <span class="EmphasisFontCategoryNonProportional">MoveCircle</span> app and displaying CPU loads in real time</div></div></div></div>
            </div><div id="Par125" class="Para">In Figure <span class="InternalRef"><a href="#Fig13">11-13</a></span>, you can see a rule: when you drag the circle, both CPU loads rise to a certain height; when you do not interact with the app, the two CPU loads immediately drop to near 0%. The application’s main computing tasks are concentrated in the circle drag and move, with no or low computing (low or no CPU loads) when the circle is not moved.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">l.</span><div class="ItemContent"><div id="Par126" class="Para">To end the Intel GPA analysis, exit the app as shown in Figure <span class="InternalRef"><a href="#Fig5">11-5(b)</a></span>. Intel GPA returns to the starting interface shown in Figure <span class="InternalRef"><a href="#Fig9">11-9</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par127" class="Para">This example only demonstrates monitoring the load on the CPU. Intel GPA is more useful when you analyze an application that is doing OpenGL rendering; the screenshots here don’t show all the GPU and OpenGL metrics. If you are interested, you can try other examples and monitor other metrics. For example, for <span class="EmphasisFontCategoryNonProportional">MoveCircle</span>, we chose the Disk Read metric for the top display window and Disk Write for the bottom. After switching apps to review some photo files and returning to <span class="EmphasisFontCategoryNonProportional">MoveCircle</span>, the action was instantly apparent (see Figure <span class="InternalRef"><a href="#Fig14">11-14</a></span>).<div class="Figure" id="Fig14"><div class="MediaObject" id="MO14"><img src="A978-1-4842-0100-8_11_Fig14_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig14_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-14.</span><div class="SimplePara">Intel GPA monitoring Disk Read and Disk Write for <span class="EmphasisFontCategoryNonProportional">MoveCircle</span> and other apps</div></div></div></div>
            </div></div></div><div id="Sec16" class="Section1 RenderAsSection1"><h2 class="Heading">Android Multithreaded Design</h2><div id="Par128" class="Para">The Intel Atom processor supports hyperthreading and multi-core configurations. A multithreaded design is a good way to increase the degree of parallelism and improve performance. Intel Atom N-series processors support the parallel execution of multiple threads. Most Intel Atom processors are dual core with HT, and the latest Bay Trail processor has dual core or quad core and physically supports a certain degree of parallel execution.</div><div id="Par129" class="Para">Note that the word used here is <span class="EmphasisTypeItalic">parallel</span> rather than <span class="EmphasisTypeItalic">concurrent</span>. For some tasks, you can follow the classic divide-and-conquer methodology and divide them into two or more basic units. You assign those units to different threads to be executed at the same time. In this way, the performance potential of the processor is fully utilized, and you speed up the software execution. As a result, the software runs faster and more efficiently.</div><div id="Par130" class="Para">Based on the Java multithreaded programming interface, Android provides a more powerful multithreaded programming interface. With the aid of this programming interface, you can easily implement multithreaded development and design at the Java language level without needing to use the cumbersome underlying OS call interface.</div><div id="Sec17" class="Section2 RenderAsSection2"><h3 class="Heading">Android Framework of a Thread</h3><div id="Par131" class="Para">The Android threaded programming framework is based on Java. There are two approaches to multithreaded programming in Java: inheriting from the <span class="EmphasisFontCategoryNonProportional">Thread</span> class and overriding the <span class="EmphasisFontCategoryNonProportional">run</span> method; and using the <span class="EmphasisFontCategoryNonProportional">Runnable</span> interface and the <span class="EmphasisFontCategoryNonProportional">run</span> method.</div><div id="Sec18" class="Section3 RenderAsSection3"><h4 class="Heading">Java Thread Programming Interface</h4><div id="Par132" class="Para">The general code framework for the first method, inheriting from the <span class="EmphasisFontCategoryNonProportional">Thread</span> class, is as follows:<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par133" class="Para">Define the <span class="EmphasisFontCategoryNonProportional">Thread</span> class (in this case, <span class="EmphasisFontCategoryNonProportional">MyThread</span>) and its code:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par135" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">class MyThread extends Thread  // Thread inheritance, custom thread</span>
              </div><div id="Par136" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par137" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">public MyThread()          // Define a constructor</span>
              </div><div id="Par138" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par139" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">super();               // Call the parent class builder to create objects</span>
              </div><div id="Par140" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par141" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">@Override</span>
              </div><div id="Par142" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">public void run()          // To write run code in the run method of the thread body</span>
              </div><div id="Par143" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par144" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">......                 // The real Run Code of the thread.</span>
              </div><div id="Par145" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par146" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div class="Para">
                <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par148" class="Para">Start the thread code:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par150" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">MyThread myThread = new MyThread();    // create a new thread</span>
              </div><div id="Par151" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">myThread.start();                      // start a thread</span>
              </div><div class="Para">
                <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par153" class="Para">Wait for the running thread to end:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par155" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">try {</span>
              </div><div id="Par156" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">myThread.join();                  // Wait for thread process                                          to end</span>
              </div><div id="Par157" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">} catch (InterruptedException e) {</span>
              </div><div id="Par159" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par161" class="Para">The second method uses the <span class="EmphasisFontCategoryNonProportional">Runnable</span> interface implementation. Here is the general code framework:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par162" class="Para">Write a custom <span class="EmphasisFontCategoryNonProportional">Runnable</span> interface implementation class:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par164" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">class MyRunnableThread implements Runnable  // implement runnable interface</span>
              </div><div id="Par165" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par166" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">public void run()</span>
              </div><div id="Par167" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par168" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">......        // actual implementation codes of the thread</span>
              </div><div id="Par169" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par170" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div class="Para">
                <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par172" class="Para">Start a thread:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par174" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">MyRunnableThread target = new MyRunnableThread();     // create custom runnable interface implementation object//</span>
              </div><div id="Par175" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">Thread myThread = new Thread(target); // create a Thread class object</span>
              </div><div id="Par176" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">myThread.start();                    // Start Thread</span>
              </div><div id="Par178" class="Para">These two methods have the same effects but are used on different occasions. If you are familiar with Java, you know that Java does not have multiple inheritance in C++; it implements interfaces instead. To separately implement a thread, you can use the first method, thread inheritance.</div><div id="Par179" class="Para">But some classes are inherited from another class. In such cases, if you want the thread to run, you have to use the second method (<span class="EmphasisFontCategoryNonProportional">Runnable</span> interface). In this case, you can declare that the class implements the <span class="EmphasisFontCategoryNonProportional">Runnable</span> interface and then put the code to be run as a thread into the <span class="EmphasisFontCategoryNonProportional">run</span> function. This way, it does not affect its previous inheritance hierarchy and can also run as a thread.</div><div id="Par180" class="Para">Note the following about Java’s threading framework:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par181" class="Para">In the Java runtime, the system implements a thread scheduler, which determines the time at which a thread is running on the CPU.</div></li><li><div id="Par182" class="Para">In Java technology, the thread is usually preemptive, without the need for a time-slice allocation process (assigning each thread process equal CPU time). In the preemptive scheduling model, all threads are in a ready-to-run state (waiting state), but only one thread is running. The thread continues to run until it terminates or returns to a runnable (wait) state or another, higher-priority thread becomes runnable. In the latter case, the low-priority thread terminates to give the right to run to the high-priority thread.</div></li><li><div id="Par183" class="Para">The Java thread scheduler supports the preemptive approach for threads with different priorities, but it does not support time-slice rotation of threads with the same priority.</div></li><li><div id="Par184" class="Para">If the operating system where the Java runtime is running supports the rotation of the time slice, then the Java thread scheduler supports time-slice rotation of threads with the same priority.</div></li><li><div id="Par185" class="Para">Do not overly rely on the system’s thread scheduler. For example, the low-priority thread must also get a chance to run.</div></li></ul></div>
              </div><div id="Par186" class="Para">For more detailed information about Java multithreaded programming methods, you can refer to related Java programming books, including <span class="EmphasisTypeItalic">Learn Java for Android</span> (<span class="ExternalRef"><a href="http://www.apress.com/9781430264545"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">www.apress.com/9781430264545</span>
                  </span></a></span>), <span class="EmphasisTypeItalic">Pro Android Apps Performance Optimization</span> (<span class="ExternalRef"><a href="http://www.apress.com/9781430239994"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">www.apress.com/9781430239994</span>
                  </span></a></span>), and <span class="EmphasisTypeItalic">Android Recipes</span> (<span class="ExternalRef"><a href="http://www.apress.com/9781430246145"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">www.apress.com/9781430246145</span>
                  </span></a></span>).</div></div><div id="Sec19" class="Section3 RenderAsSection3"><h4 class="Heading">Android Threaded Programming Extensions and Support</h4><div id="Par187" class="Para">When Android is running, the system (DVM) supports concurrent multiple CPUs. That being said, if the machine has more than one logical processor, the DVM follows certain strategies to automatically assign different threads to run on different CPUs. In this way, Android can physically run different threads in parallel. In addition to the thread-programming interfaces provided by Java, Android also provides important extensions and support. The first is the .</div><div id="Par188" class="Para">Android’s interface, including a variety of activities, runs in the main thread of the application (also known as the <span class="EmphasisTypeItalic">UI thread</span>, the <span class="EmphasisTypeItalic">interface thread</span>, or the <span class="EmphasisTypeItalic">default thread</span>). The application by default has only one thread, which is the main thread. Thus the application is considered to be single-threaded. Some time-consuming tasks (computing), if run on the main thread by default, cause the main interface to fail to respond for a long time. To prevent this, those time-consuming tasks should be allocated to the independent thread to execute.</div><div id="Par189" class="Para">The independent thread running behind the scenes (also known as the <span class="EmphasisTypeItalic">assistive thread</span> or <span class="EmphasisTypeItalic">background thread</span>) often needs to communicate with the interface of the main thread, such as updating the display. If the behind-the-scenes thread calls a function of an interface object to update the interface, Android gives the execution error message <span class="EmphasisFontCategoryNonProportional">CalledFromWrongThreadException</span>.</div><div id="Par190" class="Para">For example, in an application (in this case <span class="EmphasisFontCategoryNonProportional">GuiExam</span>), if a worker thread directly calls the <span class="EmphasisFontCategoryNonProportional">setText</span> function of the <span class="EmphasisFontCategoryNonProportional">TextView</span> object in the interface to update the display, the system immediately encounters an error and terminates the running application, as shown in Figure <span class="InternalRef"><a href="#Fig15">11-15</a></span>.<div class="Figure" id="Fig15"><div class="MediaObject" id="MO15"><img src="A978-1-4842-0100-8_11_Fig15_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig15_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-15.</span><div class="SimplePara">Running error when a worker thread directly calls a function of the UI object</div></div></div></div>
              </div><div id="Par191" class="Para">In order to let the worker thread and the main thread interface communicate, you need to understand the looper-message mechanism. Android has a <span class="EmphasisTypeItalic">message queue</span> that can combine threads, processing handler and looper components to exchange information.</div><div id="Sec20" class="Section4 RenderAsSection4"><h5 class="Heading">Message</h5><div id="Par192" class="Para">A is the information exchanged between threads. When a thread behind the scenes needs to update the interface, it sends a message containing the data to the UI thread (the main thread).</div></div><div id="Sec21" class="Section4 RenderAsSection4"><h5 class="Heading">Handler</h5><div id="Par193" class="Para">The is the main processor of the message and is responsible for sending the message and executing and processing the message content. The behind-the-scenes thread, using the processing object passed in, calls the <span class="EmphasisFontCategoryNonProportional">sendMessage(Message)</span> function to send a message. To use a handler, you need a method to implement the class <span class="EmphasisFontCategoryNonProportional">handleMessage(Message)</span>, which is responsible for handling the message operation content (such as updating the interface). The <span class="EmphasisFontCategoryNonProportional">handleMessage</span> method usually requires subclassing.</div><div id="Par194" class="Para">The handler is not used to open a new thread. It is more like the secretary of the main thread, responsible for managing the updated data from the sub thread and then updating the interface in the main thread. The behind-the-scenes thread processes the <span class="EmphasisFontCategoryNonProportional">sendMessage()</span> method to send a message, and the handler calls back (automatically invoked) processing in the <span class="EmphasisFontCategoryNonProportional">HandlerMessage</span> method to process the message.</div></div><div id="Sec22" class="Section4 RenderAsSection4"><h5 class="Heading">Message Queue</h5><div id="Par195" class="Para">The is used to store the messages sent by the handler, based on the first-in, first-out rule for execution. For each message queue, there is a corresponding handler. The handler uses two methods to send messages to the message queue: <span class="EmphasisFontCategoryNonProportional">SendMessage</span> and <span class="EmphasisFontCategoryNonProportional">post</span>. Messages sent by these two methods are executed in slightly different waya: a message sent by <span class="EmphasisFontCategoryNonProportional">SendMessage</span> is a message queue object and is processed by the <span class="EmphasisFontCategoryNonProportional">HandlerMessage</span> function of the handler; a message sent through the <span class="EmphasisFontCategoryNonProportional">post</span> method is a runnable object and is implemented automatically.</div><div id="Par196" class="Para">Android has no global message queue. It automatically builds a message queue for the main thread (one of the UI threads), but the message queue is not established in the sub thread; so <span class="EmphasisFontCategoryNonProportional">Looper.getMainLooper()</span> must be called to get the looper of the main thread. The main thread loop does not go to <span class="EmphasisFontCategoryNonProportional">NULL</span>; but to call <span class="EmphasisFontCategoryNonProportional">Looper.myLooper()</span> to get the looper of the current thread loop</div></div><div id="Sec23" class="Section4 RenderAsSection4"><h5 class="Heading">Looper</h5><div id="Par197" class="Para">The looper is the housekeeper for each thread’s message queue. It is a bridge between the handler and message queues. Program components first pass the message to the looper through the handler, and then the looper puts the message in the queue.</div><div id="Par198" class="Para">For the main thread of the application’s default UI, the system establishes the message queue and looper: there is no need to write the message queue and looper operation code in the source code, and both are transparent to the default main thread. However, the handler is not transparent to the default main thread. In order to send a message to the main thread and handle the message, you must establish your own handler object.</div><div id="Par199" class="Para">In addition to using the looper-message mechanism to achieve communication between the worker thread and the main GUI thread, you can also use a technique called <span class="EmphasisTypeItalic">asynchronous-tasks (AsyncTask)</span> mechanism to implement the communication between those threads. The general use of the AsyncTask framework is as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par200" class="Para">AsyncTask.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par201" class="Para">Implement AsyncTask defined by the following one or several methods:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par202" class="Para">
                                <span class="EmphasisFontCategoryNonProportional">onPreExecute()</span>: Begin preparatory work before execution of the task <span class="EmphasisFontCategoryNonProportional">doInBackground(Params...)</span>: Start background execution. You can call the <span class="EmphasisFontCategoryNonProportional">publishProgress</span> function to update real-time task progress.</div></li><li><div id="Par203" class="Para">
                                <span class="EmphasisFontCategoryNonProportional">onProgressUpdate(Progress...)</span>: After the <span class="EmphasisFontCategoryNonProportional">publishProgress</span> function is called, the UI thread calls this function to show the progress of the task interface—for example, displaying a progress bar.</div></li><li><div id="Par204" class="Para">
                                <span class="EmphasisFontCategoryNonProportional">onPostExecute(Result)</span>: After the operation is complete, send the results to the UI thread.</div></li></ul></div>
                        </div></div><div class="ClearBoth"> </div></div></div>
                </div><div id="Par205" class="Para">None of these functions can be called manually. In addition to the <span class="EmphasisFontCategoryNonProportional">doInBackground(Params...)</span>function, the remaining three are UI thread called, so requirements are:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par206" class="Para">The <span class="EmphasisFontCategoryNonProportional">AsyncTask</span> instance must be created in the UI thread;</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par207" class="Para">The <span class="EmphasisFontCategoryNonProportional">AsyncTask.execute</span> function must be called in the UI thread.</div></div><div class="ClearBoth"> </div></div></div>
                </div><div id="Par208" class="Para">Keep in mind that the task can be executed only once. Multiple calls are abnormal. You can find a detailed AsyncTask example in the Android help documentation.</div></div></div><div id="Sec24" class="Section3 RenderAsSection3"><h4 class="Heading">Thread Example</h4><div id="Par209" class="Para">This section uses an example to illustrate Android-threaded programming. The running <span class="EmphasisFontCategoryNonProportional">GuiExam</span> application is shown in Figure <span class="InternalRef"><a href="#Fig16">11-16</a></span>.<div class="Figure" id="Fig16"><div class="MediaObject" id="MO16"><img src="A978-1-4842-0100-8_11_Fig16_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig16_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-16.</span><div class="SimplePara">Demo UI of a multithreaded code framework</div></div></div></div>
              </div><div id="Par210" class="Para">As shown in Figure <span class="InternalRef"><a href="#Fig16">11-16</a></span>, the demo app has three main activities buttons: Start Thread Run, Stop Thread Run, and Exit App. The first two control the operation of the auxiliary thread. Click the Start Thread Run button, and the thread starts running, as shown in Figure <span class="InternalRef"><a href="#Fig16">11-16(b)</a></span>. Click Stop Thread Run to end the thread run, as shown in Figure <span class="InternalRef"><a href="#Fig16">11-16(c)</a></span>. The worker thread refreshes the text display in the <span class="EmphasisFontCategoryNonProportional">TextView</span> every half a section, displaying Complete Step. X in increments from 0 to X. Click Exit App to close the activities and exit the application.</div><div id="Par211" class="Para">The structure of the demo app and the procedures are as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par212" class="Para">Edit the main activity file (<span class="EmphasisFontCategoryNonProportional">activity_main.xml</span>), delete the <span class="EmphasisFontCategoryNonProportional">originalTextView</span> window component, and then add three buttons and two <span class="EmphasisFontCategoryNonProportional">TextView</span> window components. The buttons’ <span class="EmphasisFontCategoryNonProportional">ID</span> properties are, respectively, <span class="EmphasisFontCategoryNonProportional">@+id/startTaskThread</span>, <span class="EmphasisFontCategoryNonProportional">@+id/stopTaskThread</span>, and <span class="EmphasisFontCategoryNonProportional">@+id/exitApp</span>. The <span class="EmphasisFontCategoryNonProportional">Text</span> property is, respectively, Start Thread Run, Stop Thread Run, and Exit App. The <span class="EmphasisFontCategoryNonProportional">TextView</span>’s ID property is <span class="EmphasisFontCategoryNonProportional">@+id/taskThreadOuputInfo</span> to display the text output of the worker thread. The entire process is shown in Figure <span class="InternalRef"><a href="#Fig17">11-17</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
                <div class="Figure" id="Fig17"><div class="MediaObject" id="MO17"><img src="A978-1-4842-0100-8_11_Fig17_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig17_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-17.</span><div class="SimplePara">Multithreaded code framework in <span class="EmphasisFontCategoryNonProportional">activity_main.xml</span>
                      </div></div></div></div>
                <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par213" class="Para">Edit <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span> for the <span class="EmphasisFontCategoryNonProportional">activity_main</span> class as follows:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par215" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">1.  package com.example.guiexam;</span>
              </div><div id="Par216" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">2.  import android.os.Bundle;</span>
              </div><div id="Par217" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">3.  import android.app.Activity;</span>
              </div><div id="Par218" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">4.  import android.view.Menu;</span>
              </div><div id="Par219" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">5.  import android.widget.Button;</span>
              </div><div id="Par220" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">6.  import android.view.View;</span>
              </div><div id="Par221" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">7.  import android.view.View.OnClickListener;</span>
              </div><div id="Par222" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">8.  import android.os.Process;</span>
              </div><div id="Par223" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">9.  import android.widget.TextView;</span>
              </div><div id="Par224" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">10. import android.os.Handler;</span></span>
              </div><div id="Par225" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">11. import android.os.Message;</span></span>
              </div><div id="Par227" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">12. public class MainActivity extends Activity {</span>
              </div><div id="Par228" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">13.     private Button btn_StartTaskThread;</span>
              </div><div id="Par229" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">14.     private Button btn_StopTaskThread;</span>
              </div><div id="Par230" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">15.     private Button btn_ExitApp;</span>
              </div><div id="Par231" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">16.     private TextView threadOutputInfo;</span>
              </div><div id="Par232" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">17.     private MyTaskThread myThread = null;</span></span>
              </div><div id="Par233" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">18.     private Handler mHandler;;</span></span>
              </div><div id="Par235" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">19.     @Override</span>
              </div><div id="Par236" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">20.     public void onCreate(Bundle savedInstanceState) {</span>
              </div><div id="Par237" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">21.         super.onCreate(savedInstanceState);</span>
              </div><div id="Par238" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">22.         setContentView(R.layout.activity_main);</span>
              </div><div id="Par239" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">23.         threadOutputInfo = (TextView)findViewById(R.id.taskThreadOuputInfo);</span>
              </div><div id="Par240" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">24.         threadOutputInfo.setText("Thread Not Run");</span>
              </div><div id="Par242" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">25.         mHandler = new Handler() {</span></span>
              </div><div id="Par243" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">26.             public void handleMessage(Message msg) {</span></span>
              </div><div id="Par244" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">27.                switch (msg.what)</span></span>
              </div><div id="Par245" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">28.                 {</span></span>
              </div><div id="Par246" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">29.                 case MyTaskThread.MSG_REFRESHINFO:</span></span>
              </div><div id="Par247" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">30.                     threadOutputInfo.setText((String)(msg.obj));</span></span>
              </div><div id="Par248" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">31.                     break;</span></span>
              </div><div id="Par249" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">32.                 default:</span></span>
              </div><div id="Par250" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">33.                     break;</span></span>
              </div><div id="Par251" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">34.                 }</span></span>
              </div><div id="Par252" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">35.             }</span></span>
              </div><div id="Par253" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">36.         };</span></span>
              </div><div id="Par255" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">37.         btn_ExitApp = (Button) findViewById(R.id.exitApp); // Code for &lt;Exit App&gt;Button</span>
              </div><div id="Par256" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">38.         btn_ExitApp.setOnClickListener(new /*View.*/OnClickListener(){</span>
              </div><div id="Par257" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">39.             public void onClick(View v) {</span>
              </div><div id="Par258" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">40.                 finish();</span>
              </div><div id="Par259" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">41.                 Process.killProcess(Process.myPid());</span>
              </div><div id="Par260" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">42.             }</span>
              </div><div id="Par261" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">43.         });</span>
              </div><div id="Par263" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">44.         btn_StartTaskThread = (Button) findViewById(R.id.startTaskThread);</span>
              </div><div id="Par264" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">45.         // Code for&lt;Start Thread Run&gt;</span>
              </div><div id="Par265" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">46.         btn_StartTaskThread.setOnClickListener(new /*View.*/OnClickListener(){</span>
              </div><div id="Par266" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">47.             public void onClick(View v) {</span>
              </div><div id="Par267" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">48.                 myThread = new MyTaskThread(mHandler);  // Create a thread</span></span>
              </div><div id="Par268" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">49.                 myThread.start();    // Start Thread</span></span>
              </div><div id="Par269" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">50.                 setButtonAvailable();</span></span>
              </div><div id="Par270" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">51.              }</span>
              </div><div id="Par271" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">52.         });</span>
              </div><div id="Par273" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">53.         btn_StopTaskThread = (Button) findViewById(R.id.stopTaskThread);</span>
              </div><div id="Par274" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">54.         //code for &lt;Stop Thread Run&gt;</span>
              </div><div id="Par275" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">55.         btn_StopTaskThread.setOnClickListener(new /*View.*/OnClickListener(){</span>
              </div><div id="Par276" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">56.   public void onClick(View v) {</span>
              </div><div id="Par277" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">57.      if (myThread!=null</span></span>
                <span class="EmphasisFontCategoryNonProportional">&amp;&amp;</span>
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">myThread.isAlive())</span></span>
              </div><div id="Par278" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">58.                     myThread.stopRun();</span></span>
              </div><div id="Par279" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">59.                 try {</span></span>
              </div><div id="Par280" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">60.                     if (myThread!=null){</span></span>
              </div><div id="Par281" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">61.                         myThread.join();</span></span>
              </div><div id="Par282" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">62.                         // Wait for Thread Run to end</span></span>
              </div><div id="Par283" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">63.                         myThread =null;</span></span>
              </div><div id="Par284" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">64.                     }</span></span>
              </div><div id="Par285" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">65.                 } catch (InterruptedException e) {</span></span>
              </div><div id="Par286" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">66.                     // Empty statement block, ignored forcibly abort exception</span></span>
              </div><div id="Par287" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">67.                 }</span></span>
              </div><div id="Par288" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">68.                 setButtonAvailable();</span></span>
              </div><div id="Par289" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">69.              }</span>
              </div><div id="Par290" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">70.         });</span>
              </div><div id="Par291" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">71.         setButtonAvailable();</span></span>
              </div><div id="Par292" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">72.     }</span>
              </div><div id="Par294" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">73.     @Override</span>
              </div><div id="Par295" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">74.     public boolean onCreateOptionsMenu(Menu menu) {</span>
              </div><div id="Par296" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">75.         getMenuInflater().inflate(R.menu.activity_main, menu);</span>
              </div><div id="Par297" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">76.         return true;</span>
              </div><div id="Par298" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">77.     }</span>
              </div><div id="Par300" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">78.     private void setButtonAvailable()    // New function is used to set the button optional</span></span>
              </div><div id="Par301" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">79.     {</span></span>
              </div><div id="Par302" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">80.         btn_StartTaskThread.setEnabled(myThread==null);</span></span>
              </div><div id="Par303" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">81.         btn_ExitApp.setEnabled(myThread==null);</span></span>
              </div><div id="Par304" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">82.         btn_StopTaskThread.setEnabled(myThread!=null);</span></span>
              </div><div id="Par305" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">83.     }</span></span>
              </div><div id="Par306" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">84. }</span>
              </div><div id="Par308" class="Para">Lines 17 and 18 define the variable of the defined thread class <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span>, and the default main thread handler object <span class="EmphasisFontCategoryNonProportional">mHandler</span>, respectively. Lines 25–36 define the class. The <span class="EmphasisFontCategoryNonProportional">What</span> attribute field of the message class indicates the type of message. The custom handler class uses a <span class="EmphasisFontCategoryNonProportional">switch</span>-<span class="EmphasisFontCategoryNonProportional">case</span> statement for different handlers depending on the type of message; <span class="EmphasisFontCategoryNonProportional">MSG_REFRESHINFO</span> is the message type of the custom thread class <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span>, which means the worker thread requires an updated interface display message. Lines 29–31 process the message. The code is very simple; it updates the <span class="EmphasisFontCategoryNonProportional">TextView</span> widget display based on the message in the parameter object.</div><div id="Par309" class="Para">Lines 47–49 are the response code when the Start Thread Run button is clicked. It first creates the custom thread object and then calls the <span class="EmphasisFontCategoryNonProportional">Thread.start</span> function to make the self-defined thread class <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> run, which runs the execution code in the <span class="EmphasisFontCategoryNonProportional">run</span> function as a single thread. Finally, line 49 calls the custom function to set each button’s option (grayed and not selectable, or white and selectable).</div><div id="Par310" class="Para">Lines 55–65 are response code for the Stop Thread Run button. Line 55 first determines whether the thread already exists or is running. Then it stops a thread run in line 56 by calling the defined prototype function from the custom thread class <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> and then calling the <span class="EmphasisFontCategoryNonProportional">Thread.join()</span>; it then waits for the thread run to end. Finally, it sets the optional status of the interface buttons.</div><div id="Par311" class="Para">Lines 75–80 are a custom function that which is used to determine the optional status of each button: white and selectable or gray and selectable.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par312" class="Para">Create a new class <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> in the application. This class inherits from <span class="EmphasisFontCategoryNonProportional">Thread</span> and is used to implement the worker thread. The source code file <span class="EmphasisFontCategoryNonProportional">MyTaskThread.java</span> of this class is as follows:</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par314" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional"> 1. package com.example.guiexam;</span>
              </div><div id="Par315" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">2. import android.os.Handler;</span></span>
              </div><div id="Par316" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">3. import android.os.Message;</span></span>
              </div><div id="Par317" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional"> 4.</span>
              </div><div id="Par318" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional"> 5. public class MyTaskThread</span>
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">extends Thread {</span></span>
              </div><div id="Par319" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">6.     private static final int stepTime = 500;</span></span>
              </div><div id="Par320" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">7. // Execution timeof each step(unite:ms)</span></span>
              </div><div id="Par321" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">8.     private volatile boolean isEnded;</span></span>
              </div><div id="Par322" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">9. // mark if the thread is running. Used to stop thread run</span></span>
              </div><div id="Par323" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">10.      private Handler mainHandler;</span></span>
              </div><div id="Par324" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">11. // Handler used to send message</span></span>
              </div><div id="Par325" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">12.     public static final int MSG_REFRESHINFO = 1;  // Update message on interface</span></span>
              </div><div id="Par326" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">13.</span>
              </div><div id="Par327" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">14.     public MyTaskThread(Handler mh)   // Define a constructor</span></span>
              </div><div id="Par328" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">15.     {</span></span>
              </div><div id="Par329" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">16.         super();   // Call the parent class builder to create objects</span></span>
              </div><div id="Par330" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">17.         isEnded = false;</span></span>
              </div><div id="Par331" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">18.         mainHandler = mh;</span></span>
              </div><div id="Par332" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">19.     }</span></span>
              </div><div id="Par333" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">20.</span>
              </div><div id="Par334" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">21.     @Override</span></span>
              </div><div id="Par335" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">22.     public void run()  // Write run code in thread body run method</span></span>
              </div><div id="Par336" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">23.     {</span></span>
              </div><div id="Par337" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">24.         Message msg ;</span></span>
              </div><div id="Par338" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">25.         for (int i = 0; !isEnded; i++)</span></span>
              </div><div id="Par339" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">26.         {</span></span>
              </div><div id="Par340" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">27.             try {</span></span>
              </div><div id="Par341" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">28.                 Thread.sleep(stepTime);  // designate time for every  step of the thread to sleep</span></span>
              </div><div id="Par342" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">29.                 String s = "Complete" + i +"step";</span></span>
              </div><div id="Par343" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">30.                 msg = new Message();</span></span>
              </div><div id="Par344" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">31.                 msg.what = MSG_REFRESHINFO;  // Define message type</span></span>
              </div><div id="Par345" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">32.                 msg.obj = s;   // attach data to message</span></span>
              </div><div id="Par346" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">33.                 mainHandler.sendMessage(msg);  // send message</span></span>
              </div><div id="Par347" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">34.             } catch (InterruptedException e) {</span></span>
              </div><div id="Par348" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">35.                 e.printStackTrace();</span></span>
              </div><div id="Par349" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">36.             }</span></span>
              </div><div id="Par350" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">37.         }</span></span>
              </div><div id="Par351" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">38.     }</span></span>
              </div><div id="Par352" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">39.</span>
              </div><div id="Par353" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">40.     public void stopRun()  // Stop control function for stop thread run</span></span>
              </div><div id="Par354" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">41.     {</span></span>
              </div><div id="Par355" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">42.         isEnded = true;</span></span>
              </div><div id="Par356" class="Para ParaTypeProgramcode">
                <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">43.     }</span></span>
              </div><div id="Par357" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">42. }</span>
              </div><div id="Par359" class="Para">This document is the implementation code of the custom thread class , which is the key to this application. The application is using the first approach, thread inheritance, to achieve threading. In line 5, the custom class inherits from <span class="EmphasisFontCategoryNonProportional">Thread</span>; and then, from line 14–39, the threads run code on the rewritten <span class="EmphasisFontCategoryNonProportional">run</span> function. To cope with the work of the thread, lines 6–9 define the relevant variables. The constant <span class="EmphasisFontCategoryNonProportional">stepTime</span> represents the length of every step of the thread-delay time, measured in milliseconds. <span class="EmphasisFontCategoryNonProportional">isEnded</span> controls whether to continue each step in the body of the loop in the <span class="EmphasisFontCategoryNonProportional">run</span> function. Note that the variable is preceded by the <span class="EmphasisFontCategoryNonProportional">volatile</span> modifier: Each time a thread accesses the variable, it reads the final value in memory after the variable has been modified. A write request must be written to memory, too. This avoids the copy in cache or register not matching the value in the memory variable, which would cause an error. The <span class="EmphasisFontCategoryNonProportional">mainHandler</span> variable saves the main thread handler. <span class="EmphasisFontCategoryNonProportional">MSG_REFRESHINFO</span> is a constant that handles custom messages.</div><div id="Par360" class="Para">Lines 10–15 are a constructor. In this function body, you initialize the value of the thread-running control variable <span class="EmphasisFontCategoryNonProportional">isEnded</span> and then save <span class="EmphasisFontCategoryNonProportional">mainHandler</span> as the main thread-handler object passed as a parameter.</div><div id="Par361" class="Para">Lines 16–33 are the core thread code that rewrites the <span class="EmphasisFontCategoryNonProportional">run</span> function. The code is composed of a loop to determine whether to continue to use the control variable <span class="EmphasisFontCategoryNonProportional">isEnded</span>. Here one loop is a step. Every step is also simple: when the <span class="EmphasisFontCategoryNonProportional">Thread</span> class static function <span class="EmphasisFontCategoryNonProportional">sleep</span> is called in line 28 after a specified time, a message is generated and assembled in lines 24–27. Finally, in line 28, the message is sent to the specified (message loop) handler.</div><div id="Par362" class="Para">Lines 34–37 are a custom control function to stop the thread from running. The purpose of the code is very simple: to change the run-loop control variable’s value.</div></div></div><div id="Sec25" class="Section2 RenderAsSection2"><h3 class="Heading">Thread Synchronization</h3><div id="Par363" class="Para">A multithreaded process inevitably involves a problem: how to deal with threads’ access to shared data, which relates to thread synchronization. Thread data sharing is also known as <span class="EmphasisTypeItalic">critical section</span>. Access to shared data is also known as <span class="EmphasisTypeItalic">competition</span> for resource access. In general OS textbooks, thread synchronization includes not only the synchronization of this passive selected access to shared data, but also ­active-choice synchronization between threads to collaborate to complete a task. In Java, thread synchronization is focused on access to shared data. This section discusses synchronization issues related to shared data access.</div><div id="Par364" class="Para">In multithreaded programming, if access to shared data does not use certain synchronization mechanisms, data consistency and integrity cannot be guaranteed. There are two ways to perform Java thread synchronization: an internal lock data object, and synchronization. Both approaches are implemented with the <span class="EmphasisFontCategoryNonProportional">synchronized</span> keyword. Statements modified by the <span class="EmphasisFontCategoryNonProportional">synchronized</span> block can guarantee the exclusivity of the operations between threads: they are unique, or <span class="EmphasisTypeItalic">atomic</span>. In Java, this process is simply called <span class="EmphasisTypeItalic">synchronization.</span> A synchronized block is also known as .</div><div id="Par365" class="Para">In the first approach to locking data objects, at any time, only one thread may access the object that is locked. The code framework is as follows:</div><div id="Par367" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">Object var;    // Object variable</span>
            </div><div id="Par368" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">synchronized</span></span>
              <span class="EmphasisFontCategoryNonProportional">(var) {</span>
            </div><div id="Par369" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">... ...    // Operation of the shared variable</span>
            </div><div id="Par370" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par372" class="Para">In this code, <span class="EmphasisFontCategoryNonProportional">var</span> must be the variable that each thread can access, so it becomes a synchronization variable. In practice, the synchronization variable and shared variables can be either the same or different. The <span class="EmphasisFontCategoryNonProportional">Object</span> class in the previous code can be replaced with a subclass of <span class="EmphasisFontCategoryNonProportional">Object</span>, because in addition to the simple classes in Java, any class can be the <span class="EmphasisFontCategoryNonProportional">Object</span> offspring class.</div><div id="Par373" class="Para">Note that the synchronization variable cannot be a simple type (such as <span class="EmphasisFontCategoryNonProportional">int</span> and <span class="EmphasisFontCategoryNonProportional">float</span>, but not the the <span class="EmphasisFontCategoryNonProportional">String</span> class):</div><div id="Par375" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">int var;</span>
            </div><div id="Par376" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">synchronized(var) {</span>
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">// compiler error</span></span>:<span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">int is not a valid type's argument for the synchronized statement</span></span>
            </div><div id="Par377" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">... ...</span>
            </div><div id="Par378" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par380" class="Para">When you use the second approach—the synchronization method—at any time, only one thread visits a code segment:</div><div id="Par382" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">class MyClass {</span>
            </div><div id="Par383" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public</span>
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">synchronized</span></span>
              <span class="EmphasisFontCategoryNonProportional">void method1()</span>
            </div><div id="Par384" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{ ... }</span>
            </div><div id="Par385" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par387" class="Para">The previous code is the synchronization for the general class (function). In addition, there is also synchronization for the class’s static function:</div><div id="Par389" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">class MyClass {</span>
            </div><div id="Par390" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public</span>
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">synchronized static</span></span>
              <span class="EmphasisFontCategoryNonProportional">void method2()</span>
            </div><div id="Par391" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{ ... }</span>
            </div><div id="Par392" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par394" class="Para">Using the synchronization method, the object that calls the synchronization method is locked. When an object of <span class="EmphasisFontCategoryNonProportional">MyClass: obj1</span> implements the synchronization method in a different thread, mutual exclusion achieves the synchronization result. But another object, <span class="EmphasisFontCategoryNonProportional">obj2</span>, generated by the class <span class="EmphasisFontCategoryNonProportional">MyClass</span>, can call this method with the <span class="EmphasisFontCategoryNonProportional">synchronized</span> keyword. As a result, the previous code can be written equivalently as shown next:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par395" class="Para">Synchronization (general) method:</div></li></ul></div>
            </div><div id="Par397" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">class MyClass {</span>
            </div><div id="Par398" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public void method1()</span>
            </div><div id="Par399" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{</span>
            </div><div id="Par400" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">synchronized (this)</span></span>
            </div><div id="Par401" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{ .../* function body */ }</span>
            </div><div id="Par402" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par403" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par404" class="Para ParaTypeProgramcode">
              <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par405" class="Para">Static synchronization method:</div></li></ul></div>
            </div><div id="Par407" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">class MyClass {</span>
            </div><div id="Par408" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public static void method2()</span>
            </div><div id="Par409" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{</span>
            </div><div id="Par410" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">synchronized (MyClass.class)</span></span>
            </div><div id="Par411" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{ .../* function body */ }</span>
            </div><div id="Par412" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par413" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par415" class="Para">In the static method, a class literal is treated as a lock. It generates the same result as the <span class="EmphasisFontCategoryNonProportional">synchronized</span> static function. The timing to get a lock is also special: the lock is acquired when calling the class that this object belongs to, and no longer the specific object that this class generates.</div><div id="Par416" class="Para">Following are the generalized rules that Java uses to implement a lock via the <span class="EmphasisFontCategoryNonProportional">synchronized</span> function:
<div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par417" class="Para">
                    <span class="EmphasisTypeItalic">Rule 1</span>: When two parallel threads visit the <span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segment of the same object, only one thread can be run at any one time. Other threads must wait until the current thread finishes running this code segment to run the same code segment.</div></li><li><div id="Par418" class="Para">
                    <span class="EmphasisTypeItalic">Rule 2</span>: When a thread visits a <span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segment of an object, another thread can still visit a non-<span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segment of an object.</div></li><li><div id="Par419" class="Para">
                    <span class="EmphasisTypeItalic">Rule 3</span>: When a thread visits a <span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segment of an object, visits by all other threads to all other <span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segments of the object are blocked.</div></li><li><div id="Par420" class="Para">
                    <span class="EmphasisTypeItalic">Rule 4</span>: When a thread visits a <span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segment of an object, it acquires the object’s object lock. As a result, visits from other threads to all <span class="EmphasisFontCategoryNonProportional">synchronized(this)</span> synchronization code segments of an object are temporally locked.</div></li><li><div id="Par421" class="Para">
                    <span class="EmphasisTypeItalic">Rule 5:</span> These rules apply to all other object locks.</div></li></ul></div>
            </div><div id="Par422" class="Para">Although <span class="EmphasisFontCategoryNonProportional">synchronized</span> can guarantee granularity of the object or executed block of statements, mutual exclusivity of this granularity degrades thread concurrency; so, the code, which originally could run in parallel, must run in serial execution. Therefore, you need to be cautious when you use the <span class="EmphasisFontCategoryNonProportional">synchronized</span> function, and limit it to cases when you need the <span class="EmphasisFontCategoryNonProportional">synchronized</span> lock. On the other hand, you should make the lock granularity as small as possible, in order to both ensure the correctness of the program and improve operational efficiency by making the degree of concurrency as great as possible.</div></div><div id="Sec26" class="Section2 RenderAsSection2"><h3 class="Heading">Thread Communication</h3><div id="Par423" class="Para">In multithreaded design, with data exchange among threads, setting the signal collaboration to complete a task is a common problem. Most significant are generalized threading issues, such as a typical example of the producer-consumer problem. These are the threads that must cooperate to accomplish a task.</div><div id="Par424" class="Para">In classic books on the OS, it is generally recommended that you use a semaphore to achieve thread-synchronization primitives. Java does not directly provide the semaphore primitives or programming interface, but achieves the function of the semaphore with class functions such as <span class="EmphasisFontCategoryNonProportional">wait</span>, <span class="EmphasisFontCategoryNonProportional">notify</span>, <span class="EmphasisFontCategoryNonProportional">notifyAll</span>, and so on.</div><div id="Par425" class="Para">
              <span class="EmphasisFontCategoryNonProportional">wait</span>
              <span class="EmphasisTypeItalic">,</span>
              <span class="EmphasisFontCategoryNonProportional">notify</span>
              <span class="EmphasisTypeItalic">,</span> and <span class="EmphasisFontCategoryNonProportional">notifyAll</span> belong to the function of the <span class="EmphasisFontCategoryNonProportional">Object</span> class and are not part of the <span class="EmphasisFontCategoryNonProportional">Thread</span> class. Every object has a waiting queue (<span class="EmphasisFontCategoryNonProportional">Wait Set</span>) in Java. When an object has just been created, its wait queue is empty.</div><div id="Par426" class="Para">The  function can make the objects in the current thread wait until another thread calls the <span class="EmphasisFontCategoryNonProportional">notify</span> or <span class="EmphasisFontCategoryNonProportional">notifyAll</span> method of this object. In other words, when a call waits in the object’s queue, the thread enters a wait state. Only when the <span class="EmphasisFontCategoryNonProportional">notify</span> method is called can you remove the thread from the queue to make it a runnable thread. The <span class="EmphasisFontCategoryNonProportional">notifyAll</span> method waits for all threads in the queue inside the object to become runnable threads. <span class="EmphasisFontCategoryNonProportional">Notify</span> and <span class="EmphasisFontCategoryNonProportional">notifyAll</span> are similar in functionality.</div><div id="Par427" class="Para">The <span class="EmphasisFontCategoryNonProportional">wait</span>, <span class="EmphasisFontCategoryNonProportional">notify</span>, and <span class="EmphasisFontCategoryNonProportional">notifyAll</span> functions need to be used in conjunction with <span class="EmphasisFontCategoryNonProportional">synchronized</span> to establish the synchronization model, which can guarantee the granularity of the former functions. For example, before calling <span class="EmphasisFontCategoryNonProportional">wait</span>, you need to get the object’s synchronization lock so that this function can be called. Otherwise, the compiler can call the <span class="EmphasisFontCategoryNonProportional">wait</span> function, but it will receive an <span class="EmphasisFontCategoryNonProportional">IllegalMonitorStateException</span> runtime exception.</div><div id="Par428" class="Para">Following are several examples of code frameworks for <span class="EmphasisFontCategoryNonProportional">wait</span>, <span class="EmphasisFontCategoryNonProportional">notify</span>, and <span class="EmphasisFontCategoryNonProportional">notifyAll</span>:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par429" class="Para">Waiting for a resource code:</div></li></ul></div>
            </div><div id="Par431" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">synchronized(obj) {</span>
            </div><div id="Par432" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">while(!condition)</span>
            </div><div id="Par433" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">try {</span>
            </div><div id="Par434" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">obj.wait();</span>
            </div><div id="Par435" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">} catch (InterruptedException e) {</span>
            </div><div id="Par436" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par437" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">......Use code of obj</span>
            </div><div id="Par438" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par439" class="Para ParaTypeProgramcode">
              <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par440" class="Para">Providing resources (example: complete use of resources and returning to the system):</div></li></ul></div>
            </div><div id="Par442" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">synchronized(obj) {</span>
            </div><div id="Par443" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">condition = true;</span>
            </div><div id="Par444" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">obj.notify();</span>
            </div><div id="Par445" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par447" class="Para">The previous code is the standalone use case of the synchronization object <span class="EmphasisFontCategoryNonProportional">obj</span>. You can also write synchronization code in a class. The framework of this code can be written as follows:</div><div id="Par449" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">class MyClass{</span>
            </div><div id="Par450" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public synchronized void func1 {</span>
            </div><div id="Par451" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">while (!condition)</span>
            </div><div id="Par452" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">try {</span>
            </div><div id="Par453" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">wait();</span>
            </div><div id="Par454" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">} catch (InterruptedException e) {</span>
            </div><div id="Par455" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par456" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">...... codes for using MyClass resource</span>
            </div><div id="Par457" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par458" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public synchronized void func2 {</span>
            </div><div id="Par459" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">condition = true;</span>
            </div><div id="Par460" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">notifyAll();</span>
            </div><div id="Par461" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par462" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par464" class="Para">The thread that is waiting for resources can call the <span class="EmphasisFontCategoryNonProportional">myclass.func1</span> function, and the thread that provides resources calls the <span class="EmphasisFontCategoryNonProportional">myclass.func2</span> function.</div></div><div id="Sec27" class="Section2 RenderAsSection2"><h3 class="Heading">Principles of Multithreaded Optimization for the Intel Atom Processor</h3><div id="Par465" class="Para">Multithreaded software design allows program code in different threads to run at the same time. However, blind use of multithreading or excessive use of multithreaded programming may not lead to performance improvement and may even downgrade software performance. Therefore, you need to understand the principles of multithreaded optimization on Android x86.</div><div id="Par466" class="Para">First, the start, or scheduling, of a thread requires a certain amount of overhead and occupies a certain amount of processor time. Processors that do not support hyperthreading and multi-core processing cannot physically let these threads run at the same time. To support multithreaded programs, there is significant overhead if you split one physical processor into multiple logical processors with virtualization technologies so that each thread can run on a logical core. Such a multithreading strategy not only makes it difficult to achieve improvement in performance, but may even lead to the multithreaded execution speed being slower than a single-threaded program. Therefore, to achieve multithreaded performance acceleration (a prerequisite to being faster than single-threaded execution speed) using multithreaded design, the processor must support hyperthreading or multi-core.</div><div id="Par467" class="Para">Second, for processors that support hyperthreading or multi-core, it is not always true that more threads will make software run faster. You must consider the performance/price ratio. The physical basis of multithreaded design for performance tuning is to allow multiple threads to run at the same time in parallel on the physical layer. Therefore, the maximum number of concurrently running threads supported by the processor is the optimum number of threads for multithreaded optimization.</div><div id="Par468" class="Para">According to Intel’s official statement, Intel Hyper-Threading Technology can support two threads running in parallel, with multi-core support for multiple threads running in parallel. For example, for a dual-core Intel processor that supports Intel Hyper-Threading Technology, the maximum number of threads supported to run in parallel is</div><div class="Para">
              <img src="A978-1-4842-0100-8_11_Figa_HTML.jpg" alt="A978-1-4842-0100-8_11_Figa_HTML.jpg"/>
            </div><div id="Par469" class="Para">Therefore, this machine supports multithreaded optimization, and the maximum number of threads (threads running concurrently) is equal to four.</div><div id="Par470" class="Para">For a Motorola MT788 target machine, which uses a single-core Intel Atom Z2480 processor with HT, the optimal number of threads is two. If the target machine is a Lenovo K900 with a dual-core Intel Atom Z2580 processor with Intel HT, the optimal number of threads is four.</div><div id="Par471" class="Para">In general, when you consider multithreaded optimization on the Android platform, it is necessary to look carefully at the processor information to see if it supports hyperthreading or multi-core technology.</div></div></div><div id="Sec28" class="Section1 RenderAsSection1"><h2 class="Heading">Case Study: Intel GPA-Assisted Multithreaded Optimization for an Android Application</h2><div id="Par472" class="Para">The previous section explained several optimization techniques and principles. This section uses a comprehensive example to explain optimization. In this case, multithreaded optimization is combined with optimization assisted by Intel GPA to make the application run faster.</div><div id="Par473" class="Para">The example app calculates pi (π). Let’s look at some background for the app. The mathematical formula is as follows:</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Figb_HTML.jpg" alt="A978-1-4842-0100-8_11_Figb_HTML.jpg"/>
          </div><div id="Par474" class="Para">The integration formula can be expressed using the infinitive:</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Figc_HTML.jpg" alt="A978-1-4842-0100-8_11_Figc_HTML.jpg"/>
          </div><div id="Par475" class="Para">∆<span class="EmphasisTypeItalic">x</span> cannot be infinitely small—you can only make ∆<span class="EmphasisTypeItalic">x</span> as small as possible. So, the result of the formula is closer to <span class="EmphasisTypeItalic">π</span>. Using <span class="EmphasisTypeItalic">step</span> to represent ∆<span class="EmphasisTypeItalic">x</span>,</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Figd_HTML.jpg" alt="A978-1-4842-0100-8_11_Figd_HTML.jpg"/>
          </div><div class="Para">The value of step must be maximum to get an accurate value of pi. Consider that</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Fige_HTML.jpg" alt="A978-1-4842-0100-8_11_Fige_HTML.jpg"/>
          </div><div class="Para">While f(x) is a raised function. Here you take a median value to calculate the sum. That is, you use</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Figf_HTML.jpg" alt="A978-1-4842-0100-8_11_Figf_HTML.jpg"/>
          </div><div class="Para">to replace</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Figg_HTML.jpg" alt="A978-1-4842-0100-8_11_Figg_HTML.jpg"/>
          </div><div class="Para">to calculate the sum. The result calculated by this formula is not always smaller than the actual value of π. So, eventually, you get the final formula on which this app is based:</div><div class="Para">
            <img src="A978-1-4842-0100-8_11_Figh_HTML.jpg" alt="A978-1-4842-0100-8_11_Figh_HTML.jpg"/>
          </div><div id="Par476" class="Para">It is not difficult to write the source code based on this formula.</div><div id="Sec29" class="Section2 RenderAsSection2"><h3 class="Heading">Original Application and Intel GPA Analysis</h3><div id="Par477" class="Para">You begin by deriving the app’s un-optimized computing source code from the formula in the previous section. This application is named <span class="EmphasisFontCategoryNonProportional">SerialPi</span>.</div><div id="Par478" class="Para">The design of this app is the same as that in the “Thread Example” section earlier. The task of calculating π is put in a worker thread (here called a task thread) to run. A button is set on main activity to control the running of the thread, and a <span class="EmphasisFontCategoryNonProportional">TextView</span> is used to display the result of the task thread. The interface showing the app’s single run is shown in Figure <span class="InternalRef"><a href="#Fig18">11-18</a></span>.<div class="Figure" id="Fig18"><div class="MediaObject" id="MO18"><img src="A978-1-4842-0100-8_11_Fig18_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig18_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-18.</span><div class="SimplePara">
                      <span class="EmphasisFontCategoryNonProportional">SerialPi</span> app interface</div></div></div></div>
            </div><div id="Par479" class="Para">The interface after the application starts is shown in Figure <span class="InternalRef"><a href="#Fig18">11-18(a)</a></span>. When you click the Start Calculating button, all buttons on the interface gray out until the computation is complete. The interface then displays the computation result as well as the thread’s total running time. Clicking Exit App, as shown in Figure <span class="InternalRef"><a href="#Fig18">11-18(b)</a></span> exits the application. From the interface screen, you can see that it takes about 22 seconds for this app to calculate π. Running the application repeatedly, the calculation time remains about the same (22 seconds).</div><div id="Par480" class="Para">The steps to build the application and write the key code are as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par481" class="Para">Create a new application called . The proposed project property should use the default value. Set [Build SDK] to support x86 API.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par482" class="Para">Edit <span class="EmphasisFontCategoryNonProportional">activity_main.xml</span>. Place two <span class="EmphasisFontCategoryNonProportional">Button</span> components and two <span class="EmphasisFontCategoryNonProportional">TextView</span> components in the layout. Set the <span class="EmphasisFontCategoryNonProportional">ID</span> attribute of one <span class="EmphasisFontCategoryNonProportional">TextView</span> to <span class="EmphasisFontCategoryNonProportional">@+id/taskOuputInfo</span>: it will display the results of the task thread, as shown in Figure <span class="InternalRef"><a href="#Fig19">11-19</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par483" class="Para">  <div class="Figure" id="Fig19"><div class="MediaObject" id="MO19"><img src="A978-1-4842-0100-8_11_Fig19_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig19_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-19.</span><div class="SimplePara">Layout for the <span class="EmphasisFontCategoryNonProportional">SerialPi</span> App</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par484" class="Para">Create new thread class <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> in the project, and edit the source code file <span class="EmphasisFontCategoryNonProportional">MyTaskThread.java</span> as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par486" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1. package com.example.serialpi;</span>
            </div><div id="Par487" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2. import android.os.Handler;</span>
            </div><div id="Par488" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3. import android.os.Message;</span>
            </div><div id="Par490" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4. public class MyTaskThread extends Thread {</span>
            </div><div id="Par491" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.     private Handler mainHandler;</span>
            </div><div id="Par492" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.     public static final int MSG_FINISHED = 1;</span>
            </div><div id="Par493" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7. // Defined the message type  for the end of the calculation</span>
            </div><div id="Par494" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">8.     private static final long num_steps = 200000000;</span></span>
            </div><div id="Par495" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">9. // num_steps variables in Formula, the total number of steps</span></span>
            </div><div id="Par496" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">private static final double step = 1.0 / num_steps;</span></span>
            </div><div id="Par497" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">10. // Step variable  in formula, step length</span></span>
            </div><div id="Par498" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">11.     public static double pi = 0.0;</span></span>
            </div><div id="Par499" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold">12. // the calculation of results of π</span>
            </div><div id="Par500" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13.</span>
            </div><div id="Par501" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.     static String msTimeToDatetime(long msnum){</span>
            </div><div id="Par502" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15. // The function converts the number of milliseconds into hours: minutes: seconds. Milliseconds "format</span>
            </div><div id="Par503" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.         long hh,mm,ss,ms, tt= msnum;</span>
            </div><div id="Par504" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.         ms = tt % 1000; tt = tt / 1000;</span>
            </div><div id="Par505" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.         ss = tt % 60; tt = tt / 60;</span>
            </div><div id="Par506" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.         mm = tt % 60; tt = tt / 60;</span>
            </div><div id="Par507" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.         hh = tt % 60;</span>
            </div><div id="Par508" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.         String s = "" + hh +"hour "+mm+"minute "+ss + "</span>Second<span class="EmphasisFontCategoryNonProportional">" + ms +"Milliseconds";</span>
            </div><div id="Par509" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.         return s;</span>
            </div><div id="Par510" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.     }</span>
            </div><div id="Par511" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.</span>
            </div><div id="Par512" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.     @Override</span>
            </div><div id="Par513" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.     public void run()</span>
            </div><div id="Par514" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27.     {</span>
            </div><div id="Par515" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">28.         double x, sum = 0.0;</span></span>
            </div><div id="Par516" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">long i;</span></span>
            </div><div id="Par517" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">for (i=0; i&lt; num_steps; i++){</span></span>
            </div><div id="Par518" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">29.             x = (i+0.5)*step;</span></span>
            </div><div id="Par519" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">30.             sum = sum + 4.0/(1.0 + x*x);</span></span>
            </div><div id="Par520" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">31.         }</span></span>
            </div><div id="Par521" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">32.         pi = step * sum;</span></span>
            </div><div id="Par523" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">33.         Message msg = new Message();</span>
            </div><div id="Par524" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">34.         msg.what = MSG_FINISHED;       // Define message Type</span>
            </div><div id="Par525" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">35.         mainHandler.sendMessage(msg);  // Send Message</span>
            </div><div id="Par526" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">36.     }</span>
            </div><div id="Par527" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">37.</span>
            </div><div id="Par528" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">38.     public MyTaskThread(Handler mh)    // Constructor</span>
            </div><div id="Par529" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">39.     {</span>
            </div><div id="Par530" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">40.         super();</span>
            </div><div id="Par531" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">41.         mainHandler = mh;</span>
            </div><div id="Par532" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">42.     }</span>
            </div><div id="Par533" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">43. }</span>
            </div><div id="Par535" class="Para">Similar to the framework and the example code listed in the thread example earlier, thread-inheritance laws are used to initialize the thread. Pay close attention to the code segments in bold, which are most directly related to the calculation of π. Lines 7 and 8 define a static variable with the same name used in the formula that calculates π. Line 9 defines the variable for saving the results of the π calculation. Note that this variable is public so that the main thread can access it.</div><div class="Para">
              <img src="A978-1-4842-0100-8_11_Figi_HTML.jpg" alt="A978-1-4842-0100-8_11_Figi_HTML.jpg"/>
            </div><div id="Par536" class="Para">Lines 22–28 calculate π according to the formula. The <span class="EmphasisFontCategoryNonProportional">x</span> variable is an independent variable of function
and <span class="EmphasisFontCategoryNonProportional">sum</span> is a cumulative variable of Σ. Line 28 calculates the final results. Refer to the code framework mentioned in the earlier section of this chapter on page 32 titled. “Thread Example”; it should not be difficult to understand.</div><div id="Par537" class="Para">Note that in the thread’s <span class="EmphasisFontCategoryNonProportional">run</span> function, once the calculation is complete, the message is sent to the main thread (interface) in line 29.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par538" class="Para">Edit the source code in the main activity class file <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span>. This code controls the run of the thread and displays the calculated results:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par540" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 1. package com.example.serialpi;</span>
            </div><div id="Par541" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 2. import android.os.Bundle;</span>
            </div><div id="Par542" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 3. import android.app.Activity;</span>
            </div><div id="Par543" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 4. import android.view.Menu;</span>
            </div><div id="Par544" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 5. import android.widget.Button;</span>
            </div><div id="Par545" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 6. import android.view.View;</span>
            </div><div id="Par546" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 7. import android.view.View.OnClickListener;</span>
            </div><div id="Par547" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 8. import android.os.Process;</span>
            </div><div id="Par548" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 9. import android.widget.TextView;</span>
            </div><div id="Par549" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10. import android.os.Handler;</span>
            </div><div id="Par550" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11. import android.os.Message;</span>
            </div><div id="Par552" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12. public class MainActivity extends Activity {</span>
            </div><div id="Par553" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13.     private MyTaskThread myThread = null;</span>
            </div><div id="Par554" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.     private TextView tv_TaskOutputInfo;  // Display (Calculated) Task thread output</span>
            </div><div id="Par555" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">15.     private Handler mHandler;;</span></span>
            </div><div id="Par556" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">16.     private long end_time;</span></span>
            </div><div id="Par557" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">17.     private long time;</span></span>
            </div><div id="Par558" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">18.     private long start_time;</span></span>
            </div><div id="Par560" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.     @Override</span>
            </div><div id="Par561" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.     public void onCreate(Bundle savedInstanceState) {</span>
            </div><div id="Par562" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.         super.onCreate(savedInstanceState);</span>
            </div><div id="Par563" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.         setContentView(R.layout.activity_main);</span>
            </div><div id="Par564" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.         tv_TaskOutputInfo = (TextView)findViewById(R.id.taskOuputInfo);</span>
            </div><div id="Par565" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.         final Button btn_ExitApp = (Button) findViewById(R.id.exitApp);</span>
            </div><div id="Par566" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.         btn_ExitApp.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par567" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.             public void onClick(View v) {</span>
            </div><div id="Par568" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27.                 exitApp();</span>
            </div><div id="Par569" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">28.             }</span>
            </div><div id="Par570" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">29.         });</span>
            </div><div id="Par571" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">30.         final Button btn_StartTaskThread = (Button) findViewById(R.id.startTaskThread);</span>
            </div><div id="Par572" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">31.         btn_StartTaskThread.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par573" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32.             public void onClick(View v) {</span>
            </div><div id="Par574" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">33.                 btn_StartTaskThread.setEnabled(false);</span>
            </div><div id="Par575" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">34.                 btn_ExitApp.setEnabled(false);</span>
            </div><div id="Par576" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">35.                  startTask();</span>
            </div><div id="Par577" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">36.               }</span>
            </div><div id="Par578" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">37.         });</span>
            </div><div id="Par579" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">38.         mHandler = new Handler() {</span>
            </div><div id="Par580" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">39.             public void handleMessage(Message msg) {</span>
            </div><div id="Par581" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">40.                switch (msg.what)</span>
            </div><div id="Par582" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">41.                 {</span>
            </div><div id="Par583" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">42.                 case MyTaskThread.MSG_FINISHED:</span>
            </div><div id="Par584" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">43.                     end_time = System.currentTimeMillis();</span></span>
            </div><div id="Par585" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">44.                     time = end_time - start_time;</span></span>
            </div><div id="Par586" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">45.                     String s = " The end of the run</span>,<span class="EmphasisFontCategoryNonProportional">Pi="+ MyTaskThread.pi+ "  Time consumed:"</span>
            </div><div id="Par587" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">46.                             +</span>
            </div><div id="Par588" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">47. MyTaskThread.msTimeToDatetime(time);</span>
            </div><div id="Par589" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">48.                     tv_TaskOutputInfo.setText(s);</span>
            </div><div id="Par590" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">49.                     btn_ExitApp.setEnabled(true);</span>
            </div><div id="Par591" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">50.                     break;</span>
            </div><div id="Par592" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">51.                 default:</span>
            </div><div id="Par593" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">52.                     break;</span>
            </div><div id="Par594" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">53.                 }</span>
            </div><div id="Par595" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">54.             }</span>
            </div><div id="Par596" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">55.         };</span>
            </div><div id="Par597" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par598" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">56.</span>
            </div><div id="Par599" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">57.     @Override</span>
            </div><div id="Par600" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">58.     public boolean onCreateOptionsMenu(Menu menu) {</span>
            </div><div id="Par601" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">59.         getMenuInflater().inflate(R.menu.activity_main, menu);</span>
            </div><div id="Par602" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">60.         return true;</span>
            </div><div id="Par603" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par604" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">61.</span>
            </div><div id="Par605" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">62.     private void startTask() {</span>
            </div><div id="Par606" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">63.         myThread = new MyTaskThread(mHandler);    // Create a thread</span>
            </div><div id="Par607" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">64.         if (! myThread.isAlive())</span>
            </div><div id="Par608" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">65.         {</span>
            </div><div id="Par609" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">66.                start_time = System.currentTimeMillis();</span></span>
            </div><div id="Par610" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">67.             myThread.start();  // Start thread</span>
            </div><div id="Par611" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">68.         }</span>
            </div><div id="Par612" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par613" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">69.</span>
            </div><div id="Par614" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">70.     private void exitApp() {</span>
            </div><div id="Par615" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">71.         try {</span>
            </div><div id="Par616" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">72.             if (myThread!=null)</span>
            </div><div id="Par617" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">73.             {</span>
            </div><div id="Par618" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">74.                 myThread.join();</span>
            </div><div id="Par619" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">75.                 myThread = null;</span>
            </div><div id="Par620" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">76.             }</span>
            </div><div id="Par621" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">77.         } catch (InterruptedException e) {</span>
            </div><div id="Par622" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">78.         }</span>
            </div><div id="Par623" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">79.         finish();   // Exit the activity</span>
            </div><div id="Par624" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">80.         Process.killProcess(Process.myPid());  // Exit the application process</span>
            </div><div id="Par625" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">81.     }</span>
            </div><div id="Par626" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">     }</span>
            </div><div id="Par628" class="Para">This code is similar to the code framework of the example <span class="EmphasisFontCategoryNonProportional">MainActivity</span> class in the “Thread Example” section. The lines of code shown with a gray background are added to estimate the task’s running time. Three variables are defined in line 16–18: <span class="EmphasisFontCategoryNonProportional">start_time</span> is the task’s start time, <span class="EmphasisFontCategoryNonProportional">end_time</span> as the task’s end time, and <span class="EmphasisFontCategoryNonProportional">time</span> is the task’s running time. These three variables are parts of the following formula:</div><div id="Par630" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">time = end_time - start_time</span>
            </div><div id="Par632" class="Para">In line 65, when you start the task threads, the machine’s current time is recorded in the <span class="EmphasisFontCategoryNonProportional">start_time</span> variable at the same time. In lines 43–44, when the message is received that the task thread has finished running, the machine’s time is recorded in <span class="EmphasisFontCategoryNonProportional">end_time</span>. The <span class="EmphasisFontCategoryNonProportional">currentTimeMillis</span> function is a static function provided by the Java <span class="EmphasisFontCategoryNonProportional">System</span> class in the <span class="EmphasisFontCategoryNonProportional">java.lang</span> package; it returns the current time in milliseconds.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par633" class="Para">Referring to the “Thread Communication” section’s example, modify the project’s <span class="EmphasisFontCategoryNonProportional">AndroidManifest.xml</span> file to make it comply with the requirements of Intel GPA monitoring.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par634" class="Para">After the coding is completed and you’ve compiled and generated the app, deploy it to the target device.</div><div id="Par635" class="Para">Now you can use Intel GPA to analyze this application. See the steps in the “Thread Communication” section. First you monitor and analyze the two CPU loads (CPU XX Load indicators). During monitoring, click the Start button to begin running and monitoring information recorded under Intel GPA. The results of the analysis are shown in Figure <span class="InternalRef"><a href="#Fig20">11-20</a></span>.<div class="Figure" id="Fig20"><div class="MediaObject" id="MO20"><img src="A978-1-4842-0100-8_11_Fig20a_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig20a_HTML.jpg"/><img src="A978-1-4842-0100-8_11_Fig20b_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig20b_HTML.jpg"/><img src="A978-1-4842-0100-8_11_Fig20c_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig20c_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-20.</span><div class="SimplePara">Intel GPA analysis screen for <span class="EmphasisFontCategoryNonProportional">SerialPi</span>
                    </div></div></div></div>
            </div><div id="Par636" class="Para">Figure <span class="InternalRef"><a href="#Fig20">11-20(a)</a></span> shows the analysis when you click the Start button, Figure <span class="InternalRef"><a href="#Fig20">11-20(b)</a></span> shows the task thread running and Figure <span class="InternalRef"><a href="#Fig20">11-20(c)</a></span> shows the task thread at the end of the run. From the three screens, you can see that the load on the CPU stays at a low level before the app begins to run and after the end of the run. Once the computing task thread starts to run, the load on the CPU rises sharply to 100% of load. You can also see that while the task thread is running, only one of the two CPUs is at full capacity; the other is at low load levels. By analyzing the graph, you can see that the 100% load does not always occur on a specific CPU. Instead, the 100% load alternates between the two CPUs, which reflects the Java Runtime time support for task scheduling: the processor system is transparent to applications. Although a two-CPU load rate is subject to rotation, the load rate is a complementary state: a rising load on one CPU means a decreasing load on another. Thus the total load (sum of the loads of two CPUs at any time) does not exceed the 100% load of a single CPU.</div></div><div id="Sec30" class="Section2 RenderAsSection2"><h3 class="Heading">Optimized Application and Intel GPA Analysis</h3><div id="Par637" class="Para">The preceding example uses code derived directly from the formula for calculating π. Is there room for optimization? The answer is definitely yes. Doing so requires you to examine the app’s algorithm and apply the optimization principles you’ve learned, making full use of the Intel Atom processor’s hardware features.</div><div id="Par638" class="Para">How do you tap the full performance potential of the Intel Atom processor? As explained earlier, multi-core Intel Atom processors with Intel Hyper-Threading Technology support multithreading running in parallel on multiple physical cores. For example, the Lenovo K900 phone uses an Intel Atom Z2580 processor and supports two threads running in parallel. This is the entry point for your algorithm optimization: you can divide and conquer. By carefully analyzing the <span class="EmphasisFontCategoryNonProportional">run</span> function in the example <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> class in the previous section, you can make computing tasks allocated to multiple (in this case, two) threads run; and the threads running in parallel can make the app run faster.</div><div id="Par639" class="Para">To calculate the cumulative value of the integral area for π, in line 24 you calculated the integral area one step at a time and added the cumulative sum. In this section you take a different approach: you divide the integral area into many blocks and let each thread be responsible for calculating a block. You get the π value by adding the cumulative area of the blocks calculated by the threads. This way, you use a divide-and-conquer strategy to complete the task distribution and get the final results. The optimized app is called . When <span class="EmphasisFontCategoryNonProportional">ThreadPi</span> is calculating the cumulative value of the integral area (which is the π value), each thread’s calculation step accumulates the step size to increase the total number of threads so that each thread is responsible for the sum of their own area of the block.</div><div id="Par640" class="Para">The UI of the running <span class="EmphasisFontCategoryNonProportional">ThreadPi</span> app is shown in Figure <span class="InternalRef"><a href="#Fig21">11-21</a></span>.<div class="Figure" id="Fig21"><div class="MediaObject" id="MO21"><img src="A978-1-4842-0100-8_11_Fig21_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig21_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-21.</span><div class="SimplePara">User interface of <span class="EmphasisFontCategoryNonProportional">ThreadPi</span>
                    </div></div></div></div>
            </div><div id="Par641" class="Para">The interface of this optimized application (<span class="EmphasisFontCategoryNonProportional">ThreadPi</span>) is the same as the original application (<span class="EmphasisFontCategoryNonProportional">SerialPi</span>). In Figure <span class="InternalRef"><a href="#Fig21">11-21(b)</a></span>, you can see that this application takes 13 seconds to calculate the value of π. The time is reduced to almost half that of the original application (22 seconds). The only difference is that the application uses two threads to calculate π.</div><div id="Par642" class="Para">This application is based on modifying the original application code. The key changes are as follows.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par643" class="Para">Modify the thread class of the computing tasks’ <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> source code file <span class="EmphasisFontCategoryNonProportional">MyTaskThread.java</span> as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par645" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 1. package com.example.threadpi;</span>
            </div><div id="Par646" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 2. import android.os.Handler;</span>
            </div><div id="Par647" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 3. import android.os.Message;</span>
            </div><div id="Par649" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 4. public class MyTaskThread extends Thread {</span>
            </div><div id="Par650" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 5.     private Handler mainHandler;</span>
            </div><div id="Par651" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 6.     public static final int MSG_FINISHED = 1;</span>
            </div><div id="Par652" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 7.     private static final long num_steps = 200000000;</span>
            </div><div id="Par653" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 8. // num_steps variable in formula, total steps</span>
            </div><div id="Par654" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 9.     private static final double step = 1.0 / num_steps;</span>
            </div><div id="Par655" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10. // step variable in formula, step length</span>
            </div><div id="Par656" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11.     public static double pi = 0.0;   //  Calculated result of π</span>
            </div><div id="Par657" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">12.     public static final int num_threads = 2;   // Thread count</span></span>
            </div><div id="Par658" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">13.     private int myNum;                         // Thread #</span></span>
            </div><div id="Par659" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">private static Object sharedVariable = new Object();</span></span>
            </div><div id="Par660" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">14. // synchronization lock variable for Pi variable</span></span>
            </div><div id="Par661" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">15.     private static int finishedThreadNum = 0;</span></span>
            </div><div id="Par662" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">16. // count of threads finishing calculation</span></span>
            </div><div id="Par663" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.</span>
            </div><div id="Par664" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.     static String msTimeToDatetime(long msnum){</span>
            </div><div id="Par665" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19. // The function to convert the number of milliseconds into hours: minutes: seconds. Millis</span>
            </div><div id="Par666" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.         long hh,mm,ss,ms, tt= msnum;</span>
            </div><div id="Par667" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.         ms = tt % 1000; tt = tt / 1000;</span>
            </div><div id="Par668" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.         ss = tt % 60; tt = tt / 60;</span>
            </div><div id="Par669" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">mm = tt % 60; tt = tt / 60;</span>
            </div><div id="Par670" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.         hh = tt % 60;</span>
            </div><div id="Par671" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.         String s = "" + hh +"hour "+mm+"minute "+ss + "</span>秒 <span class="EmphasisFontCategoryNonProportional">" + ms +"milliseconds";</span>
            </div><div id="Par672" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.         return s;</span>
            </div><div id="Par673" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.     }</span>
            </div><div id="Par675" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">27.     public void setStepStartNum(int n)</span></span>
            </div><div id="Par676" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">28. // set thread # for thread, in response to starting position of i</span></span>
            </div><div id="Par677" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">29.     {</span></span>
            </div><div id="Par678" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">30.         myNum = n;</span></span>
            </div><div id="Par679" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">31.     }</span></span>
            </div><div id="Par680" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32.</span>
            </div><div id="Par681" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">33.     @Override</span>
            </div><div id="Par682" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">34.     public void run()</span>
            </div><div id="Par683" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">35.     {</span>
            </div><div id="Par684" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">36.         double x, partialSum = 0.0;</span></span>
            </div><div id="Par685" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">37.         long i;</span></span>
            </div><div id="Par686" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">38.         for (i = myNum; i &lt; num_steps; i += num_threads) {</span></span>
            </div><div id="Par687" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">39.             x = (i + 0.5) * step;</span></span>
            </div><div id="Par688" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">40.             partialSum += 4.0 / (1.0 + x * x);</span></span>
            </div><div id="Par689" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">41.         }</span></span>
            </div><div id="Par690" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">42.         synchronized (sharedVariable) {</span></span>
            </div><div id="Par691" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">43.             pi += partialSum * step;</span></span>
            </div><div id="Par692" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">44.             finishedThreadNum++;</span></span>
            </div><div id="Par693" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">45.             if (finishedThreadNum &gt;=num_threads) {</span></span>
            </div><div id="Par694" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">// waiting all threads finishing run and send message</span></span>
            </div><div id="Par695" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">46.             Message msg = new Message();</span>
            </div><div id="Par696" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">47.             msg.what = MSG_FINISHED; //Define message type</span>
            </div><div id="Par697" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">48.             mainHandler.sendMessage(msg);   //Send message</span>
            </div><div id="Par698" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">49.             }</span></span>
            </div><div id="Par699" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">50.         }</span></span>
            </div><div id="Par700" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">51.     }</span>
            </div><div id="Par702" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">public MyTaskThread(Handler mh)  // constructor</span>
            </div><div id="Par703" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">{</span>
            </div><div id="Par704" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">super();</span>
            </div><div id="Par705" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">mainHandler = mh;</span>
            </div><div id="Par706" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par707" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par709" class="Para">The code segments shown with in bold are the main difference between <span class="EmphasisFontCategoryNonProportional">ThreadPi</span> and <span class="EmphasisFontCategoryNonProportional">SerialPi</span>. Lines 10–13 define the variables required for multithreaded computing tasks. The variable <span class="EmphasisFontCategoryNonProportional">num_threads</span> computes the number of threads when the computing task starts. In this case, the Lenovo K900 has an Intel Atom processor with two logical CPUs, so this value is set to 2. The <span class="EmphasisFontCategoryNonProportional">myNum</span> variable computes the thread number, which is in the range 0 to <span class="EmphasisFontCategoryNonProportional">num_threads</span> – 1. The variable <span class="EmphasisFontCategoryNonProportional">sharedVariable</span> is introduced by a synchronization lock applied to variable <span class="EmphasisFontCategoryNonProportional">pi</span>. Because <span class="EmphasisFontCategoryNonProportional">pi</span> is a simple variable, it cannot be directly locked. The <span class="EmphasisFontCategoryNonProportional">finishedThreadNum</span> variable is the number of threads used to complete the calculation. When the value of <span class="EmphasisFontCategoryNonProportional">finishedThreadNum</span> is equal to that of <span class="EmphasisFontCategoryNonProportional">num_threads</span>, all the computing threads have finished running.</div><div id="Par710" class="Para">Lines 23–26 are a function you add specifically for <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span>, the computing thread. It marks the thread’s index number.</div><div id="Par711" class="Para">Lines 30–44 are the prototype code of the computing thread. Lines 30–35 are the direct code to calculate π. Compared with the corresponding code in the original application, you can see that the <span class="EmphasisFontCategoryNonProportional">sum</span> variable in the original app has been replaced with <span class="EmphasisFontCategoryNonProportional">partialSum</span>, which reflects the fact that the area of this thread is only part of the total area. The most important difference is in line 32: the step-length variable <span class="EmphasisFontCategoryNonProportional">i</span> is not 1 but <span class="EmphasisFontCategoryNonProportional">num_threads</span>, which means the thread moves forward a few steps every time. The initial position of variable <span class="EmphasisFontCategoryNonProportional">I</span> is not 0 but is derived from the thread number. This is a little like a track and field competition, where each athlete (thread) starts at the beginning of their lane rather than from the same starting point. The thread computation is like athletes running in their own lanes on their own track.</div><div id="Par712" class="Para">Each thread calculates its sum and needs to add this data to the total cumulative sum (the <span class="EmphasisFontCategoryNonProportional">pi</span> variable). This variable is shared by multiple threads, so you need to add a synchronization lock. This step corresponds to lines 36–44. Line 36 adds the synchronization lock, and line 37 adds the result of the thread’s calculation to the public results of <span class="EmphasisFontCategoryNonProportional">pi</span>. Line 38 adds 1 to the number of threads at the end of the calculation. In line 39, by comparing the number of threads that have finished the calculation to the total number of threads, you determine whether all the threads have finished running. Only at after all threads have finished is the message sent to the main thread.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par713" class="Para">Modify the source code file of the main activity class <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span> as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par715" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 1. package com.example.threadpi;</span>
            </div><div id="Par716" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 2. import android.os.Bundle;</span>
            </div><div id="Par717" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 3. import android.app.Activity;</span>
            </div><div id="Par718" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 4. import android.view.Menu;</span>
            </div><div id="Par719" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 5. import android.widget.Button;</span>
            </div><div id="Par720" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 6. import android.view.View;</span>
            </div><div id="Par721" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 7. import android.view.View.OnClickListener;</span>
            </div><div id="Par722" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 8. import android.os.Process;</span>
            </div><div id="Par723" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional"> 9. import android.widget.TextView;</span>
            </div><div id="Par724" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10. import android.os.Handler;</span>
            </div><div id="Par725" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11. import android.os.Message;</span>
            </div><div id="Par727" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12. public class MainActivity extends Activity {</span>
            </div><div id="Par728" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">13.     private MyTaskThread thrd[] = null;</span></span>
            </div><div id="Par729" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.     private TextView tv_TaskOutputInfo;</span>
            </div><div id="Par730" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.     private Handler mHandler;;</span>
            </div><div id="Par731" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.     private long end_time;</span>
            </div><div id="Par732" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.     private long time;</span>
            </div><div id="Par733" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.     private long start_time;</span>
            </div><div id="Par735" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.     @Override</span>
            </div><div id="Par736" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.     public void onCreate(Bundle savedInstanceState) {</span>
            </div><div id="Par737" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.         super.onCreate(savedInstanceState);</span>
            </div><div id="Par738" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.         setContentView(R.layout.activity_main);</span>
            </div><div id="Par739" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.         tv_TaskOutputInfo = (TextView)findViewById(R.id.taskOuputInfo);</span>
            </div><div id="Par740" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.         TextView tv_Info = (TextView)findViewById(R.id.textView1);</span>
            </div><div id="Par741" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.         String ts = "This example currently has"+ MyTaskThread.num_threads + "threads in this run on calculating the value of Pi";</span>
            </div><div id="Par742" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.         tv_Info.setText(ts);</span>
            </div><div id="Par743" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27.         final Button btn_ExitApp = (Button) findViewById(R.id.exitApp);</span>
            </div><div id="Par744" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">29.         btn_ExitApp.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par745" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">30.             public void onClick(View v) {</span>
            </div><div id="Par746" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">31.                 exitApp();</span>
            </div><div id="Par747" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32.             }</span>
            </div><div id="Par748" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">33.         });</span>
            </div><div id="Par749" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">34.         final Button btn_StartTaskThread = (Button) findViewById(R.id.startTaskThread);</span>
            </div><div id="Par750" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">35.         btn_StartTaskThread.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par751" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">36.             public void onClick(View v) {</span>
            </div><div id="Par752" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">37.               btn_StartTaskThread.setEnabled(false);</span>
            </div><div id="Par753" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">38.               btn_ExitApp.setEnabled(false);</span>
            </div><div id="Par754" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">39.                  startTask();</span>
            </div><div id="Par755" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">40.              }</span>
            </div><div id="Par756" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">41.         });</span>
            </div><div id="Par757" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">42.         mHandler = new Handler() {</span>
            </div><div id="Par758" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">43.             public void handleMessage(Message msg) {</span>
            </div><div id="Par759" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">44.                switch (msg.what)</span>
            </div><div id="Par760" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">45.                 {</span>
            </div><div id="Par761" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">46.                 case MyTaskThread.MSG_FINISHED:</span>
            </div><div id="Par762" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">47.                     end_time = System.currentTimeMillis();</span>
            </div><div id="Par763" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">48.                     time = end_time - start_time;</span>
            </div><div id="Par764" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">49.                     String s = "Run End</span>,<span class="EmphasisFontCategoryNonProportional">Pi="+ MyTaskThread.pi+ "  Time spent:"</span>
            </div><div id="Par765" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">50.                             + MyTaskThread.msTimeToDatetime(time);</span>
            </div><div id="Par766" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">51.                     tv_TaskOutputInfo.setText(s);</span>
            </div><div id="Par767" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">52.                     btn_ExitApp.setEnabled(true);</span>
            </div><div id="Par768" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">53.                     break;</span>
            </div><div id="Par769" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">54.                 default:</span>
            </div><div id="Par770" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">55.                     break;</span>
            </div><div id="Par771" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">56.                 }</span>
            </div><div id="Par772" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">57.             }</span>
            </div><div id="Par773" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">58.         };</span>
            </div><div id="Par774" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">59.     }</span>
            </div><div id="Par775" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">60.</span>
            </div><div id="Par776" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">61.     @Override</span>
            </div><div id="Par777" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">62.     public boolean onCreateOptionsMenu(Menu menu) {</span>
            </div><div id="Par778" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">63.         getMenuInflater().inflate(R.menu.activity_main, menu);</span>
            </div><div id="Par779" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">return true;</span>
            </div><div id="Par780" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">64.     }</span>
            </div><div id="Par781" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">65.</span>
            </div><div id="Par782" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">66.     private void startTask() {</span>
            </div><div id="Par783" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">67.         thrd = new MyTaskThread[MyTaskThread.num_threads];</span>
            </div><div id="Par784" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">68.         start_time = System.currentTimeMillis();</span>
            </div><div id="Par785" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">69.         for( int i=0; i &lt; MyTaskThread.num_threads; i++){</span></span>
            </div><div id="Par786" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">70.             thrd[i] = new MyTaskThread(mHandler);  // Create a thread</span></span>
            </div><div id="Par787" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">71.             thrd[i].setStepStartNum(i);</span></span>
            </div><div id="Par788" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">72.             thrd[i].start();</span></span>
            </div><div id="Par789" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">}</span></span>
            </div><div id="Par790" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">73.     }</span>
            </div><div id="Par791" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">74.</span>
            </div><div id="Par792" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">75.     private void exitApp() {</span>
            </div><div id="Par793" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">76.         for (int i = 0; i &lt; MyTaskThread.num_threads</span></span>
              <span class="EmphasisFontCategoryNonProportional">&amp;&amp;</span>
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">thrd != null; i++) {</span></span>
            </div><div id="Par794" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">77.             try {</span></span>
            </div><div id="Par795" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">78.                 thrd[i].join();   // Wait for thread running to end</span></span>
            </div><div id="Par796" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">79.             } catch (InterruptedException e) {</span></span>
            </div><div id="Par797" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">80.             }</span></span>
            </div><div id="Par798" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">81.         }</span></span>
            </div><div id="Par799" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">82.         finish();</span>
            </div><div id="Par800" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">83.         Process.killProcess(Process.myPid());</span>
            </div><div id="Par801" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par802" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">}</span>
            </div><div id="Par804" class="Para">The code segments in bold are the main difference between this application and the original application. In line 13, the single thread object variable of the original application changes to an array of threads. In lines 67–71, starting a single thread in the original application is changed to starting all the threads in the array and setting the index number of the thread when the app starts. The meaning of the thread number is introduced in the <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> code description. And instead of waiting for the end of a single thread, you wait for the end of the thread array (lines 74–79).</div><div id="Par805" class="Para">After finishing these optimizations, you need to compile, generate, and deploy the application to on the target device, just as you did the original application. You can run the application independently and measure its run time. The computing time is reduced to almost half of its original length.</div><div id="Par806" class="Para">Next you can use Intel GPA to analyze the optimized application (<span class="EmphasisFontCategoryNonProportional">ThreadPi</span>). The analysis process is the same as the process used for SerialPi. The results are shown in Figure <span class="InternalRef"><a href="#Fig22">11-22</a></span>.<div class="Figure" id="Fig22"><div class="MediaObject" id="MO22"><img src="A978-1-4842-0100-8_11_Fig22a_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig22a_HTML.jpg"/><img src="A978-1-4842-0100-8_11_Fig22b_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig22b_HTML.jpg"/><img src="A978-1-4842-0100-8_11_Fig22c_HTML.jpg" alt="A978-1-4842-0100-8_11_Fig22c_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-22.</span><div class="SimplePara">Intel GPA analysis of <span class="EmphasisFontCategoryNonProportional">ThreadPi</span>
                    </div></div></div></div>
            </div><div id="Par807" class="Para">As you can see, when you click the Start button, the calculation (task) threads start running. Both CPU loads raise from low load to 100% capacity. When the calculation is complete, the CPU loads drop back to a low load condition. Unlike in the original application, while the computing task is running, both CPUs are 100% loaded. There is no longer any load rotation. This indicates that the optimized application has two parallel CPUs working at full capacity on the calculation task, which makes the application runs faster.</div></div></div><div id="Sec31" class="Section1 RenderAsSection1"><h2 class="Heading">Summary</h2><div id="Par808" class="Para">This chapter introduced the basic principles of performance optimization, optimization methods, and related tools for Android application development. Because Java is the application development language of choice for Android developers, the optimization tools presented in the previous chapter are mainly for Java. Java applications run in a virtual machine and are inherently slower than C/C++ applications, which are directly compiled and run on hardware instructions. In addition, due to the fundamental nature of C/C++, many developers have more experience with C/C++ applications and have created more optimization tools. As a result, C/C++ development shouldn’t be excluded from Android app development. The next chapter introduces the Android NDK for C/C++ application development along with related optimization methods and optimization tools.</div></div></div></body></html>
