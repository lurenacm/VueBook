<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>NDK and C/C++ Optimization</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="Chap12"><div class="ChapterCopyright">© Ryan Cohen 2014</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Ryan Cohen</span> and </span><span class="Author"><span class="AuthorName">Tao Wang</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Android Application Development for the Intel<sup>®</sup> Platform</span></span><span class="ChapterDOI">10.1007/978-1-4842-0100-8_12</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">12. NDK and C/C++ Optimization</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Ryan Cohen</span><sup>1 <span class="ContactIcon"/></sup> and </span><span class="Author"><span class="AuthorName">Tao Wang</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff1"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">OR, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par2" class="Para">The previous chapter introduced the basic principles of performance optimization, optimization methods, and related tools for Android application development. Because Java is the recommended application development language for Android developers, the optimization tools presented in <span class="ExternalRef"><a href="A978-1-4842-0100-8_11_Chapter.html"><span class="RefSource">Chapter 11</span></a></span> were mainly for Java. However, C/C++ development shouldn’t be excluded from Android app development. This chapter introduce the Android NDK for C/C++ application development along with related optimization methods and optimization tools.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Introduction to JNI</h2><div id="Par3" class="Para">Java applications do not run directly on the hardware—they run in a virtual machine. The source code of an application is not compiled to get hardware instructions, but is instead compiled to allow a virtual machine interpret and execute code. For example, Android applications run in the Dalvik virtual machine (DVM); its compiled code is executable code for the DVM in <span class="EmphasisFontCategoryNonProportional">.dex</span> format. This feature means Java runs on the virtual machine and ensures its cross-platform capability: that is, its “compile once, run anywhere” feature. Dalvik has a just-in-time (JIT) compiler and is optimized to have a low memory requirement.</div><div id="Par4" class="Para">Everything has pros and cons. Java’s cross-platform capability causes it to be less connected to and limits its interaction with the local machine’s internal components, making it difficult to use local machine instructions to take advantage of the machine’s performance potential. It is difficult to use locally based instructions to run a huge existing software library, and this limits its functionality and performance. Starting in Android 4.4 (KitKat), Google introduced Android Runtime (ART), which is an application runtime environment that replaces Dalvik. ART transforms the application’s bytecode into native instructions that are later executed by the device’s runtime environment. ART introduces ahead-of-time (AOT) compilation by performing it when an application is installed.</div><div id="Par5" class="Para">Is there a way to make Java code and native code software collaborate and share resources? The answer is yes, using the Java Native Interface (JNI), which is an implementation method for a Java local operation. JNI is a Java platform defined by the Java standard to interact with the code on the local platform, generally known as the . But this chapter is about the mobile platform; and in order to distinguish it from the mobile cross-development host, we call it the . The interaction between Java Code and native application includes two directions: Java code calling native functions (methods), and local application calls to the Java code. Relatively speaking, the former method is used more in Android application development. So this chapter’s emphasis is on the approach in which Java code calls native functions.</div><div id="Par6" class="Para">Java calls native functions through JNI by having the local method stored in the form of library files. For example, on a Windows platform, the files are in <span class="EmphasisFontCategoryNonProportional">.dll</span> file format, and on Unix/Linux machines, the files are in <span class="EmphasisFontCategoryNonProportional">.so</span> file format. An internal method of calling the local library file enables Java to establish close contact with the local machine: this is called the <span class="EmphasisTypeItalic">system-level</span> approach for various interfaces.</div><div id="Par7" class="Para">JNI usually has two usage scenarios: first, to be able to use legacy code (for example, prior to use C/C++, Delphi and other development tools); second, in order to better, more directly interact with the hardware for better performance.</div><div id="Par8" class="Para">JNI’s general workflow is as follows: Java initiates calls so that the local function’s side code (such as a function written in C/C++) runs. This time the object is passed over from the Java side and run a local function Then the result value is returned to the Java code. Here JNI is an adapter, completing mapping between the variables and functions (Java method) between the Java language and native compiled languages (such as C/C++). Java and C/C++ are very different in terms of function prototype definitions and variable types. In order to make the two match, JNI provides a <span class="EmphasisFontCategoryNonProportional">jni.h</span> file to complete the mapping between them. This process is shown in Figure <span class="InternalRef"><a href="#Fig1">12-1</a></span>.<div class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img src="A978-1-4842-0100-8_12_Fig1_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig1_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-1.</span><div class="SimplePara">JNI general workflow</div></div></div></div>
          </div><div id="Par9" class="Para">The general framework of a C/C++ function call via JNI and a Java program (in particular, an Android application) is as follows:<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par10" class="Para">A method of compiling native declared in a Java class (C/C++ function).</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par11" class="Para">The <span class="EmphasisFontCategoryNonProportional">.java</span> source code file containing the native method is compiled.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par12" class="Para">The <span class="EmphasisFontCategoryNonProportional">javah</span> command generates a <span class="EmphasisFontCategoryNonProportional">.h</span> file, including a function prototype for implementing the native method based on the <span class="EmphasisFontCategoryNonProportional">.class</span> files.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par13" class="Para">C/C++ is used to implement the local method.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par14" class="Para">The recommended method for this step is to first copy the function prototypes in the <span class="EmphasisFontCategoryNonProportional">.h</span> file and then modify the function prototypes and add the function body. In this process, the following points should be noted:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par15" class="Para">The JNI function call must use the C function. If it is a C++ function, do not forget to add the <span class="EmphasisFontCategoryNonProportional">extern</span> C keyword.</div></li><li><div id="Par16" class="Para">Method names should use the following template: <span class="EmphasisFontCategoryNonProportional">Java_package_class_method</span>, or <span class="EmphasisFontCategoryNonProportional">Java_ package name _ class name _ function method name</span>.</div></li></ul></div>
                  </div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><div class="Para">The C/C++ file is compiled into a dynamic library (under Windows, a <span class="EmphasisFontCategoryNonProportional">.dll</span> file; under Unix/Linux, a <span class="EmphasisFontCategoryNonProportional">.so</span> file).</div></div><div class="ClearBoth"> </div></div></div>
          </div><div id="Par18" class="Para">Use the <span class="EmphasisFontCategoryNonProportional">System.loadLibrary()</span> or <span class="EmphasisFontCategoryNonProportional">System.load()</span> method in Java to load the dynamic library that is generated. These two functions are slightly different:<div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par19" class="Para">
                  <span class="EmphasisFontCategoryNonProportional">System.loadLibrary()</span> loads the default directory under the local link library.</div></li><li><div id="Par20" class="Para">
                  <span class="EmphasisFontCategoryNonProportional">System.load()</span>requires an absolute path, depending on the local directory to add a cross-link library.</div></li></ul></div>
          </div><div id="Par21" class="Para">In the first step, Java calls the native C/C++ function; the format is not the same for both C and C++. For example, for Java methods such as non-passing parameters and returning a <span class="EmphasisFontCategoryNonProportional">String</span> class, C and C++ code for the function differ in the following ways: 
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par22" class="Para">C code:</div></li></ul></div>
          </div><div id="Par24" class="Para ParaTypeProgramcode">
            <span class="EmphasisFontCategoryNonProportional">Call function</span>:<span class="EmphasisFontCategoryNonProportional">(*env) -&gt; &lt;jni function&gt; (env, &lt;parameters&gt;)</span>
          </div><div id="Par25" class="Para ParaTypeProgramcode">
            <span class="EmphasisFontCategoryNonProportional">Return jstring</span>:<span class="EmphasisFontCategoryNonProportional">return (*env)-&gt;NewStringUTF(env, "XXX");</span>
          </div><div id="Par26" class="Para ParaTypeProgramcode">  <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par27" class="Para">C++ code:</div></li></ul></div>
          </div><div id="Par29" class="Para ParaTypeProgramcode">
            <span class="EmphasisFontCategoryNonProportional">Call function</span>:<span class="EmphasisFontCategoryNonProportional">env -&gt; &lt;jni function&gt; (&lt;parameters&gt;)</span>
          </div><div id="Par30" class="Para ParaTypeProgramcode">
            <span class="EmphasisFontCategoryNonProportional">Return jstring</span>:<span class="EmphasisFontCategoryNonProportional">return env-&gt;NewStringUTF("XXX");</span>
          </div><div id="Par32" class="Para">
            <span class="EmphasisFontCategoryNonProportional">NewStringUTF</span> is the Java <span class="EmphasisFontCategoryNonProportional">String</span> object’s function generated in C/C++, provided by JNI.</div><div id="Sec2" class="Section2 RenderAsSection2"><h3 class="Heading">Java Methods and C Function Prototype Java</h3><div id="Par33" class="Para">Earlier you saw that in the code framework for Java programs to call a C/C++ function, you can use the <span class="EmphasisFontCategoryNonProportional">javah</span> command, which generates the corresponding <span class="EmphasisFontCategoryNonProportional">.h</span> file for native methods based on the <span class="EmphasisFontCategoryNonProportional">.class</span> files. The <span class="EmphasisFontCategoryNonProportional">.h</span> file is generated in accordance with certain rules, to make the correct Java code to find the corresponding C function to execute. Another good solution is to use <span class="EmphasisFontCategoryNonProportional">env</span>-&gt;<span class="EmphasisFontCategoryNonProportional">RegisterNatives</span> function to manually do the mapping and avoid using <span class="EmphasisFontCategoryNonProportional">javah</span>.</div><div id="Par34" class="Para">For example, suppose you have the following Java code for Android:</div><div id="Par36" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">    public class HelloJni extends Activity</span>
            </div><div id="Par37" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  {</span>
            </div><div id="Par38" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.      public void onCreate(Bundle savedInstanceState)</span>
            </div><div id="Par39" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.      {</span>
            </div><div id="Par40" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.          TextView tv.setText(stringFromJNI() );  // Use C function Code</span>
            </div><div id="Par41" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.      }</span>
            </div><div id="Par42" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">6.      public native String  stringFromJNI();</span></span>
            </div><div id="Par43" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7.  }</span>
            </div><div id="Par45" class="Para">For the C functions <span class="EmphasisFontCategoryNonProportional">stringFromJNI()</span> used on line 4, the function prototype in the <span class="EmphasisFontCategoryNonProportional">.h</span> file generated by <span class="EmphasisFontCategoryNonProportional">javah</span> is</div><div id="Par47" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  JNIEXPORT jstring JNICALL Java_com_example_hellojni_HelloJni_stringFromJNI</span>
            </div><div id="Par48" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.    (JNIEnv *, jobject);</span>
            </div><div id="Par50" class="Para">The C source code files to define the function code are roughly as follows:</div><div id="Par52" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  /*</span>
            </div><div id="Par53" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  ......</span>
            </div><div id="Par54" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  Signature: ()Ljava/lang/String;</span>
            </div><div id="Par55" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.  */</span>
            </div><div id="Par56" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.  jstring Java_com_example_hellojni_HelloJni_stringFromJNI (JNIEnv* env,  jobject thiz )</span>
            </div><div id="Par57" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.    {</span>
            </div><div id="Par58" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7.      ......</span>
            </div><div id="Par59" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.      return (*env)-&gt;NewStringUTF(env, "......");</span>
            </div><div id="Par60" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.  }</span>
            </div><div id="Par62" class="Para">From this code, you can see that the function name is quite long but still regular, in full accordance with the naming convention <span class="EmphasisFontCategoryNonProportional">java_package_class_method</span>. That is, the <span class="EmphasisFontCategoryNonProportional">stringFromJNI()</span> method in <span class="EmphasisFontCategoryNonProportional">Hello.java</span> corresponds to the <span class="EmphasisFontCategoryNonProportional">Java_com_example_hellojni_HelloJni_stringFromJNI()</span> method in C/C++.</div><div id="Par63" class="Para">Notice the comment for <span class="EmphasisFontCategoryNonProportional">Signature</span>: <span class="EmphasisFontCategoryNonProportional">()Ljava/lang/String;</span>. Here the <span class="EmphasisFontCategoryNonProportional">()</span> in <span class="EmphasisFontCategoryNonProportional">()Ljava/lang/String;</span> indicates the function parameter is empty, which means, other than the two parameters <span class="EmphasisFontCategoryNonProportional">JNIEnv *</span> and <span class="EmphasisFontCategoryNonProportional">jobject</span>, there are no other parameters. <span class="EmphasisFontCategoryNonProportional">JNIEnv *</span> and <span class="EmphasisFontCategoryNonProportional">jobject</span> are two parameters that all JNI functions must have for the JNI environment and corresponding Java class (or object), respectively. <span class="EmphasisFontCategoryNonProportional">Ljava/lang/String;</span> indicates that the function’s return value is a Java <span class="EmphasisFontCategoryNonProportional">String</span> object.</div><div id="Sec3" class="Section3 RenderAsSection3"><h4 class="Heading">Java and C Data Type Mapping</h4><div id="Par64" class="Para">As mentioned, Java and C/C++ have very different variable types. In order to make the two match, JNI provides a mechanism to complete the mapping between Java and C/C++. The relationships of the main types are shown in Table <span class="InternalRef"><a href="#Tab1">12-1</a></span>.<div id="Tab1" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 12-1.</span><div class="SimplePara">The Correspondence between Java Types and Local (C/C++) Types</div></div></div><table border="1"><colgroup><col/><col/><col/></colgroup><thead><tr class="header"><th><div class="SimplePara">Java Type</div></th><th><div class="SimplePara">Native Type</div></th><th><div class="SimplePara">Description</div></th></tr></thead><tbody><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">boolean</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jboolean</span>
                          </div></td><td><div class="SimplePara">C/C++ 8-bit integer</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">byte</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jbyte</span>
                          </div></td><td><div class="SimplePara">C/C++ unsigned 8-bit integer</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">char</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jchar</span>
                          </div></td><td><div class="SimplePara">C/C++ unsigned 16-bit integer</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">short</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jshort</span>
                          </div></td><td><div class="SimplePara">C/C++ signed 16-bit integer</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">int</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jint</span>
                          </div></td><td><div class="SimplePara">C/C++ signed 32-bit integer</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">long</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jlong</span>
                          </div></td><td><div class="SimplePara">C/C++ unsigned 64-bit integer</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">float</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jfloat</span>
                          </div></td><td><div class="SimplePara">C/C++ 32-bit floating point</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">double</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jdouble</span>
                          </div></td><td><div class="SimplePara">C/C++ 64-bit floating point</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">void</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">void</span>
                          </div></td><td><div class="SimplePara">N/A</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">Object</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jobject</span>
                          </div></td><td><div class="SimplePara">Any Java object, or does not correspond to an object of Java type</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">Class</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jclass</span>
                          </div></td><td><div class="SimplePara">Class object</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">String</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jstring</span>
                          </div></td><td><div class="SimplePara">String object</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">Object[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jobjectArray</span>
                          </div></td><td><div class="SimplePara">Array of any object</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">boolean[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jbooleanArray</span>
                          </div></td><td><div class="SimplePara">Boolean array</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">byte[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jbyteArray</span>
                          </div></td><td><div class="SimplePara">Array of bits</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">char[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jcharArray</span>
                          </div></td><td><div class="SimplePara">Character array</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">short[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jshortArray</span>
                          </div></td><td><div class="SimplePara">Short integer array</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">int[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jintArray</span>
                          </div></td><td><div class="SimplePara">Integer array</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">long[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jlongArray</span>
                          </div></td><td><div class="SimplePara">Long integer array</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">float[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jfloatArray</span>
                          </div></td><td><div class="SimplePara">Floating-point array</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">double[]</span>
                          </div></td><td><div class="SimplePara">
                            <span class="EmphasisFontCategoryNonProportional">jdoubleArray</span>
                          </div></td><td><div class="SimplePara">Double floating-point array</div></td></tr></tbody></table></div>
              </div><div id="Par65" class="Para">When a Java parameter is passed, you can use C code as follows:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par66" class="Para">
                      <span class="EmphasisTypeItalic">Basic types can be used directly</span>: For example, <span class="EmphasisFontCategoryNonProportional">double</span> and <span class="EmphasisFontCategoryNonProportional">jdouble</span> are interchangeable. Basic types are those from <span class="EmphasisFontCategoryNonProportional">boolean</span> through <span class="EmphasisFontCategoryNonProportional">void</span> in Table <span class="InternalRef"><a href="#Tab1">12-1</a></span>. In such a type, if the user passes a <span class="EmphasisFontCategoryNonProportional">boolean</span> parameter into the method, then there is a local method <span class="EmphasisFontCategoryNonProportional">jboolean</span> corresponding to the <span class="EmphasisFontCategoryNonProportional">boolean</span> type. Similarly, if the local methods return a <span class="EmphasisFontCategoryNonProportional">jint</span>, then an <span class="EmphasisFontCategoryNonProportional">int</span> is returned in Java.</div></li><li><div id="Par67" class="Para">
                      <span class="EmphasisTypeItalic">Java object usage</span>: An <span class="EmphasisFontCategoryNonProportional">Object</span> object has <span class="EmphasisFontCategoryNonProportional">String</span> objects and a generic object. The two objects are handled a little differently:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par68" class="Para">
                            <span class="EmphasisFontCategoryNonProportional">String</span>
                            <span class="EmphasisTypeItalic">object</span>: The <span class="EmphasisFontCategoryNonProportional">String</span> object passed by Java programs is the corresponding <span class="EmphasisFontCategoryNonProportional">jstring</span> type in the local method. The <span class="EmphasisFontCategoryNonProportional">jstring</span> type and <span class="EmphasisFontCategoryNonProportional">char *</span> in C are different. So if you just use it as a <span class="EmphasisFontCategoryNonProportional">char *</span>, an error will occur. Therefore, <span class="EmphasisFontCategoryNonProportional">jstring</span> nust be converted into a <span class="EmphasisFontCategoryNonProportional">char *</span> in C/C++ prior to use. Here you use the <span class="EmphasisFontCategoryNonProportional">JNIEnv</span> method for conversion.</div></li><li><div id="Par69" class="Para">
                            <span class="EmphasisFontCategoryNonProportional">Object</span>
                            <span class="EmphasisTypeItalic">object</span>: Use the following code to get the object handler for the class:</div></li></ul></div>
                    </div></li></ul></div>
              </div><div id="Par71" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">jclass objectClass = (env)-&gt;FindClass("com/ostrichmyself/jni/Structure");</span>
              </div><div id="Par72" class="Para ParaTypeProgramcode">
                <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par73" class="Para">
                      <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par74" class="Para">Use the following code to get the required domain handler for the class:</div></li></ul></div>
                    </div></li></ul></div>
              </div><div id="Par76" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">jfieldID str = (env)-&gt;GetFieldID(objectClass,"nameString","Ljava/lang/String;");</span>
              </div><div id="Par77" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">jfieldID ival = (env)-&gt;GetFieldID(objectClass,"number","I");</span>
              </div><div id="Par78" class="Para ParaTypeProgramcode">
                <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par79" class="Para">
                      <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par80" class="Para">Then use the following similar code to assign values to the incoming fields of the <span class="EmphasisFontCategoryNonProportional">jobject</span> object:</div></li></ul></div>
                    </div></li></ul></div>
              </div><div id="Par82" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">(env)-&gt;SetObjectField(theObjet,str,(env)-&gt;NewStringUTF("my name is D:"));</span>
              </div><div id="Par83" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">(env)-&gt;SetShortField(theObjet,ival,10);</span>
              </div><div id="Par84" class="Para ParaTypeProgramcode">
                <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par85" class="Para">
                      <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par86" class="Para">If there is no incoming object, then C code can use the following code to generate a new object:</div></li></ul></div>
                    </div></li></ul></div>
              </div><div id="Par88" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">jobject myNewObjet = env-&gt;AllocObject(objectClass);</span>
              </div><div id="FPar1" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">Note</div><div id="Par90" class="Para">
                  <span class="EmphasisFontCategoryNonProportional">NewObject()</span> needs to be called instead if you want the object constructor to be called.</div></div><div id="Sec4" class="Section4 RenderAsSection4"><h5 class="Heading">Java Array Processing</h5><div id="Par91" class="Para">For an array type, JNI provides some operaable functions. For example, <span class="EmphasisFontCategoryNonProportional">GetObjectArrayElement</span> can take the incoming array and use <span class="EmphasisFontCategoryNonProportional">NewObjectArray</span> to create an array structure.</div></div><div id="Sec5" class="Section4 RenderAsSection4"><h5 class="Heading">Resource Release</h5><div id="Par92" class="Para">The principle of resource release is as follows:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par93" class="Para">Objects of C/C++ new or object of malloc need to use the C/C++ to release.</div></li><li><div id="Par94" class="Para">If the new object of the <span class="EmphasisFontCategoryNonProportional">JNIEnv</span> method is not used by Java, it must be released.</div></li><li><div id="Par95" class="Para">To convert a string object from Java to UTF using <span class="EmphasisFontCategoryNonProportional">GetStringUTFChars</span>, you need to open the memory, and you must use <span class="EmphasisFontCategoryNonProportional">ReleaseStringUTFChars</span> method to release the memory after you are finished using <span class="EmphasisFontCategoryNonProportional">char *</span>.</div></li></ul></div>
                </div><div id="Par96" class="Para">These are brief descriptions of the basic ideas of type mapping when Java exchanges data with C/C++. For more information about Java and C/C++ data types, please refer to related Java and JNI books, documentation, and examples.</div></div></div></div><div id="Sec6" class="Section2 RenderAsSection2"><h3 class="Heading">Introduction to NDK</h3><div id="Par97" class="Para">You now know that the Java code can access local functions (such as C/C++) using JNI. To achieve this, you need development tools. As stated earlier, an entire set of development tools based on the core Android SDK are available that you can use to cross-compile Java applications to applications that can run on the target Android device. Similarly, you need cross-development tools to compile C/C++ code into applications that can run on an Android device. This tool is the Android Native Development Kit (NDK), which you can download from <span class="ExternalRef"><a href="http://developer.android.com/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://developer.android.com</span>
                </span></a></span>.</div><div id="Par98" class="Para">Prior to the NDK, third-party applications on the Android platform were developed on a special Java-based DVM. The announcement of the native SDK allows developers to directly access Android system resources and to implement parts of apps using native-code languages such as C and C++. The application package file (<span class="EmphasisFontCategoryNonProportional">.apk</span>) can be directly embedded into the local library. In short, with the NDK, Android applications originally run on the DVM can use native languages like C/C++ for program execution. This brings the following benefits:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par99" class="Para">Performance improvements from using native code to develop parts of programs that require high performance, and by directly accessing the CPU and hardware</div></li><li><div id="Par100" class="Para">The ability to reuse existing native code</div></li></ul></div>
            </div><div id="Par101" class="Para">Of course, compared to the DVM, using native SDK programming also has some disadvantages, such as added program complexity, difficulty in guaranteeing compatibility, the inability to access the Framework API, more difficult debugging, decreased flexibility, and so on. In addition, access to JNI requires additional performance overhead.</div><div id="Par102" class="Para">In short, NDK application development has pros and cons. You need to use NDK at your own discretion. The best strategy is to use NDK to develop parts of the application for which native code will improve performance.</div><div id="Par103" class="Para">NDK includes the following major components:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par104" class="Para">Tools and build file needed to generate native code libraries from C/C++ sources. These include a series of NDK commands, including <span class="EmphasisFontCategoryNonProportional">javah</span> (use the <span class="EmphasisFontCategoryNonProportional">.class</span> files to generate the corresponding <span class="EmphasisFontCategoryNonProportional">.h</span> files) and <span class="EmphasisFontCategoryNonProportional">gcc</span> (described later)</div></li><li><div id="Par105" class="Para">A consistent local library embedded in the application package (<span class="EmphasisFontCategoryNonProportional">.apk</span> files) that can be deployed in Android devices</div></li><li><div id="Par106" class="Para">Support for some native system header files and libraries for all future Android platforms</div></li><li><div id="Par107" class="Para">Documentation, samples, and tutorials</div></li></ul></div>
            </div><div id="Par108" class="Para">The process framework of NDK application development is shown in Figure <span class="InternalRef"><a href="#Fig2">12-2</a></span>. An Android application consists of three parts: Android application files, Java native library files, and dynamic libraries. These three parts are generated from different sources through the respective generation path. For an ordinary Android application, the Android SDK generates Android applications files and Java native library files. The Android NDK generates the dynamic library files (the file with the <span class="EmphasisFontCategoryNonProportional">.so</span> extension) using native code (typically C source code files). Finally, Android application files, Java native library files, and dynamic libraries are installed on the target machine, and complete collaborative applications run.<div class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img src="A978-1-4842-0100-8_12_Fig2_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig2_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-2.</span><div class="SimplePara">Flowchart of Android NDK application development</div></div></div></div>
            </div><div id="Par109" class="Para">Application projects developed with NDK (referred to as <span class="EmphasisTypeItalic">NDK application projects</span>) have the components shown in Figure <span class="InternalRef"><a href="#Fig3">12-3</a></span>. Unlike typical applications developed using the Android SDK, in addition to the Dalvik class code, manifest files, and resources, NDK application projects also include JNI and a shared library generated by NDK.<div class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img src="A978-1-4842-0100-8_12_Fig3_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig3_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-3.</span><div class="SimplePara">Application components for an Android NDK application</div></div></div></div>
            </div><div id="Par110" class="Para">Android adds NDK support in its key API version. Each version includes some new NDK features, simple C/C++, a compatible Standard Template Library (STL), hardware expansion, and so on. These features make Android more open and more powerful. The mapping of the Android API and its corresponding relationship with the NDK are shown in Table <span class="InternalRef"><a href="#Tab2">12-2</a></span>.<div id="Tab2" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 12-2.</span><div class="SimplePara">Relationship between the Main Android API and NDK Versions</div></div></div><table border="1"><colgroup><col/><col/></colgroup><thead><tr class="header"><th><div class="SimplePara">API Version</div></th><th><div class="SimplePara">Supported NDK Version</div></th></tr></thead><tbody><tr class="noclass"><td><div class="SimplePara">API Level 3</div></td><td><div class="SimplePara">Android 1.5 NDK 1</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 4</div></td><td><div class="SimplePara">Android 1.6 NDK 2</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 7</div></td><td><div class="SimplePara">Android 2.1 NDK 3</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 8</div></td><td><div class="SimplePara">Android 2.2 NDK 4</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 9</div></td><td><div class="SimplePara">Android 2.3 NDK 5</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 12</div></td><td><div class="SimplePara">Android 3.1 NDK 6</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 14</div></td><td><div class="SimplePara">Android 4.0.1 NDK 7</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 15</div></td><td><div class="SimplePara">Android 4.0.3 NDK 8</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 16</div></td><td><div class="SimplePara">Android 4.1 NDK 8b</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 16</div></td><td><div class="SimplePara">Android 4.2 NDK 8d</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 17</div></td><td><div class="SimplePara">Android 4.2 NDK 9</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 18</div></td><td><div class="SimplePara">Android 4.3 NDK 9d</div></td></tr><tr class="noclass"><td><div class="SimplePara">API Level 19</div></td><td><div class="SimplePara">Android 4.4 NDK 10</div></td></tr></tbody></table></div>
            </div><div id="FPar2" class="FormalPara FormalParaRenderingStyle1 ParaTypeOverview"><div class="Heading">TIP: THE MEANING OF APPLICATION BINARY INTERFACE (ABI)</div><div id="Par111" class="Para">Each piece of native code generated using the Android NDK is given a matching application binary interface (ABI). The ABI precisely defines how the application and its code interact with the system at runtime. An ABI is roughly like instruction set architecture (ISA) in computer architecture.</div><div id="Par112" class="Para">A typical ABI usually contains the following information:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par113" class="Para">Machine code the CPU instruction set should use</div></li><li><div id="Par114" class="Para">Runtime memory access ranking</div></li><li><div id="Par115" class="Para">The format of executable binary files (dynamic libraries, programs, and so on) as well as what type of content is allowed and supported</div></li><li><div id="Par116" class="Para">Different conventions used in passing data between the application code and systems (for example, when the function call registers and/or how to use the stack, alignment restrictions, and so on)</div></li><li><div id="Par117" class="Para">Alignment and size limits of enumerated types, structure fields, and array</div></li><li><div id="Par118" class="Para">A unique name; the available list of function symbols for application machine code at runtime usually comes from a very specific set of libraries</div></li></ul></div>
              </div><div id="Par119" class="Para">Android currently supports the following ABI types:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par120" class="Para">
                      <span class="EmphasisTypeItalic">armeabi</span>: ABI name for the ARM CPU, which supports at least the ARMv5TE instruction set.</div></li><li><div id="Par121" class="Para">
                      <span class="EmphasisTypeItalic">armeabi-v7a</span>: Another ABI name for ARM-based CPUs; it extends the armeabi CPU instruction set extensions, such as Thumb-2 instruction set extensions and floating-point processing unit directives for vector floating-point hardware.</div></li><li><div id="Par122" class="Para">
                      <span class="EmphasisTypeItalic">x86</span>: ABI name generally known for supporting the x86 or IA-32 instruction set of the CPU. More specifically, its target is often referred to in the following sections as the i686 or Pentium Pro instruction set. Intel Atom processors belong to this ABI type.</div></li><li><div id="Par123" class="Para">
                      <span class="EmphasisTypeItalic">MIPS</span>: ABI for MIPS-based CPUs that support the MIPS32r1 instruction set. The ABI includes the following features: MIPS32 revision 1 ISA, little-endian, O32, hard-float, and no DSP applicationThese types have different compatibilities. x86 is incompatible with armeabi and armeabi-v7a. The armeabi-v7a machine is compatible with armeabi, which means the armeabi framework instruction set can run on an armeabi-v7a machine, but not necessarily the other way around, because some ARMv5 and ARMv6 machines do not support armeabi-v7a code. Therefore, when you build the application, users should be chosen carefully based on their corresponding ABI machine type.</div></li></ul></div>
              </div></div></div></div><div id="Sec7" class="Section1 RenderAsSection1"><h2 class="Heading">Installing NDK and Setting Up the Environment</h2><div id="Par124" class="Para">The NDK is included in Intel Beacon Mountain for Linux, Intel Beacon Mountain for OS X and Intel Integrated Native Developer Experience (INDE) for Windows host system, and is installed when you install one of those Intel tools. The installation is detailed in <span class="ExternalRef"><a href="A978-1-4842-0100-8_3_Chapter.html"><span class="RefSource">Chapter 3</span></a></span>. An environment setup program is also included in Intel INDE; you can download it and run the setup automatically.</div><div id="Sec8" class="Section2 RenderAsSection2"><h3 class="Heading">Installing CDT</h3><div id="Par125" class="Para">CDT is an Eclipse plug-in that compiles C code into <span class="EmphasisFontCategoryNonProportional">.so</span> shared libraries. After installing the Cygwin and NDK module, you already can compile C code into <span class="EmphasisFontCategoryNonProportional">.so</span> shared libraries at the command line, which means the core component of Windows NDK is already installed. If you prefer to use the Eclipse IDE rather than a command-line compiler to compile the local library, you need to install the CDT module.</div><div id="Par126" class="Para">If you need to install it, follow these steps.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par127" class="Para">Visit the official Eclipse web site (<span class="ExternalRef"><a href="http://www.eclipse.org/cdt/downloads.php"><span class="RefSource">
                          <span class="EmphasisFontCategoryNonProportional">www.eclipse.org/cdt/downloads.php</span>
                        </span></a></span>) and download the latest CDT package.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par128" class="Para">Start Eclipse. Select Help ➤ Install New Software ➤ Start to install CDT.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par129" class="Para">In the pop-up Install dialog box, click Add.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par130" class="Para">In the pop-up Add Repository dialog box, enter a name.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par131" class="Para">For Location, you can enter the local address or the Internet address. If you use an Internet address, Eclipse goes to the Internet to download and install the package; a local address directs Eclipse to install the software from the local package. In this case, enter the local address; then click the Archive button in the pop-up dialog box and enter the directory and file name for the CDT file you downloaded. If you downloaded it from the Internet, the address is <span class="ExternalRef"><a href="http://download.eclipse.org/tools/cdt/releases/galileo/"><span class="RefSource">
                          <span class="EmphasisFontCategoryNonProportional">http://download.eclipse.org/tools/cdt/releases/galileo/</span>
                        </span></a></span>.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><div id="Par132" class="Para">After returning to the Install dialog box, click to select the software components that need to be installed. In this example, CDT Main Feature is the required component you need to select. A list of detailed information about CDT components to install is displayed, as shown in Figure <span class="InternalRef"><a href="#Fig4">12-4</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img src="A978-1-4842-0100-8_12_Fig4_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig4_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-4.</span><div class="SimplePara">Detailed information for the CDT component installation</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><div id="Par133" class="Para">Review the License dialog box, and click “I accept the terms of the license agreement” to continue.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">8.</span><div class="ItemContent"><div id="Par134" class="Para">The installation process starts. When it is finished, restart Eclipse to complete the installation.</div></div><div class="ClearBoth"> </div></div></div>
            </div></div></div><div id="Sec9" class="Section1 RenderAsSection1"><h2 class="Heading">NDK Examples</h2><div id="Par135" class="Para">This section provides an example to illustrate the use of JNI and NDK. As described previously, NDK can be run from both the command line and in the Eclipse IDE. The example uses both methods to generate the same NDK application.</div><div id="Sec10" class="Section2 RenderAsSection2"><h3 class="Heading">Using the Command Line to Generate a Library File</h3><div id="Par136" class="Para">The app name in this example is <span class="EmphasisFontCategoryNonProportional">jnitest</span>. It is a simple example to demo the JNI code framework. The steps are as follows:<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par137" class="Para">Create an Android app project, compile the code, and generate the <span class="EmphasisFontCategoryNonProportional">.apk</span> package. You first create a project in Eclipse, and name the project <span class="EmphasisFontCategoryNonProportional">jnitest</span>. Choose Build SDK to support the x86 version of the API, as shown in Figure <span class="InternalRef"><a href="#Fig5">12-5</a></span>. For the other options, use the default values. Then generate the project.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img src="A978-1-4842-0100-8_12_Fig5_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig5_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-5.</span><div class="SimplePara">Setting up the <span class="EmphasisFontCategoryNonProportional">jnitest</span> project parameters</div></div></div></div>
            </div><div id="Par138" class="Para">After the project has been generated, the file structure is created as shown in Figure <span class="InternalRef"><a href="#Fig6">12-6</a></span>. Note the directory where the library file (in this case, <span class="EmphasisFontCategoryNonProportional">android.jar</span>) is located, because later steps use this parameter.<div class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img src="A978-1-4842-0100-8_12_Fig6_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig6_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-6.</span><div class="SimplePara">File structure of the <span class="EmphasisFontCategoryNonProportional">jnitest</span>project</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">a.</span><div class="ItemContent"><div id="Par140" class="Para">Modify the Java files to create code using a C function. In this case, the only Java file is <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span>; modify its code as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par142" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  package com.example.jnitest;</span>
            </div><div id="Par143" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  import android.app.Activity;</span>
            </div><div id="Par144" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  import android.widget.TextView;</span>
            </div><div id="Par145" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.  import android.os.Bundle;</span>
            </div><div id="Par146" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.  public class MainActivity extends Activity</span>
            </div><div id="Par147" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.  {</span>
            </div><div id="Par148" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7.      @Override</span>
            </div><div id="Par149" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.      public void onCreate(Bundle savedInstanceState)</span>
            </div><div id="Par150" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.      {</span>
            </div><div id="Par151" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10.         super.onCreate(savedInstanceState);</span>
            </div><div id="Par152" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">11.         TextView tv = new TextView(this);</span></span>
            </div><div id="Par153" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">12.         tv.setText(stringFromJNI() );  // stringFromJNIas a  C function</span></span>
            </div><div id="Par154" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">13.         setContentView(tv);</span></span>
            </div><div id="Par155" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.     }</span>
            </div><div id="Par156" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">15.     public native String stringFromJNI();</span></span>
            </div><div id="Par157" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.</span>
            </div><div id="Par158" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">17.     static {</span></span>
            </div><div id="Par159" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">18.         System.loadLibrary("jnitestmysharelib");</span></span>
            </div><div id="Par160" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">19.     }</span></span>
            </div><div id="Par161" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.  }</span>
            </div><div id="Par163" class="Para">The code is very simple. In lines 11–13, you use a <span class="EmphasisFontCategoryNonProportional">TextView</span> to display a string returned from the <span class="EmphasisFontCategoryNonProportional">stringFromJNI()</span> function. But unlike in the Android application discussed earlier, nowhere in the entire project can you find the implementation code for this function. So where does the function implementation occur? Line 15 declares that the function is not a function written in Java, but is instead written by the local (native) libraries, which means the function is outside of Java. Because it is implemented in the local library, the question is, what libraries? The answers are described in lines 17–20. The parameter of the static function <span class="EmphasisFontCategoryNonProportional">LoadLibrary</span> of the <span class="EmphasisFontCategoryNonProportional">System</span> class describes the name of the library: the library is one of shared libraries in Linux named <span class="EmphasisFontCategoryNonProportional">libjnitestmysharelib.so</span>. The application code declared in the static area will be executed before <span class="EmphasisFontCategoryNonProportional">Activity.onCreate</span>. The library will be loaded into memory at the first use.</div><div id="Par164" class="Para">Interestingly, when the <span class="EmphasisFontCategoryNonProportional">loadLibrary</span> function loads the library name, it automatically adds the <span class="EmphasisFontCategoryNonProportional">lib</span> prefix before the parameters and the <span class="EmphasisFontCategoryNonProportional">.so</span> suffix at the end. Of course, if the name of the library file specified by parameter starts with <span class="EmphasisFontCategoryNonProportional">lib</span>, the function does not add the <span class="EmphasisFontCategoryNonProportional">lib</span> prefix.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">b.</span><div class="ItemContent"><div id="Par166" class="Para">Generate the project in Eclipse. Only build it—do not run it. This compiles the project, but the <span class="EmphasisFontCategoryNonProportional">.apk</span> file is not deployed to the target machine.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par167" class="Para">When this step is completed, the corresponding <span class="EmphasisFontCategoryNonProportional">.class</span> files are generated in the project directory <span class="EmphasisFontCategoryNonProportional">bin\classes\com\example\jnitest</span>. This step must be completed before the next step, because the next step needs to use the appropriate <span class="EmphasisFontCategoryNonProportional">.class</span> files.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par168" class="Para">Create a <span class="EmphasisFontCategoryNonProportional">jni</span> subdirectory in the project root directory. For example, if the project root directory is <span class="EmphasisFontCategoryNonProportional">E:\temp\AndroidDev\workspace\jnitest</span>, then you can use the <span class="EmphasisFontCategoryNonProportional">md</span> command to create the <span class="EmphasisFontCategoryNonProportional">jni</span> subdirectory:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par170" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\jnitest&gt;mkdir jni</span>
            </div><div id="Par172" class="Para">Test whether the directory has been built:</div><div id="Par174" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\jnitest&gt;dir</span>
            </div><div id="Par175" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">......</span>
            </div><div id="Par176" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2013-02-01  00:45    &lt;DIR&gt;          jni</span>
            </div><div class="Para">
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par178" class="Para">Create a C interface file. This is the C function prototype that works with the local (external) function. Specific to this case are the C function prototypes of the <span class="EmphasisFontCategoryNonProportional">stringFromJNI</span> function. You declare in Java that you need to use the prototype of the external function; but it is in the Java format, so you need to change it to C format, which means building a C JNI interface file. This step can be done with the <span class="EmphasisFontCategoryNonProportional">javah</span> command:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par180" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ javah -classpath &lt;directory of jar and .class documents&gt; -d &lt;directory of .h documents&gt;  &lt;the package + class name of class&gt;</span>
            </div><div id="Par182" class="Para">The command parameters are as follows:<div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par183" class="Para">
                    <span class="EmphasisFontCategoryNonProportional">-classpath</span>: The class path</div></li><li><div id="Par184" class="Para">
                    <span class="EmphasisFontCategoryNonProportional">-d</span>: The storage directory for the generated header file</div></li><li><div id="Par185" class="Para">
                    <span class="EmphasisFontCategoryNonProportional">&lt;class name&gt;</span>: The complete <span class="EmphasisFontCategoryNonProportional">.class</span> class name of a native function being used, which consists of “the package + class name of class” component.</div></li></ul></div>
            </div><div id="Par186" class="Para">For this example, follow these steps:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">a.</span><div class="ItemContent"><div id="Par188" class="Para">Enter the root directory using the command line (for this example, <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\jnitest</span>).</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">b.</span><div class="ItemContent"><div id="Par189" class="Para">Run the following command:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par191" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:&gt; javah -classpath "D:\Android\android-sdk\platforms\android-15\android.jar";bin/classes  com.example.jnitest.MainActivity</span>
            </div><div id="Par193" class="Para">In this example, the  class of the native function <span class="EmphasisFontCategoryNonProportional">stringFromJNI</span>’s used is <span class="EmphasisFontCategoryNonProportional">MainActivity</span>; and the resulting file after compiling this class is <span class="EmphasisFontCategoryNonProportional">MainActivity.class</span>, which is located in the root directory of the project <span class="EmphasisFontCategoryNonProportional">bin\classes\com\example</span> directory. The first line of the source code file of its class <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span> shows where the package of the class is:</div><div id="Par195" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">package com.example.jnitest;</span>
            </div><div id="Par197" class="Para">Therefore, this is the command: “class name = package name.Class name” (be careful not to use the <span class="EmphasisFontCategoryNonProportional">.class</span> suffix).</div><div id="Par198" class="Para"> first needs to explain the Java library path of the entire package (in this case, the library file is <span class="EmphasisFontCategoryNonProportional">android.jar</span>; its location is at <span class="EmphasisFontCategoryNonProportional">D:\Android\android-sdk\ platforms\android-15\android.jar</span>). Second, it needs to define the target class (<span class="EmphasisFontCategoryNonProportional">MainActivity.class</span>) directory. In this case, it is <span class="EmphasisFontCategoryNonProportional">bin\classes</span> under <span class="EmphasisFontCategoryNonProportional">bin\classes\com\example\MainActivity.class</span>, both separated by semicolons (C).
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">c.</span><div class="ItemContent"><div id="Par200" class="Para">Now the <span class="EmphasisFontCategoryNonProportional">.h</span> file is generated in the current directory (the project root directory). The file defines the C language function interface. You can test the output:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par202" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\jnitest&gt;dir</span>
            </div><div id="Par203" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">......</span>
            </div><div id="Par204" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2013-01-31  22:00         3,556 com_example_jnitest_MainActivity.h</span>
            </div><div id="Par206" class="Para">It is apparent that a new <span class="EmphasisFontCategoryNonProportional">.h</span> file has been generated. The document reads as follows:</div><div id="Par208" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  /* DO NOT EDIT THIS FILE - it is machine generated */</span>
            </div><div id="Par209" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  #include &lt;jni.h&gt;</span>
            </div><div id="Par210" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  /* Header for class com_example_jnitest_MainActivity */</span>
            </div><div id="Par211" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.</span>
            </div><div id="Par212" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.  #ifndef _Included_com_example_jnitest_MainActivity</span>
            </div><div id="Par213" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.  #define _Included_com_example_jnitest_MainActivity</span>
            </div><div id="Par214" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7.  #ifdef __cplusplus</span>
            </div><div id="Par215" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.  extern "C" {</span>
            </div><div id="Par216" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.  #endif</span>
            </div><div id="Par217" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10. #undef com_example_jnitest_MainActivity_MODE_PRIVATE</span>
            </div><div id="Par218" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11. #define com_example_jnitest_MainActivity_MODE_PRIVATE 0L</span>
            </div><div id="Par219" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12. #undef com_example_jnitest_MainActivity_MODE_WORLD_READABLE</span>
            </div><div id="Par220" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13. #define com_example_jnitest_MainActivity_MODE_WORLD_READABLE 1L</span>
            </div><div id="Par221" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14. #undef com_example_jnitest_MainActivity_MODE_WORLD_WRITEABLE</span>
            </div><div id="Par222" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15. #define com_example_jnitest_MainActivity_MODE_WORLD_WRITEABLE 2L</span>
            </div><div id="Par223" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16. #undef com_example_jnitest_MainActivity_MODE_APPEND</span>
            </div><div id="Par224" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17. #define com_example_jnitest_MainActivity_MODE_APPEND 32768L</span>
            </div><div id="Par225" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18. #undef com_example_jnitest_MainActivity_MODE_MULTI_PROCESS</span>
            </div><div id="Par226" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19. #define com_example_jnitest_MainActivity_MODE_MULTI_PROCESS 4L</span>
            </div><div id="Par227" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20. #undef com_example_jnitest_MainActivity_BIND_AUTO_CREATE</span>
            </div><div id="Par228" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21. #define com_example_jnitest_MainActivity_BIND_AUTO_CREATE 1L</span>
            </div><div id="Par229" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22. #undef com_example_jnitest_MainActivity_BIND_DEBUG_UNBIND</span>
            </div><div id="Par230" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23. #define com_example_jnitest_MainActivity_BIND_DEBUG_UNBIND 2L</span>
            </div><div id="Par231" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24. #undef com_example_jnitest_MainActivity_BIND_NOT_FOREGROUND</span>
            </div><div id="Par232" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25. #define com_example_jnitest_MainActivity_BIND_NOT_FOREGROUND 4L</span>
            </div><div id="Par233" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26. #undef com_example_jnitest_MainActivity_BIND_ABOVE_CLIENT</span>
            </div><div id="Par234" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27. #define com_example_jnitest_MainActivity_BIND_ABOVE_CLIENT 8L</span>
            </div><div id="Par235" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">28. #undef com_example_jnitest_MainActivity_BIND_ALLOW_OOM_MANAGEMENT</span>
            </div><div id="Par236" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">29. #define com_example_jnitest_MainActivity_BIND_ALLOW_OOM_MANAGEMENT 16L</span>
            </div><div id="Par237" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">30. #undef com_example_jnitest_MainActivity_BIND_WAIVE_PRIORITY</span>
            </div><div id="Par238" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">31. #define com_example_jnitest_MainActivity_BIND_WAIVE_PRIORITY 32L</span>
            </div><div id="Par239" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32. #undef com_example_jnitest_MainActivity_BIND_IMPORTANT</span>
            </div><div id="Par240" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">33. #define com_example_jnitest_MainActivity_BIND_IMPORTANT 64L</span>
            </div><div id="Par241" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">34. #undef com_example_jnitest_MainActivity_BIND_ADJUST_WITH_ACTIVITY</span>
            </div><div id="Par242" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">35. #define com_example_jnitest_MainActivity_BIND_ADJUST_WITH_ACTIVITY 128L</span>
            </div><div id="Par243" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">36. #undef com_example_jnitest_MainActivity_CONTEXT_INCLUDE_CODE</span>
            </div><div id="Par244" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">37. #define com_example_jnitest_MainActivity_CONTEXT_INCLUDE_CODE 1L</span>
            </div><div id="Par245" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">38. #undef com_example_jnitest_MainActivity_CONTEXT_IGNORE_SECURITY</span>
            </div><div id="Par246" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">39. #define com_example_jnitest_MainActivity_CONTEXT_IGNORE_SECURITY 2L</span>
            </div><div id="Par247" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">40. #undef com_example_jnitest_MainActivity_CONTEXT_RESTRICTED</span>
            </div><div id="Par248" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">41. #define com_example_jnitest_MainActivity_CONTEXT_RESTRICTED 4L</span>
            </div><div id="Par249" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">42. #undef com_example_jnitest_MainActivity_RESULT_CANCELED</span>
            </div><div id="Par250" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">43. #define com_example_jnitest_MainActivity_RESULT_CANCELED 0L</span>
            </div><div id="Par251" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">44. #undef com_example_jnitest_MainActivity_RESULT_OK</span>
            </div><div id="Par252" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">45. #define com_example_jnitest_MainActivity_RESULT_OK -1L</span>
            </div><div id="Par253" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">46. #undef com_example_jnitest_MainActivity_RESULT_FIRST_USER</span>
            </div><div id="Par254" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">47. #define com_example_jnitest_MainActivity_RESULT_FIRST_USER 1L</span>
            </div><div id="Par255" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">48. #undef com_example_jnitest_MainActivity_DEFAULT_KEYS_DISABLE</span>
            </div><div id="Par256" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">49. #define com_example_jnitest_MainActivity_DEFAULT_KEYS_DISABLE 0L</span>
            </div><div id="Par257" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">50. #undef com_example_jnitest_MainActivity_DEFAULT_KEYS_DIALER</span>
            </div><div id="Par258" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">51. #define com_example_jnitest_MainActivity_DEFAULT_KEYS_DIALER 1L</span>
            </div><div id="Par259" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">52. #undef com_example_jnitest_MainActivity_DEFAULT_KEYS_SHORTCUT</span>
            </div><div id="Par260" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">53. #define com_example_jnitest_MainActivity_DEFAULT_KEYS_SHORTCUT 2L</span>
            </div><div id="Par261" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">54. #undef com_example_jnitest_MainActivity_DEFAULT_KEYS_SEARCH_LOCAL</span>
            </div><div id="Par262" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">55. #define com_example_jnitest_MainActivity_DEFAULT_KEYS_SEARCH_LOCAL 3L</span>
            </div><div id="Par263" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">56. #undef com_example_jnitest_MainActivity_DEFAULT_KEYS_SEARCH_GLOBAL</span>
            </div><div id="Par264" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">57. #define com_example_jnitest_MainActivity_DEFAULT_KEYS_SEARCH_GLOBAL 4L</span>
            </div><div id="Par265" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">58. /*</span>
            </div><div id="Par266" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">59.  * Class:     com_example_jnitest_MainActivity</span>
            </div><div id="Par267" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">60.  * Method:    stringFromJNI</span>
            </div><div id="Par268" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">61.  * Signature: ()Ljava/lang/String;</span>
            </div><div id="Par269" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">62. */</span>
            </div><div id="Par270" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">63. JNIEXPORT jstring JNICALL Java_com_example_jnitest_MainActivity_stringFromJNI</span>
            </div><div id="Par271" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">64. (JNIEnv *, jobject);</span>
            </div><div id="Par272" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">65.</span>
            </div><div id="Par273" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">66. #ifdef __cplusplus</span>
            </div><div id="Par274" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">67. }</span>
            </div><div id="Par275" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">68. #endif</span>
            </div><div id="Par276" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">69. #endif</span>
            </div><div id="Par278" class="Para">In this code, pay special attention to lines 63–64, which are C function prototypes of a local function <span class="EmphasisFontCategoryNonProportional">stringFromJNI</span>.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par279" class="Para">Compile the corresponding C file. This is the true realization of a local function (<span class="EmphasisFontCategoryNonProportional">stringFromJNI</span>). The source code file is obtained by modifying the <span class="EmphasisFontCategoryNonProportional">.h</span> file based on the previous steps.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par280" class="Para">Create a new <span class="EmphasisFontCategoryNonProportional">.c</span> file under the <span class="EmphasisFontCategoryNonProportional">jni</span> subdirectory in the project. The file name can be anything; in this case, it is <span class="EmphasisFontCategoryNonProportional">jnitestccode.c</span>. The contents are as follows:</div><div id="Par282" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1. #include &lt;string.h&gt;</span>
            </div><div id="Par283" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2. #include &lt;jni.h&gt;</span>
            </div><div id="Par284" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3. jstring Java_com_example_hellojni_HelloJni_stringFromJNI( JNIEnv* env,  jobject thiz )</span>
            </div><div id="Par285" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4. {</span>
            </div><div id="Par286" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.     return (*env)-&gt;NewStringUTF(env, "Hello from JNI !");  // Newly added code</span>
            </div><div id="Par287" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6. }</span>
            </div><div id="Par289" class="Para">The code that defines the function implementation is very simple. Line 3 is the Java code used in the prototype definition of the function <span class="EmphasisFontCategoryNonProportional">stringFromJNI</span>; it is basically a copy of the corresponding contents of the <span class="EmphasisFontCategoryNonProportional">.h</span> file obtained from lines 63–64 of <span class="EmphasisFontCategoryNonProportional">com_example_jnitest_MainActivity.h</span>), slightly modified to make the point. The prototype formats of this function are fixed; <span class="EmphasisFontCategoryNonProportional">JNIEnv* env</span> and <span class="EmphasisFontCategoryNonProportional">jobject thiz</span> are inherent parameters of JNI. Because the parameter of the <span class="EmphasisFontCategoryNonProportional">stringFromJNI</span> function is empty, there are only two parameters in the generated C function. The role of the code in the fifth line is to return the string “Hello from JNI!” as the return value.</div><div id="Par290" class="Para">The code in line 2 is the header file that contains the JNI function, which is required for any functions that use JNI. As it relates to the string function, line 1 contains the corresponding header file in this case. After completing these steps, the <span class="EmphasisFontCategoryNonProportional">.h</span> file has no use and can be deleted.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par291" class="Para">Create the NDK makefile file in the <span class="EmphasisFontCategoryNonProportional">jni</span> directory. These documents are mainly <span class="EmphasisFontCategoryNonProportional">Android.mk</span> and <span class="EmphasisFontCategoryNonProportional">Application.mk</span>: <span class="EmphasisFontCategoryNonProportional">Android.mk</span> is required, but if you use the default application configuration, you do not need <span class="EmphasisFontCategoryNonProportional">Application.mk</span>. The specific steps are as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">a.</span><div class="ItemContent"><div id="Par292" class="Para">Create a new <span class="EmphasisFontCategoryNonProportional">Android.mk</span> text file under the <span class="EmphasisFontCategoryNonProportional">jni</span> directory in the project. This file is used to tell the compiler about some requirements, such as which C files to compile, what file name to use for compiled code, and so on. Enter the following:</div></div><div class="ClearBoth"> </div></div></div>
                    </div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par294" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1. LOCAL_PATH      := $(call my-dir)</span>
            </div><div id="Par295" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2. include $(CLEAR_VARS)</span>
            </div><div id="Par296" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">3. LOCAL_MODULE    := jnitestmysharelib</span></span>
            </div><div id="Par297" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">4. LOCAL_SRC_FILES := jnitestccode.c</span></span>
            </div><div id="Par298" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5. include $(BUILD_SHARED_LIBRARY)</span>
            </div><div id="Par300" class="Para">Line 3 represents the generated <span class="EmphasisFontCategoryNonProportional">.so</span> file name (identifying each module described in your <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file). It must be consistent with parameter values of the <span class="EmphasisFontCategoryNonProportional">System.loadLibrary</span> function in the Java code. This name must be unique and may not contain any spaces.</div><div id="FPar3" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">Note</div><div id="Par301" class="Para">The build system automatically generates the appropriate prefix and suffix; in other words, if one is the shared library module named <span class="EmphasisFontCategoryNonProportional">jnitestmysharelib</span>, then a <span class="EmphasisFontCategoryNonProportional">libjnitestmysharelib.so</span> file is generated. If you name the library <span class="EmphasisFontCategoryNonProportional">libhello-jni</span>, the compiler does not add a <span class="EmphasisFontCategoryNonProportional">lib</span> prefix and generates <span class="EmphasisFontCategoryNonProportional">libhello-jni.so</span> too.</div></div><div id="Par302" class="Para">The <span class="EmphasisFontCategoryNonProportional">LOCAL_SRC_FILES</span> variable on line 4 must contain the C or C++ source code files to be compiled and packaged into modules. The previous steps create a C file name.</div><div id="FPar4" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">Note</div><div id="Par303" class="Para">You do not have to list the header files and include files here, because the compiler automatically identifies the dependent files for you—just list source code files that are directly passed to the compiler. In addition, the default extension name of C++ source files is <span class="EmphasisFontCategoryNonProportional">.cpp</span>. It is possible to specify a different extension name, as long as you define the <span class="EmphasisFontCategoryNonProportional">LOCAL_DEFAULT_CPP_EXTENSION</span> variable. Don’t forget the period character at the start (<span class="EmphasisFontCategoryNonProportional">.cxx</span>, rather than <span class="EmphasisFontCategoryNonProportional">cxx</span>).</div></div><div id="Par304" class="Para">The previous code in lines 3 and 4 is very important and must be modified for each NDK application based on its configuration. The contents of the other lines can be copied from the example.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">b.</span><div class="ItemContent"><div id="Par306" class="Para">Create an <span class="EmphasisFontCategoryNonProportional">Application.mk</span> text file under the <span class="EmphasisFontCategoryNonProportional">jni</span> directory in the project. This file is used to tell the compiler the specific settings for this application. Enter the following:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par308" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">APP_ABI := x86</span>
            </div><div id="Par310" class="Para">This file is very simple; the object code generated by the application instructions is for 86 architecture, so you can run the application on Intel Atom machines. For <span class="EmphasisFontCategoryNonProportional">APP_ABI</span> parameters, you can use any architecture (x86, armeabi, armeabi-v7a or MIPS) that you want to support.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><div id="Par311" class="Para">Compile the <span class="EmphasisFontCategoryNonProportional">.c</span> file to the <span class="EmphasisFontCategoryNonProportional">.so</span> shared library file. Go to the project root directory (where <span class="EmphasisFontCategoryNonProportional">AndroidManifest.xml</span> is located) and run the <span class="EmphasisFontCategoryNonProportional">ndk-build</span> command:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par313" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\jnitest&gt;ndk-build</span>
            </div><div id="Par314" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">D:/Android/android-ndk-r8d/build/core/add-application.mk:128: Android NDK: WARNING: APP_PLATFORM android-14 is larger than android:minSdkVersion 8 in ./AndroidM</span>
            </div><div id="Par315" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">anifest.xml</span>
            </div><div id="Par316" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">"Compile x86  : jnitestmysharelib &lt;= jnitestccode.c</span>
            </div><div id="Par317" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">SharedLibrary : libjnitestmysharelib.so</span>
            </div><div id="Par318" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">Install       : libjnitestmysharelib.so =&gt; libs/x86/libjnitestmysharelib.so</span>
            </div><div id="Par320" class="Para">This command adds two subdirectories (<span class="EmphasisFontCategoryNonProportional">libs</span> and <span class="EmphasisFontCategoryNonProportional">obj</span>) in the project folder and creates a <span class="EmphasisFontCategoryNonProportional">.so</span> file (command execution information prompt file named <span class="EmphasisFontCategoryNonProportional">libjnitestmysharelib.so</span>) under the <span class="EmphasisFontCategoryNonProportional">obj</span> directory.</div><div id="Par321" class="Para">If these steps do not define the specified ABI in the <span class="EmphasisFontCategoryNonProportional">Application.mk</span> file, the <span class="EmphasisFontCategoryNonProportional">ndk-build</span> command generates object code for the ARM architecture (armeabi). If you want to generate the x86 architecture instructions, you can do so using the <span class="EmphasisFontCategoryNonProportional">ndk-build APP_ABI = x86</span> command to remedy the situation. The architecture of the object code generated by this command is still x86.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><div id="Par322" class="Para">Run the project. Figure <span class="InternalRef"><a href="#Fig7">12-7</a></span> shows the application running on the target device.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img src="A978-1-4842-0100-8_12_Fig7_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig7_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-7.</span><div class="SimplePara">
                      <span class="EmphasisFontCategoryNonProportional">jnitest</span> application interface</div></div></div></div>
            </div></div><div id="Sec11" class="Section2 RenderAsSection2"><h3 class="Heading">Generating a Library File in the IDE</h3><div id="Par323" class="Para">The previous section described the process of compiling C files into dynamic library <span class="EmphasisFontCategoryNonProportional">.so</span> files that can be run on the Android target device. To do this, you run the <span class="EmphasisFontCategoryNonProportional">ndk-build</span> command in the command line. You can also complete this step in the Eclipse IDE.</div><div id="Par324" class="Para">Eclipse supports direct NDK integration. You can install CDT into Eclipse, create an Android project to which you want to add C/C++ code, create a <span class="EmphasisFontCategoryNonProportional">jni</span>/ directory in your project directory, place your C/C++ sources file in the same directory, and put the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file into it—this is a makefile that tells the Android build-system how to build your files.</div><div id="Par325" class="Para">If for some reason, you need to manually build the code, you can use the following process to generate the library files in the IDE. The code in steps 1–7 is exactly the same as in the previous section, except that in step 6, you compile <span class="EmphasisFontCategoryNonProportional">.c</span> files into <span class="EmphasisFontCategoryNonProportional">.so</span> shared library files. This is explained in detail in a moment:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par326" class="Para">Compile the <span class="EmphasisFontCategoryNonProportional">.c</span> file into the <span class="EmphasisFontCategoryNonProportional">.so</span> shared library file. Right-click the project name, select Build Path ➤ Config Build Path, and, in the pop-up dialog box, select the Builders branch. Click the New button in the dialog box, and then; double-click Program in the prompt dialog box. This process is shown in Figure <span class="InternalRef"><a href="#Fig8">12-8</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img src="A978-1-4842-0100-8_12_Fig8_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig8_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-8.</span><div class="SimplePara">Entering parameters settings for the interface to compile C code in Eclipse</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par327" class="Para">In the pop-up Edit Configuration dialog box, for the Main tab settings, enter the following:
<div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par328" class="Para">
                            <span class="EmphasisTypeItalic">Location</span>: The path to the Cygwin <span class="EmphasisFontCategoryNonProportional">bash.exe</span>
                          </div></li><li><div id="Par329" class="Para">
                            <span class="EmphasisTypeItalic">Working Directory</span>: The <span class="EmphasisFontCategoryNonProportional">bin</span> directory of Cygwin</div></li><li><div id="Par330" class="Para">
                            <span class="EmphasisTypeItalic">Arguments</span>:</div></li></ul></div>
                    </div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par332" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">--login -c "cd '/cygdrive/E/temp/Android Dev/workspace/jnitest' &amp;&amp; $ANDROID_NDK_ROOT/ndk-build"</span>
              <div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par335" class="Para">
                    <span class="EmphasisFontCategoryNonProportional">E/temp/Android Dev/workspace/jnitest</span> is the drive letter and path for the project. The settings are shown in Figure <span class="InternalRef"><a href="#Fig9">12-9</a></span>.</div></li></ul></div>
            </div><div class="Para">
              <div class="Figure" id="Fig9"><div class="MediaObject" id="MO9"><img src="A978-1-4842-0100-8_12_Fig9_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig9_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-9.</span><div class="SimplePara">Main tab setting in the Edit Configuration dialog box</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par336" class="Para">Configure the Refresh tab, ensuring that the The Entire Workspace and Recursively Include Sub-folders items are selected, as shown in Figure <span class="InternalRef"><a href="#Fig10">12-10</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig10"><div class="MediaObject" id="MO10"><img src="A978-1-4842-0100-8_12_Fig10_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig10_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-10.</span><div class="SimplePara">Edit Configuration dialog box Refresh tab settings</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par337" class="Para">Reconfigure the Build Options tab. Select During Auto Builds and Specify Working Set of Relevant Resources, as shown in Figure <span class="InternalRef"><a href="#Fig11">12-11</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig11"><div class="MediaObject" id="MO11"><img src="A978-1-4842-0100-8_12_Fig11_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig11_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-11.</span><div class="SimplePara">Edit Configuration dialog box Build Options tab settings</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par338" class="Para">Click the Specify Resources button. In the Edit Working Set dialog box, select the <span class="EmphasisFontCategoryNonProportional">jni</span> directory, as shown in Figure <span class="InternalRef"><a href="#Fig12">12-12</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig12"><div class="MediaObject" id="MO12"><img src="A978-1-4842-0100-8_12_Fig12_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig12_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-12.</span><div class="SimplePara">Select source code and directories where related files are located</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><div id="Par339" class="Para">Save the configuration. It will automatically compile C-related code under the <span class="EmphasisFontCategoryNonProportional">jni</span> directory and output the corresponding <span class="EmphasisFontCategoryNonProportional">.so</span> library files to the project’s <span class="EmphasisFontCategoryNonProportional">libs</span> directory. The <span class="EmphasisFontCategoryNonProportional">libs</span> directory is created automatically. In the Console window, you can see the output of the build is as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par341" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">/cygdrive/d/Android/android-ndk-r8d/build/core/add-application.mk:128: Android NDK: WARNING: APP_PLATFORM android-14 is larger than android:minSdkVersion 8 in ./AndroidManifest.xml</span>
            </div><div id="Par342" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">Cygwin        : Generating dependency file converter script</span>
            </div><div id="Par343" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">Compile x86   : jnitestmysharelib &lt;= jnitestccode.c</span>
            </div><div id="Par344" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">SharedLibrary : libjnitestmysharelib.so</span>
            </div><div id="Par345" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">Install       : libjnitestmysharelib.so =&gt; libs/x86/libjnitestmysharelib.so</span>
            </div></div><div id="Sec12" class="Section2 RenderAsSection2"><h3 class="Heading">Workflow Analysis for NDK Application Development</h3><div id="Par346" class="Para">The process of generating an NDK project as described works naturally to achieve C library integration with Java. You compile <span class="EmphasisFontCategoryNonProportional">.c</span> files into <span class="EmphasisFontCategoryNonProportional">.so</span> shared library files. The intermediate version of the libraries is put into the <span class="EmphasisFontCategoryNonProportional">obj</span> directory, and the final version is put into the <span class="EmphasisFontCategoryNonProportional">libs</span> directory. When this is completed, the project file structure is created as shown in Figure <span class="InternalRef"><a href="#Fig13">12-13</a></span>.<div class="Figure" id="Fig13"><div class="MediaObject" id="MO13"><img src="A978-1-4842-0100-8_12_Fig13_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig13_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-13.</span><div class="SimplePara">The <span class="EmphasisFontCategoryNonProportional">jnitest</span> project structure after NDK library files are generated</div></div></div></div>
            </div><div id="Par347" class="Para">When you run the project, the shared library <span class="EmphasisFontCategoryNonProportional">.so</span> files are in the project directory on the host machine and are packed in a generated <span class="EmphasisFontCategoryNonProportional">.apk</span> file. The <span class="EmphasisFontCategoryNonProportional">.apk</span> file is essentially a compressed file; you can use compression software like WinRAR to view its contents. For this example, you can find the <span class="EmphasisFontCategoryNonProportional">.apk</span> file in the <span class="EmphasisFontCategoryNonProportional">bin</span> subdirectory of the project directory; open it with WinRAR to show the file structure. The content of the <span class="EmphasisFontCategoryNonProportional">lib</span> subdirectory of the <span class="EmphasisFontCategoryNonProportional">.apk</span> is a clone of the content of the project’s <span class="EmphasisFontCategoryNonProportional">lib</span> subdirectory.</div><div id="Par348" class="Para">When the <span class="EmphasisFontCategoryNonProportional">.apk</span> is deployed to the target machine, it is unpacked. The <span class="EmphasisFontCategoryNonProportional">.so</span> files are placed in the <span class="EmphasisFontCategoryNonProportional">/data/dat/XXX/lib</span> directory, where <span class="EmphasisFontCategoryNonProportional">XXX</span> is the application package name. For this example, the directory is <span class="EmphasisFontCategoryNonProportional">/data/data/com.example.jnitest/lib</span>. You can view the file structure of the target machine under the Eclipse DDMS; the file structure for the example is shown in Figure <span class="InternalRef"><a href="#Fig14">12-14</a></span>. If you are interested, you can try it on the command line, using the <span class="EmphasisFontCategoryNonProportional">adb</span> shell command to view the corresponding contents in the target file directory.<div class="Figure" id="Fig14"><div class="MediaObject" id="MO14"><img src="A978-1-4842-0100-8_12_Fig14_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig14_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-14.</span><div class="SimplePara">
                      <span class="EmphasisFontCategoryNonProportional">jnitest</span> application deployment target file structure</div></div></div></div>
            </div><div id="Par349" class="Para">In addition, if you run the <span class="EmphasisFontCategoryNonProportional">jnitest</span> application in an emulator (in this case, the target machine is a virtual machine), you can see the following output in the Eclipse Logcat window:</div><div id="Par351" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1. 07-10 05:43:08.579: E/Trace(6263): error opening trace file: No such file or directory (2)</span>
            </div><div id="Par352" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2. 07-10 05:43:08.729: D/dalvikvm(6263): Trying to load lib /data/data/com.example.jnitest/lib/libjnitestmysharelib.so 0x411e8b30</span>
            </div><div id="Par353" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3. 07-10 05:43:08.838: D/dalvikvm(6263): Added shared lib /data/data/com.example.jnitest/lib/libjnitestmysharelib.so 0x411e8b30</span>
            </div><div id="Par354" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4. 07-10 05:43:08.838: D/dalvikvm(6263): No JNI_OnLoad found in /data/data/com.example.jnitest/lib/libjnitestmysharelib.so 0x411e8b30, skipping init</span>
            </div><div id="Par355" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5. 07-10 05:43:11.773: I/Choreographer(6263): Skipped 143 frames!  The application may be doing too much work on its main thread.</span>
            </div><div id="Par356" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6. 07-10 05:43:12.097: D/gralloc_goldfish(6263): Emulator without GPU emulation detected.</span>
            </div><div id="Par358" class="Para">Lines 2–3 are reminders of the <span class="EmphasisFontCategoryNonProportional">.so</span> shared library loaded in the application.</div></div></div><div id="Sec13" class="Section1 RenderAsSection1"><h2 class="Heading">NDK Compiler Optimization</h2><div id="Par359" class="Para">From the example, you can see that the NDK tool’s core role is to compile source code into a <span class="EmphasisFontCategoryNonProportional">.so</span> library file that can run on an Android machine. The <span class="EmphasisFontCategoryNonProportional">.so</span> library file is put into the <span class="EmphasisFontCategoryNonProportional">lib</span> subdirectory of the project directory, so that when you use Eclipse to deploy applications, you can deploy the library files to the appropriate location on a target device, and the application can using the library function.</div><div id="FPar5" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">Note</div><div id="Par360" class="Para">The nature of the NDK application is to establish a code framework that complies with the JNI standard, to let Java applications use a local function beyond the scope of the virtual machine.</div></div><div id="Par361" class="Para">The key NDK command to compile the source code into a <span class="EmphasisFontCategoryNonProportional">.so</span> library file is <span class="EmphasisFontCategoryNonProportional">ndk-build</span>. This command is not actually a separate command, but an executable script. It calls the <span class="EmphasisFontCategoryNonProportional">make</span> command in the GNU cross-development tools to compile a project; and <span class="EmphasisFontCategoryNonProportional">make</span> calls, for example, the <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler to compile the source code to complete the process, as shown in Figure <span class="InternalRef"><a href="#Fig15">12-15</a></span>. Of course, you can also directly use <span class="EmphasisFontCategoryNonProportional">.so</span> shared libraries developed by third parties that are already in Android applications, thus avoiding the need to write your own library (function code).<div class="Figure" id="Fig15"><div class="MediaObject" id="MO15"><img src="A978-1-4842-0100-8_12_Fig15_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig15_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-15.</span><div class="SimplePara">The working mechanism of NDK tools</div></div></div></div>
          </div><div id="Par362" class="Para">As Figure <span class="InternalRef"><a href="#Fig15">12-15</a></span> shows, the GNU compiler <span class="EmphasisFontCategoryNonProportional">gcc</span> is the core tool in NDK to complete C/C++ source code compilation. <span class="EmphasisFontCategoryNonProportional">gcc</span> is the standard Linux compiler, which can compile and link C, C++, Object-C, FORTRAN, and other source code on the local machine. Not only can the <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler do local compiling, but it can also do cross-compiling. This feature has been used by Android NDK and other embedded development tools. In compiler usage, <span class="EmphasisFontCategoryNonProportional">gcc</span> cross-compiling is compatible with native compiling; that is, command parameters and switches of locally compiled code can essentially be ported without modification to cross-compiling code. Therefore, the <span class="EmphasisFontCategoryNonProportional">gcc</span> compiling method described next is generic for both local and cross-compiling.</div><div id="Par363" class="Para">Chapter 11 mentioned that some optimizations can be done automatically by the compiler, which is referred to as <span class="EmphasisTypeItalic">compiler optimization</span>. For systems based on Intel x86 architecture processors, in addition to the GNU <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler, the Intel C/C++ compiler is also good. Relatively speaking, because the Intel C/C ++ compiler fully utilizes the features of Intel processors, the code-optimization results are better. For Android NDK, both the Intel C/C++ compiler and <span class="EmphasisFontCategoryNonProportional">gcc</span> can complete the C/C++ code compilation. Currently, the Intel C/C ++ compiler provides the appropriate usage mechanisms. Ordinary users need a professional license, whereas <span class="EmphasisFontCategoryNonProportional">gcc</span> is open source, free software and is more readily available. So, this section uses <span class="EmphasisFontCategoryNonProportional">gcc</span> as an experimental tool to explain how to perform C/C++ module compiler optimization for Android applications.</div><div id="Par364" class="Para">The <span class="EmphasisFontCategoryNonProportional">gcc</span> optimization is controlled by options in the compiler switches. Some of these options are machine independent, and some are associated with the machine. This section discusses some important options. Machine-related options are described only if relevant to Intel processors.</div><div id="Sec14" class="Section2 RenderAsSection2"><h3 class="Heading">Machine-Independent Compiler Switch Options</h3><div id="Par365" class="Para">The machine-independent options for <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler switches are the <span class="EmphasisFontCategoryNonProportional">-Ox</span> options, which correspond to different optimization levels. Following are the details.</div><div id="Sec15" class="Section3 RenderAsSection3"><h4 class="Heading">-O or -O1</h4><div id="Par366" class="Para">Level 1 optimization, which is the default level, uses the <span class="EmphasisFontCategoryNonProportional">-O</span> option; the compiler tries to reduce code size and execution time. For large functions, it needs to spend more compiling time and use a large amount of memory resources for optimizing compiling.</div><div id="Par367" class="Para">When the <span class="EmphasisFontCategoryNonProportional">-O</span> option is not used, the compiler’s goal is to reduce the overhead of compiling so that results can be debugged. In this compilation mode, the statement is independent. By inserting a breakpoint interrupt program run between the two statements, you can reassign variables or modify the program counter to jump to other currently executing statements, so you can precisely control the running process and the user can get results when they want to debug. In addition, if the <span class="EmphasisFontCategoryNonProportional">-O</span> option is not used, only declared register variables can have a register allocation.</div><div id="Par368" class="Para">If you specify the <span class="EmphasisFontCategoryNonProportional">-O</span> option, the <span class="EmphasisFontCategoryNonProportional">-fthread-jumps</span> and <span class="EmphasisFontCategoryNonProportional">-fdefer-pop</span> options are turned on. On a machine with a delay slot, the <span class="EmphasisFontCategoryNonProportional">-fdelayed-branch</span> option is turned on. Even for machines that support debugging without a frame pointer, the <span class="EmphasisFontCategoryNonProportional">-fomit-frame-pointer</span> option is turned on. Some machines may also open other options.</div></div><div id="Sec16" class="Section3 RenderAsSection3"><h4 class="Heading">-O2</h4><div id="Par369" class="Para">This option optimizes even more. <span class="EmphasisFontCategoryNonProportional">gcc</span> performs nearly all supported optimizations that do not involve a space-speed tradeoff. As compared to <span class="EmphasisFontCategoryNonProportional">-O</span>, this option increases both compilation time and the performance of the generated code.</div></div><div id="Sec17" class="Section3 RenderAsSection3"><h4 class="Heading">-O3</h4><div id="Par370" class="Para">This option optimizes still more. It turns on all optimizations specified by <span class="EmphasisFontCategoryNonProportional">-O2</span> and also turns on the <span class="EmphasisFontCategoryNonProportional">-finline-functions</span>, <span class="EmphasisFontCategoryNonProportional">-funswitch-loops</span>
                <span class="EmphasisTypeItalic">,</span>
                <span class="EmphasisFontCategoryNonProportional">-fpredictive-commoning</span>, <span class="EmphasisFontCategoryNonProportional">-fgcse-after-reload</span>, <span class="EmphasisFontCategoryNonProportional">-ftree-vectorize</span>, <span class="EmphasisFontCategoryNonProportional">-fvect-cost-model</span>, <span class="EmphasisFontCategoryNonProportional">-ftree-partial-pre</span>, and <span class="EmphasisFontCategoryNonProportional">-fipa-cp-clone</span> options.</div></div><div id="Sec18" class="Section3 RenderAsSection3"><h4 class="Heading">-O0</h4><div id="Par371" class="Para">This option reduces compilation time and makes debugging produce the expected results. This is the default.</div><div id="Par372" class="Para">An automatic <span class="EmphasisFontCategoryNonProportional">inline</span> function is often used as a function-optimization measure. C99 (C language ISO standard developed in 1999) and C++ both support the <span class="EmphasisFontCategoryNonProportional">inline</span> keyword. The <span class="EmphasisFontCategoryNonProportional">inline</span> function uses inline space in exchange for time. The compiler does not compile an inline-described function into a function, but directly expands the code for the function body, thereby eliminating the function call For example, consider the following function:</div><div id="Par374" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">inline long factorial (int i)</span>
              </div><div id="Par375" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par376" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">return factorial_table[i];</span>
              </div><div id="Par377" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par379" class="Para">Here all occurrences of all the code in the <span class="EmphasisFontCategoryNonProportional">factorial()</span> call are replaced with the <span class="EmphasisFontCategoryNonProportional">factorial_table []</span> array references.</div><div id="Par380" class="Para">In the optimizing state, some compilers treat that function as an inline function even if the function does not use inline instructions, if appropriate in the circumstances (such as if the body of the function code is relatively short and the definition is in the header file), in exchange for execution time.</div><div id="Par381" class="Para">
                <span class="EmphasisTypeItalic">Loop unrolling</span> is a classic speed-optimization method and is used by many compilers as the automatic optimization strategy. For example, the following code needs to loop 100 cycles:</div><div id="Par383" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">for (i = 0; i &lt; 100; i++)</span>
              </div><div id="Par384" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par385" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i);</span>
              </div><div id="Par386" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par388" class="Para">At the end of each cycle, the cycle conditions have to be checked to do a comparative judgment. By using a loop-unrolling strategy, the code can be transformed as follows:</div><div id="Par390" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">for (i = 0; i &lt; 100; )</span>
              </div><div id="Par391" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">{</span>
              </div><div id="Par392" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par393" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par394" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par395" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par396" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par397" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par398" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par399" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par400" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par401" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">do_stuff(i); i++;</span>
              </div><div id="Par402" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">}</span>
              </div><div id="Par404" class="Para">The new code reduces the comparison instruction from 100 to 10 times, and the time used to compare conditions can be reduced by 90%.</div><div id="Par405" class="Para">Both methods described here improve the code efficiency and accomplish the optimization of the object code. This is a typical way of optimizing the object code to make it more time efficient</div></div></div><div id="Sec19" class="Section2 RenderAsSection2"><h3 class="Heading">Intel Processor-Related Compiler Switch Options</h3><div id="Par406" class="Para">The <span class="EmphasisFontCategoryNonProportional">m</span> option of <span class="EmphasisFontCategoryNonProportional">gcc</span> is defined for the Intel i386 and x86-64 processor family. The main command options and their effects are shown in Table <span class="InternalRef"><a href="#Tab3">12-3</a></span>.<div id="Tab3" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 12-3.</span><div class="SimplePara">Intel Processor-Related <span class="EmphasisFontCategoryNonProportional">gcc</span> Switch Options</div></div></div><table border="1"><colgroup><col/><col/><col/></colgroup><thead><tr class="header"><th><div class="SimplePara">Switch Option</div></th><th><div class="SimplePara">Notes</div></th><th><div class="SimplePara">Description</div></th></tr></thead><tbody><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-march=cpu-type</span>
                        </div><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-mtune=cpu-type</span>
                        </div></td><td> </td><td><div class="SimplePara">Generates code for the specified type of CPU. <span class="EmphasisFontCategoryNonProportional">cpu-type</span> can be i386, i486, i586, Pentium, i686, Pentium 4, and so on.</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-msse</span>
                        </div></td><td> </td><td rowspan="11"><div class="SimplePara">Compiler automatic vectorization: use or do not use MMX, SSE, and SSE2 instructions. For example, <span class="EmphasisFontCategoryNonProportional">-msse</span> means programming into the instruction, and <span class="EmphasisFontCategoryNonProportional">-mno-sse</span> means not programmed into the SSE instruction.</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-msse2</span>
                        </div></td><td> </td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-msse3</span>
                        </div></td><td> </td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-mssse3</span>
                        </div></td><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">gcc</span>-4.3 new addition</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-msse4.1</span>
                        </div></td><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">gcc</span>-4.3 new addition</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-msse4.2</span>
                        </div></td><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">gcc</span>-4.3 new addition</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-msse4</span>
                        </div></td><td><div class="SimplePara">Include 4.1 and .2,<span class="EmphasisFontCategoryNonProportional">gcc</span>-4.3 new addition</div></td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-mmmx</span>
                        </div></td><td> </td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-mno-sse</span>
                        </div></td><td> </td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-mno-sse2</span>
                        </div></td><td> </td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-mno-mmx</span>
                        </div></td><td> </td></tr><tr class="noclass"><td><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-m32</span>
                        </div><div class="SimplePara">
                          <span class="EmphasisFontCategoryNonProportional">-m64</span>
                        </div></td><td> </td><td><div class="SimplePara">Generate 32/64 machine code.</div></td></tr></tbody></table></div>
            </div><div id="Par407" class="Para">In Table <span class="InternalRef"><a href="#Tab3">12-3</a></span>, <span class="EmphasisFontCategoryNonProportional">-march</span> is the CPU type of the machine, and <span class="EmphasisFontCategoryNonProportional">-mtune</span> is the CPU type that the compiler wants to optimize; by default it is the same as for <span class="EmphasisFontCategoryNonProportional">-march</span>. The <span class="EmphasisFontCategoryNonProportional">-march</span> option is a <span class="EmphasisTypeItalic">tight constraint</span>, and <span class="EmphasisFontCategoryNonProportional">-mtune</span> is a <span class="EmphasisTypeItalic">loose constraint</span>. The <span class="EmphasisFontCategoryNonProportional">-mtune</span> option can provide backward compatibility.</div><div id="Par408" class="Para">For example, a compiler with the options <span class="EmphasisFontCategoryNonProportional">-march = i686</span>
              <span class="EmphasisTypeItalic">,</span>
              <span class="EmphasisFontCategoryNonProportional">-mtune = pentium4</span> is optimized for the Pentium 4 processor but can be run on any i686 as well. And for <span class="EmphasisFontCategoryNonProportional">-mtune = pentium-mmx</span> compiled procedures, the Pentium 4 processor can be run.</div><div id="Par409" class="Para">The following option generates <span class="EmphasisFontCategoryNonProportional">cpu-type</span> instructions that specify the type of machine:</div><div id="Par411" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">-march=cpu-type</span>
            </div><div id="Par413" class="Para">The <span class="EmphasisFontCategoryNonProportional">-mtune = cpu-type</span> option is only available if you are optimizing code generated for <span class="EmphasisFontCategoryNonProportional">cpu-type</span>. By contrast, <span class="EmphasisFontCategoryNonProportional">-march = cpu-type</span> generates code not run on non-<span class="EmphasisFontCategoryNonProportional">gcc</span> for the specified type of processor, which means <span class="EmphasisFontCategoryNonProportional">-march = cpu-type</span> implies the <span class="EmphasisFontCategoryNonProportional">-mtune = cpu-type</span> option.</div><div id="Par414" class="Para">The <span class="EmphasisFontCategoryNonProportional">cpu-type</span> option values related to Intel processors are listed in Table <span class="InternalRef"><a href="#Tab4">12-4</a></span>.<div id="Tab4" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 12-4.</span><div class="SimplePara">The Main Option Values of <span class="EmphasisFontCategoryNonProportional">gcc -march</span> Parameters for <span class="EmphasisFontCategoryNonProportional">cpu-type</span>
                    </div></div></div><table border="1"><colgroup><col/><col/></colgroup><thead><tr class="header"><th><div class="SimplePara">cpu-type Value</div></th><th><div class="SimplePara">Description</div></th></tr></thead><tbody><tr class="noclass"><td><div class="SimplePara">native</div></td><td><div class="SimplePara">Selects the CPU to generate code at compilation time by determining the processor type of the compiling machine. Using <span class="EmphasisFontCategoryNonProportional">-march=native</span> enables all instruction subsets supported by the local machine (hence the result might not run on different machines). Using <span class="EmphasisFontCategoryNonProportional">-mtune=native</span> produces code optimized for the local machine under the constraints of the selected instruction set.</div></td></tr><tr class="noclass"><td><div class="SimplePara">i386</div></td><td><div class="SimplePara">Original Intel i386 CPU.</div></td></tr><tr class="noclass"><td><div class="SimplePara">i486</div></td><td><div class="SimplePara">Intel i486 CPU. (No scheduling is implemented for this chip.)</div></td></tr><tr class="noclass"><td><div class="SimplePara">i586</div></td><td rowspan="2"><div class="SimplePara">Intel Pentium CPU with no MMX support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">Pentium</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium-mmx</div></td><td><div class="SimplePara">Intel Pentium MMX CPU, based on a Pentium core with MMX instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentiumpro</div></td><td><div class="SimplePara">Intel Pentium Pro CPU.</div></td></tr><tr class="noclass"><td><div class="SimplePara">i686</div></td><td><div class="SimplePara">When used with <span class="EmphasisFontCategoryNonProportional">-march</span>, the Pentium Pro instruction set is used, so the code runs on all i686 family chips. When used with <span class="EmphasisFontCategoryNonProportional">-mtune</span>, it has the same meaning as generic.</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium2</div></td><td><div class="SimplePara">Intel Pentium II CPU, based on a Pentium Pro core with MMX instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium3</div></td><td rowspan="2"><div class="SimplePara">Intel Pentium III CPU, based on a Pentium Pro core with MMX and SSE instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium3m</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium-m</div></td><td><div class="SimplePara">Intel Pentium M; low-power version of the Intel Pentium III CPU with MMX, SSE, and SSE2 instruction set support. Used by Intel Centrino-based notebooks.</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium4</div></td><td rowspan="2"><div class="SimplePara">Intel Pentium 4 CPU with MMX, SSE, and SSE2 instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">pentium4m</div></td></tr><tr class="noclass"><td><div class="SimplePara">prescott</div></td><td><div class="SimplePara">Improved version of Intel Pentium 4 CPU with MMX, SSE, SSE2, and SSE3 instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">nocona</div></td><td><div class="SimplePara">Improved version of Intel Pentium 4 CPU with 64-bit extensions and MMX, SSE, SSE2, and SSE3 instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">core2</div></td><td><div class="SimplePara">Intel Core 2 CPU with 64-bit extension and MMX, SSE, SSE2, SSE3, and SSSE3 instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">corei7</div></td><td><div class="SimplePara">Intel Core i7 CPU with 64-bit extensions and MMX, SSE, SSE2, SSE3, SSSE3, SSE4.1, and SSE4.2 instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">corei7-avx</div></td><td><div class="SimplePara">Intel Core i7 CPU with 64-bit extensions and MMX, SSE, SSE2, SSE3, SSSE3, SSE4.1, SSE4.2, AVX, AES, and PCLMUL instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">core-avx-i</div></td><td><div class="SimplePara">Intel Core CPU with 64-bit extensions and MMX, SSE, SSE2, SSE3, SSSE3, SSE4.1, SSE4.2, AVX, AES, PCLMUL, FSGSBASE, RDRND, and F16C instruction set support.</div></td></tr><tr class="noclass"><td><div class="SimplePara">atom</div></td><td><div class="SimplePara">Intel Atom CPU with 64-bit extensions and MMX, SSE, SSE2, SSE3, and SSSE3 instruction set and Atom Silvermont (SLM) architecture support.</div></td></tr></tbody></table></div>
            </div><div id="Par415" class="Para">Traditional <span class="EmphasisFontCategoryNonProportional">gcc</span> is a local compiler. These command options can be added to <span class="EmphasisFontCategoryNonProportional">gcc</span> to control <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler options. For example, suppose you have an <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> file:</div><div id="Par417" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc int_sin.c</span>
            </div><div id="Par419" class="Para">This command uses the <span class="EmphasisFontCategoryNonProportional">O1</span> optimization level (default level) and compiles <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> into an executable file named by default <span class="EmphasisFontCategoryNonProportional">a.out</span>.</div><div id="Par420" class="Para">This command uses <span class="EmphasisFontCategoryNonProportional">O1</span> optimization (default level) to compile <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> into an executable file; the executable file name is specified as <span class="EmphasisFontCategoryNonProportional">sinnorm</span>:</div><div id="Par422" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc int_sin.c -o sinnorm</span>
            </div><div id="Par424" class="Para">This command uses <span class="EmphasisFontCategoryNonProportional">O1</span> optimization (default level) to compile <span class="EmphasisFontCategoryNonProportional">int_cos.c</span> into a shared library file <span class="EmphasisFontCategoryNonProportional">coslib.so</span>. Unlike source code files compiled into an executable program, this command requires that the source code file <span class="EmphasisFontCategoryNonProportional">int_cos.c</span> does not contain the main function:</div><div id="Par426" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc int_cos.c -fPIC -shared -o coslib.so</span>
            </div><div id="Par428" class="Para">This command compiles <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> into the executable file with the default file name. The compiler does not perform any optimization:</div><div id="Par430" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc -O0 int_sin.c</span>
            </div><div id="Par432" class="Para">This command uses the highest optimization level <span class="EmphasisFontCategoryNonProportional">O3</span> to compile the <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> file to the executable file with the default file name:</div><div id="Par434" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc -O3 int_sin.c</span>
            </div><div id="Par436" class="Para">This command compiles <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> into an executable file using SSE instructions:</div><div id="Par438" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc -msse int_sin.c</span>
            </div><div id="Par440" class="Para">This command compiles <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> into an executable file without any SSE instructions:</div><div id="Par442" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc -mno-sse int_sin.c</span>
            </div><div id="Par444" class="Para">This command compiles <span class="EmphasisFontCategoryNonProportional">int_sin.c</span> into an executable file that can use Intel Atom processor instructions:</div><div id="Par446" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">$ gcc -mtune=atom int_sin.c</span>
            </div><div id="Par448" class="Para">From the example compiled by <span class="EmphasisFontCategoryNonProportional">gcc</span> locally, you have some experience using the compiler switch options for <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler optimizations. For the <span class="EmphasisFontCategoryNonProportional">gcc</span> native compiler, the <span class="EmphasisFontCategoryNonProportional">gcc</span> command can be used directly in the switch options to achieve compiler optimization. However, from the previous example, you know that the NDK does not directly use the <span class="EmphasisFontCategoryNonProportional">gcc</span> command. Then how do you set the <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler switch option to achieve NDK optimization?</div><div id="Par449" class="Para">Recall that in the NDK example, you used the <span class="EmphasisFontCategoryNonProportional">ndk-build</span> command to compile C/C++ source code; the command first needed to read the makefile <span class="EmphasisFontCategoryNonProportional">Android.Mk</span>. This file contains the <span class="EmphasisFontCategoryNonProportional">gcc</span> command options. <span class="EmphasisFontCategoryNonProportional">Android.mk</span> uses <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> to control and complete the <span class="EmphasisFontCategoryNonProportional">gcc</span> command options. The <span class="EmphasisFontCategoryNonProportional">ndk-build</span> command passes <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> runtime values to <span class="EmphasisFontCategoryNonProportional">gcc</span> as its command option to run the <span class="EmphasisFontCategoryNonProportional">gcc</span> command. <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> passes the values to <span class="EmphasisFontCategoryNonProportional">gcc</span> and uses them as the command option to run <span class="EmphasisFontCategoryNonProportional">gcc</span> commands:</div><div id="Par450" class="Para">For example, in section 3, you amended <span class="EmphasisFontCategoryNonProportional">Android.mk</span> as follows:</div><div id="Par452" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1. LOCAL_PATH      := $(call my-dir)</span>
            </div><div id="Par453" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2. include $(CLEAR_VARS)</span>
            </div><div id="Par454" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3. LOCAL_MODULE    := jnitestmysharelib</span>
            </div><div id="Par455" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4. LOCAL_SRC_FILES := jnitestccode.c</span>
            </div><div id="Par456" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">5. LOCAL_CFLAGS    := -O3</span></span>
            </div><div id="Par457" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6. include $(BUILD_SHARED_LIBRARY)</span>
            </div><div id="Par459" class="Para">Line 5 is new: it sets the <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> variable script.</div><div id="Par460" class="Para">When you execute the <span class="EmphasisFontCategoryNonProportional">ndk-build</span> command, which is equivalent to adding a <span class="EmphasisFontCategoryNonProportional">gcc -O3</span> command option, it instructs <span class="EmphasisFontCategoryNonProportional">gcc</span> to compile the C source code at the highest optimization level, <span class="EmphasisFontCategoryNonProportional">O3</span>. Similarly, if you edit the line 5 to</div><div id="Par462" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS      := -msse3</span>
            </div><div id="Par464" class="Para">you instruct <span class="EmphasisFontCategoryNonProportional">gcc</span> to compile C source code into object code using SSE3 instructions that Intel Atom supports.</div><div id="Par465" class="Para">You can set <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> to a different value and compare the target library file size and content differences. Note that this example <span class="EmphasisFontCategoryNonProportional">jnitest</span> C code is very simple and does not involve complex tasks. As a result, the size and content of the library files are not very different when compiled from different <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> values.</div><div id="Par466" class="Para">Is there an example where there is a significant difference in the size or content of the library file? Yes, as you will see in the following sections.</div></div></div><div id="Sec20" class="Section1 RenderAsSection1"><h2 class="Heading">Optimization with Intel Integrated Performance Primitives (Intel IPP)</h2><div id="Par467" class="Para">Figure <span class="InternalRef"><a href="#Fig15">12-15</a></span> shows that Android applications can bypass NDK development tools and use existing <span class="EmphasisFontCategoryNonProportional">.so</span> shared libraries developed by third parties directly, including third-party shared libraries provided by Intel Integrated Performance Primitives (Intel IPP). Intel IPP is a powerful function library for Intel processors and chipsets, and it covers math, signal processing, multimedia, image and graphics processing, vector computing, and other areas. A prominent feature of Intel IPP is that its code has been extensively optimized based on the features of the Intel processor, using a variety of methods. It is a highly optimized, high-performance service library. Intel IPP has cross-platform features; it provides a set of cross-platform and OS general APIs, which can be used for Windows, Linux, and other operating systems; and it supports embedded, desktop, server, and other processor-scale systems.</div><div id="Par468" class="Para">Intel IPP is really a set of libraries, each with different function areas within the corresponding library, and it differs slightly according to the number of functions supported in different processor architectures. For example, Intel IPP 5.X image-processing functions can support 2,570 functions in Intel architecture, whereas it supports only 1,574 functions in the IXP processor architecture.</div><div id="Par469" class="Para">The services provided by a variety of high-performance libraries, including Intel IPP, are multifaceted and multilayered. Applications can use Intel IPP directly or indirectly. It can provide support not only for applications, but also for other components and libraries.</div><div id="Par470" class="Para">Applications using Intel IPP can use its function interface directly or use sample code to indirectly use Intel IPP. In addition, using the OpenCV library (a cross-platform Open Source Computer Vision Library) is equivalent to indirectly using the Intel IPP library. Both the Intel IPP and Intel MKL libraries run on high-performance Intel processors on various architectures.</div><div id="Par471" class="Para">Taking into account the power of Intel IPP, and in accordance with the characteristics of optimized features of the Intel processor, you can use the Intel IPP library to replace some key source code that runs more often and consumes time. This way, you can obtain much higher performance acceleration than with general code. This is simply a “standing on the shoulders of giants” practical optimization method: you can achieve optimization without manually writing code in critical areas.</div><div id="Par472" class="Para">Intel recently released the Intel Integrated Native Development Experience (INDE), which provides both Intel IPP and Intel Threaded Building Blocks (Intel TBB) for Android application developers. You can easily use Intel IPP, Intel TBB, Intel GPA, and other tools for Android application development.</div></div><div id="Sec21" class="Section1 RenderAsSection1"><h2 class="Heading">NDK Integrated Optimization Examples</h2><div id="Par473" class="Para">This section uses a case study to demonstrate comprehensive optimization techniques by integrating NDK with C/C++. The case is divided into two steps. The first step is to compile a local function from C/C++ code to accelerate the computing tasks in a traditional Java-based program; the second step demonstrates using NDK compiler optimizations to achieve C/C++ optimization. Each step is introduced in its own section; the two sections are closely linked.</div><div id="Sec22" class="Section2 RenderAsSection2"><h3 class="Heading">C/C++: Accelerating the Original Application</h3><div id="Par474" class="Para">The previous chapter introduced a Java code example (<span class="EmphasisFontCategoryNonProportional">SerialPi</span>) that calculates π. In this section, you change the computing tasks from Java to C code, using NDK to turn it into a local library. You then compare it with the original Java code tasks and get some firsthand experience with using C/C++ native library functions to achieve traditional Java-based task acceleration.</div><div id="Par475" class="Para">The application used for this case study is named <span class="EmphasisFontCategoryNonProportional">NdkExp</span>; see Figure <span class="InternalRef"><a href="#Fig16">12-16</a></span>.<div class="Figure" id="Fig16"><div class="MediaObject" id="MO16"><img src="A978-1-4842-0100-8_12_Fig16_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig16_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-16.</span><div class="SimplePara">Original version of <span class="EmphasisFontCategoryNonProportional">NdkExp</span>
                    </div></div></div></div>
            </div><div id="Par476" class="Para">Figure <span class="InternalRef"><a href="#Fig16">12-16(a)</a></span> shows the application’s main interface, including three buttons: Start Java Task, Start C Task, and Exit Application. Clicking the Start Java Task button starts a traditional Java task that calculates π. When the task is completed, the calculated results are displayed below the button along with the time spent, as shown in Figure <span class="InternalRef"><a href="#Fig16">12-16(b)</a></span>. Clicking the Start C Task button starts a computing task written in C, using the same math formula to calculate π. When the task is completed, the calculated results are displayed below the button along with the time spent, as shown in Figure <span class="InternalRef"><a href="#Fig16">12-16(c)</a></span>.</div><div id="Par477" class="Para">For the same task, the application written in traditional Java takes 12.565 seconds to complete; the application written in C and compiled by the NDK development tool takes only 6.378 seconds to complete. This example shows you the power of using NDK to achieve performance optimization.</div><div id="Par478" class="Para">This example is implemented as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par479" class="Para">Generate the project in Eclipse, name it <span class="EmphasisFontCategoryNonProportional">NdkExp</span>, and choose the Build SDK option to support the x86 version of the API. Use the default values for the other options. Then generate the project.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par480" class="Para">Modify the main layout file. Put three <span class="EmphasisFontCategoryNonProportional">TextView</span> widgets and three <span class="EmphasisFontCategoryNonProportional">Button</span> widgets in the layout, set the <span class="EmphasisFontCategoryNonProportional">Text</span> and <span class="EmphasisFontCategoryNonProportional">ID</span> attributes, and adjust their size and position, as shown in Figure <span class="InternalRef"><a href="#Fig17">12-17</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig17"><div class="MediaObject" id="MO17"><img src="A978-1-4842-0100-8_12_Fig17_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig17_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-17.</span><div class="SimplePara">Layout of the original <span class="EmphasisFontCategoryNonProportional">NdkExp</span>
                    </div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par481" class="Para">Modify the main layout of the class source code file <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span> as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par483" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  package com.example.ndkexp;</span>
            </div><div id="Par484" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  import android.os.Bundle;</span>
            </div><div id="Par485" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  import android.app.Activity;</span>
            </div><div id="Par486" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.  import android.view.Menu;</span>
            </div><div id="Par487" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.  import android.widget.Button;</span>
            </div><div id="Par488" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.  import android.view.View;</span>
            </div><div id="Par489" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7.  import android.view.View.OnClickListener;</span>
            </div><div id="Par490" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.  import android.os.Process;</span>
            </div><div id="Par491" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.  import android.widget.TextView;</span>
            </div><div id="Par492" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10. import android.os.Handler;</span>
            </div><div id="Par493" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11. import android.os.Message;</span>
            </div><div id="Par494" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12.</span>
            </div><div id="Par495" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13. public class MainActivity extends Activity {</span>
            </div><div id="Par496" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.     private JavaTaskThread javaTaskThread = null;</span>
            </div><div id="Par497" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.     private CCodeTaskThread cCodeTaskThread = null;</span>
            </div><div id="Par498" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.     private TextView tv_JavaTaskOuputInfo;</span>
            </div><div id="Par499" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.     private TextView tv_CCodeTaskOuputInfo;</span>
            </div><div id="Par500" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.     private Handler mHandler;;</span>
            </div><div id="Par501" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.     private long end_time;</span>
            </div><div id="Par502" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">20.     private long time;</span>
            </div><div id="Par503" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.     private long start_time;</span>
            </div><div id="Par504" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.     @Override</span>
            </div><div id="Par505" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.     public void onCreate(Bundle savedInstanceState) {</span>
            </div><div id="Par506" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.         super.onCreate(savedInstanceState);</span>
            </div><div id="Par507" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.         setContentView(R.layout.activity_main);</span>
            </div><div id="Par508" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.         tv_JavaTaskOuputInfo = (TextView)findViewById(R.id.javaTaskOuputInfo);</span>
            </div><div id="Par509" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27.         tv_JavaTaskOuputInfo.setText("Java the task is not started ");</span>
            </div><div id="Par510" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">28.         tv_CCodeTaskOuputInfo = (TextView)findViewById(R.id.cCodeTaskOuputInfo);</span>
            </div><div id="Par511" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">29.         tv_CCodeTaskOuputInfo.setText("C  code task is not start ");</span>
            </div><div id="Par512" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">30.         final Button btn_ExitApp = (Button) findViewById(R.id.exitApp);</span>
            </div><div id="Par513" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">31.         btn_ExitApp.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par514" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32.             public void onClick(View v) {</span>
            </div><div id="Par515" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">33.                 exitApp();</span>
            </div><div id="Par516" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">34.             }</span>
            </div><div id="Par517" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">35.         });</span>
            </div><div id="Par518" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">36.         final Button btn_StartJavaTask = (Button) findViewById(R.id.startJavaTask);</span>
            </div><div id="Par519" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">37.         final Button btn_StartCCodeTask = (Button) findViewById(R.id.startCCodeTask);</span>
            </div><div id="Par520" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">38.         btn_StartJavaTask.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par521" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">39.             public void onClick(View v) {</span>
            </div><div id="Par522" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">40.                 btn_StartJavaTask.setEnabled(false);</span>
            </div><div id="Par523" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">41.                 btn_StartCCodeTask.setEnabled(false);</span>
            </div><div id="Par524" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">42.                 btn_ExitApp.setEnabled(false);</span>
            </div><div id="Par525" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">43.                 startJavaTask();</span>
            </div><div id="Par526" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">44.             }</span>
            </div><div id="Par527" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">45.         });</span>
            </div><div id="Par528" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">46.         btn_StartCCodeTask.setOnClickListener(new /*View.*/OnClickListener(){</span>
            </div><div id="Par529" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">47.             public void onClick(View v) {</span>
            </div><div id="Par530" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">48.                 btn_StartJavaTask.setEnabled(false);</span>
            </div><div id="Par531" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">49.                 btn_StartCCodeTask.setEnabled(false);</span>
            </div><div id="Par532" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">50.                 btn_ExitApp.setEnabled(false);</span>
            </div><div id="Par533" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">51.                 startCCodeTask();</span>
            </div><div id="Par534" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">52.             }</span>
            </div><div id="Par535" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">53.         });</span>
            </div><div id="Par536" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">54.         mHandler = new Handler() {</span>
            </div><div id="Par537" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">55.             public void handleMessage(Message msg) {</span>
            </div><div id="Par538" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">56.             String s;</span>
            </div><div id="Par539" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">57.                switch (msg.what)</span>
            </div><div id="Par540" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">58.                {</span>
            </div><div id="Par541" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">59.                case JavaTaskThread.MSG_FINISHED:</span>
            </div><div id="Par542" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">60.                     end_time = System.currentTimeMillis();</span>
            </div><div id="Par543" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">61.                     time = end_time - start_time;</span>
            </div><div id="Par544" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">62.                     s = " The return value of the Java task "+ (Double)(msg.obj) +"  Time consumed:"</span>
            </div><div id="Par545" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">63.                          + JavaTaskThread.msTimeToDatetime(time);</span>
            </div><div id="Par546" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">64.                     tv_JavaTaskOuputInfo.setText(s);</span>
            </div><div id="Par547" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">65.                     btn_StartCCodeTask.setEnabled(true);</span>
            </div><div id="Par548" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">66.                     btn_ExitApp.setEnabled(true);</span>
            </div><div id="Par549" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">67.                   break;</span>
            </div><div id="Par550" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">68.                 case CCodeTaskThread.MSG_FINISHED:</span>
            </div><div id="Par551" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">69.                     end_time = System.currentTimeMillis();</span>
            </div><div id="Par552" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">70.                     time = end_time - start_time;</span>
            </div><div id="Par553" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">71.                     s = " The return value of the C code task"+ (Double)(msg.obj) +"  time consumed:"</span>
            </div><div id="Par554" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">72.                          + JavaTaskThread.msTimeToDatetime(time);</span>
            </div><div id="Par555" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">73.                     tv_CCodeTaskOuputInfo.setText(s);</span>
            </div><div id="Par556" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">74.                     btn_StartJavaTask.setEnabled(true);</span>
            </div><div id="Par557" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">75.                     btn_ExitApp.setEnabled(true);</span>
            </div><div id="Par558" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">76.                   break;</span>
            </div><div id="Par559" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">77.                 default:</span>
            </div><div id="Par560" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">78.                   break;</span>
            </div><div id="Par561" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">79.                 }</span>
            </div><div id="Par562" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">80.             }</span>
            </div><div id="Par563" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">81.         };</span>
            </div><div id="Par564" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">82.     }</span>
            </div><div id="Par565" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">83.</span>
            </div><div id="Par566" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">84.     @Override</span>
            </div><div id="Par567" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">85.     public boolean onCreateOptionsMenu(Menu menu) {</span>
            </div><div id="Par568" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">86.        getMenuInflater().inflate(R.menu.activity_main, menu);</span>
            </div><div id="Par569" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">87.        return true;</span>
            </div><div id="Par570" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">88.     }</span>
            </div><div id="Par571" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">89.</span>
            </div><div id="Par572" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">90.     private void startJavaTask() {</span>
            </div><div id="Par573" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">91.         if (javaTaskThread == null)</span>
            </div><div id="Par574" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">92.             javaTaskThread = new JavaTaskThread(mHandler);</span>
            </div><div id="Par575" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">93.         if (! javaTaskThread.isAlive())</span>
            </div><div id="Par576" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">94.         {</span>
            </div><div id="Par577" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">95.                start_time = System.currentTimeMillis();</span>
            </div><div id="Par578" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">96.                javaTaskThread.start();</span>
            </div><div id="Par579" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">97.                tv_JavaTaskOuputInfo.setText("The Java task is running...");</span>
            </div><div id="Par580" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">98.         }</span>
            </div><div id="Par581" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">99.     }</span>
            </div><div id="Par582" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">100.</span>
            </div><div id="Par583" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">101.     private void startCCodeTask() {</span>
            </div><div id="Par584" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">102.         if (cCodeTaskThread == null)</span>
            </div><div id="Par585" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">103.             cCodeTaskThread = new CCodeTaskThread(mHandler);</span>
            </div><div id="Par586" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">104.         if (! cCodeTaskThread.isAlive())</span>
            </div><div id="Par587" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">105.         {</span>
            </div><div id="Par588" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">106.                start_time = System.currentTimeMillis();</span>
            </div><div id="Par589" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">107.                cCodeTaskThread.start();</span>
            </div><div id="Par590" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">108.                tv_CCodeTaskOuputInfo.setText("C code task is running...");</span>
            </div><div id="Par591" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">109.         }</span>
            </div><div id="Par592" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">110.     }</span>
            </div><div id="Par593" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">111.     private void exitApp() {</span>
            </div><div id="Par594" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">112.         try {</span>
            </div><div id="Par595" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">113.             if (javaTaskThread !=null)</span>
            </div><div id="Par596" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">114.             {</span>
            </div><div id="Par597" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">115.                 javaTaskThread.join();</span>
            </div><div id="Par598" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">116.                 javaTaskThread = null;</span>
            </div><div id="Par599" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">117.             }</span>
            </div><div id="Par600" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">118.         } catch (InterruptedException e) {</span>
            </div><div id="Par601" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">119.         }</span>
            </div><div id="Par602" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">120.         try {</span>
            </div><div id="Par603" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">121.             if (cCodeTaskThread  !=null)</span>
            </div><div id="Par604" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">122.             {</span>
            </div><div id="Par605" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">123.                 cCodeTaskThread.join();</span>
            </div><div id="Par606" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">124.                 cCodeTaskThread = null;</span>
            </div><div id="Par607" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">125.             }</span>
            </div><div id="Par608" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">126.         } catch (InterruptedException e) {</span>
            </div><div id="Par609" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">127.         }</span>
            </div><div id="Par610" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">128.         finish();</span>
            </div><div id="Par611" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">129.         Process.killProcess(Process.myPid());</span>
            </div><div id="Par612" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">130.     }</span>
            </div><div id="Par613" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">131.</span>
            </div><div id="Par614" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">132.     static {</span></span>
            </div><div id="Par615" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">133.         System.loadLibrary("ndkexp_extern_lib");</span></span>
            </div><div id="Par616" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">134.     }</span></span>
            </div><div id="Par617" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">135. }</span>
            </div><div id="Par619" class="Para">This code is basically the same as the example code for <span class="EmphasisFontCategoryNonProportional">SerialPi</span>. Only the code in lines 123–134 is ew. This code requires that the <span class="EmphasisFontCategoryNonProportional">libndkexp_extern_lib.so</span> shared library file be loaded before the application runs. The application needs to use local functions in this library.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par620" class="Para">The new thread task class <span class="EmphasisFontCategoryNonProportional">JavaTaskThread</span> in the project is used to calculate π. The code is similar to the <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> class code in the <span class="EmphasisFontCategoryNonProportional">SerialPi</span> example and is omitted here.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par621" class="Para">The thread task class <span class="EmphasisFontCategoryNonProportional">CCodeTaskThread</span> in the new project calls the local function to calculate π; its source code file <span class="EmphasisFontCategoryNonProportional">CCodeTaskThread.java</span> reads as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par623" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  package com.example.ndkexp;</span>
            </div><div id="Par624" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  import android.os.Handler;</span>
            </div><div id="Par625" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  import android.os.Message;</span>
            </div><div id="Par627" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.  public class CCodeTaskThread extends Thread {</span>
            </div><div id="Par628" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.     private Handler mainHandler;</span>
            </div><div id="Par629" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.     public static final int MSG_FINISHED = 2;  // The message after the end of the task</span>
            </div><div id="Par630" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">7.     private native double cCodeTask();   // Calling external C functions to accomplish computing tasks</span></span>
            </div><div id="Par632" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.     static String msTimeToDatetime(long msnum){</span>
            </div><div id="Par633" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.         long hh,mm,ss,ms, tt= msnum;</span>
            </div><div id="Par634" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10.        ms = tt % 1000; tt = tt / 1000;</span>
            </div><div id="Par635" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11.        ss = tt % 60; tt = tt / 60;</span>
            </div><div id="Par636" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12.        mm = tt % 60; tt = tt / 60;</span>
            </div><div id="Par637" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13.        hh = tt % 60;</span>
            </div><div id="Par638" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.        String s = "" + hh +" Hour "+mm+" Minute "+ss + " Second " + ms +" Millisecond ";</span>
            </div><div id="Par639" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.        return s;</span>
            </div><div id="Par640" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.    }</span>
            </div><div id="Par642" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.    @Override</span>
            </div><div id="Par643" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.    public void run()</span>
            </div><div id="Par644" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.    {</span>
            </div><div id="Par645" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">20.        double pi = cCodeTask();   // Calling external C function to complete the calculation</span></span>
            </div><div id="Par646" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.        Message msg = new Message();</span>
            </div><div id="Par647" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.        msg.what = MSG_FINISHED;</span>
            </div><div id="Par648" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.        Double dPi = Double.valueOf(pi);</span>
            </div><div id="Par649" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.        msg.obj = dPi;</span>
            </div><div id="Par650" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.        mainHandler.sendMessage(msg);</span>
            </div><div id="Par651" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.    }</span>
            </div><div id="Par653" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27.    public CCodeTaskThread(Handler mh)</span>
            </div><div id="Par654" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">28.    {</span>
            </div><div id="Par655" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">29.        super();</span>
            </div><div id="Par656" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">30.        mainHandler = mh;</span>
            </div><div id="Par657" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">31.    }</span>
            </div><div id="Par658" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32. }</span>
            </div><div id="Par660" class="Para">This code is similar to the code framework of the <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> class of the <span class="EmphasisFontCategoryNonProportional">SerialPi</span> example. The main difference is at line 20. The original Java code for calculating π is replaced by calling a local function <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> to achieve the task. To indicate that <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> is a local function, you add the <span class="EmphasisFontCategoryNonProportional">local</span> declaration in line 7.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><div id="Par661" class="Para">Build the project in Eclipse. Again, just build, rather than run.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><div id="Par662" class="Para">Create the <span class="EmphasisFontCategoryNonProportional">jni</span> subdirectory in the project root directory.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">8.</span><div class="ItemContent"><div id="Par663" class="Para">Write the C implementation code for the <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> function.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">9.</span><div class="ItemContent"><div id="Par664" class="Para">Compile the file into a <span class="EmphasisFontCategoryNonProportional">.so</span> library file. The main steps are as follows.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">a.</span><div class="ItemContent"><div id="Par665" class="Para">Create a C interface file. Because it is a <span class="EmphasisFontCategoryNonProportional">cCodeTaskThread</span> class using a local function, you need to generate the class header file based on the class file of this class. At the command line, go to the project directory and run the following command:</div></div><div class="ClearBoth"> </div></div></div>
                    </div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par667" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\NdkExp&gt; javah -classpath "D:\Android\android-sdk\platforms\android-15\android.jar";bin/classes com.example.ndkexp.CCodeTaskThread</span>
            </div><div id="Par669" class="Para">This command generates a file in the project directory named <span class="EmphasisFontCategoryNonProportional">com_example_ndkexp_CCodeTaskThread.h</span>. The main content of the document is as follows:</div><div id="Par671" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">......</span>
            </div><div id="Par672" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">23. JNIEXPORT jdouble JNICALL Java_com_example_ndkexp_CCodeTaskThread_cCodeTask</span></span>
            </div><div id="Par673" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">24. (JNIEnv *, jobject);</span></span>
            </div><div id="Par674" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">......</span>
            </div><div id="Par676" class="Para">In lines 23–24, the prototype of the local function <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> is defined.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">b.</span><div class="ItemContent"><div id="Par678" class="Para">Based on these header files, create a corresponding C code file in the <span class="EmphasisFontCategoryNonProportional">jni</span> directory of the project. In this case, name it <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span> it reads as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par680" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  #include &lt;jni.h&gt;</span>
            </div><div id="Par681" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  jdouble Java_com_example_ndkexp_CCodeTaskThread_cCodeTask (JNIEnv* env, jobject thiz )</span>
            </div><div id="Par682" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  {</span>
            </div><div id="Par683" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.      const long num_steps = 100000000;    // The total step length</span>
            </div><div id="Par684" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.      const double step = 1.0 / num_steps;</span>
            </div><div id="Par685" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.      double x, sum = 0.0;</span>
            </div><div id="Par686" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">7.      long i;</span>
            </div><div id="Par687" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.      double pi = 0;</span>
            </div><div id="Par688" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.</span>
            </div><div id="Par689" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10.     for (i=0; i&lt; num_steps; i++){</span>
            </div><div id="Par690" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11.         x = (i+0.5)*step;</span>
            </div><div id="Par691" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11.         sum = sum + 4.0/(1.0 + x*x);</span>
            </div><div id="Par692" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12.     }</span>
            </div><div id="Par693" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13.     pi = step * sum;</span>
            </div><div id="Par694" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.</span>
            </div><div id="Par695" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.     return (pi);</span>
            </div><div id="Par696" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16. }</span>
            </div><div id="Par698" class="Para">Lines 4–16 are the body of the function—the code calculating π, which is the code that corresponds to the <span class="EmphasisFontCategoryNonProportional">MyTaskThread</span> class in <span class="EmphasisFontCategoryNonProportional">SerialPi</span>. It is not difficult to understand. Note that in line 4, the value of the variable <span class="EmphasisFontCategoryNonProportional">num_steps</span> (the total step length) must be the same as the value of the step size the <span class="EmphasisFontCategoryNonProportional">JavaTaskThread</span> class represents. Otherwise, it make no sense to compare the performance here.</div><div id="Par699" class="Para">The first line of each Jni file must contain the headers. Line 2 is the <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> function prototype and is based on slightly modified header files obtained in the previous step.</div><div id="Par700" class="Para">Line 16 returns the results. With the Java <span class="EmphasisFontCategoryNonProportional">double</span> type, which corresponds to the C <span class="EmphasisFontCategoryNonProportional">jdouble</span> type, C can have a <span class="EmphasisFontCategoryNonProportional">pi</span> variable of type <span class="EmphasisFontCategoryNonProportional">double</span> returned directly to it. This is discussed in the introduction to this chapter.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">c.</span><div class="ItemContent"><div id="Par702" class="Para">In the project <span class="EmphasisFontCategoryNonProportional">jni</span> directory, by following the method Section: Using the Command Line Method to Generate a Library File on page 12 of this chapter3, create <span class="EmphasisFontCategoryNonProportional">Android.mk</span> and <span class="EmphasisFontCategoryNonProportional">Application.mk</span> files. The content of <span class="EmphasisFontCategoryNonProportional">Android.mk</span> reads as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par704" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  LOCAL_PATH := $(call my-dir)</span>
            </div><div id="Par705" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  include $(CLEAR_VARS)</span>
            </div><div id="Par706" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">3.  LOCAL_MODULE        := ndkexp_extern_lib</span></span>
            </div><div id="Par707" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">4.  LOCAL_SRC_FILES     := mycomputetask.c</span></span>
            </div><div id="Par708" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.  include $(BUILD_SHARED_LIBRARY)</span>
            </div><div id="Par710" class="Para">Line 4 specifies the C code in the case file. Line 3 indicates the file name of the generated library; its name must be consistent with the parameters of the <span class="EmphasisFontCategoryNonProportional">System.loadLibrary</span> function in line 133 of the project file <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span>.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">d.</span><div class="ItemContent"><div id="Par712" class="Para">Based on the method described in Section: Using the Command Line Method to Generate a Library File on page 12 of this chapter compile the C code into the <span class="EmphasisFontCategoryNonProportional">.so</span> library file under the <span class="EmphasisFontCategoryNonProportional">lib</span> directory of the project.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">10.</span><div class="ItemContent"><div id="Par713" class="Para">Run the project.</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par714" class="Para">The application’s running interface is shown in the next section, in Figure <span class="InternalRef"><a href="#Fig18">12-18</a></span>.</div></div><div id="Sec23" class="Section2 RenderAsSection2"><h3 class="Heading">Extending Compiler Optimization</h3><div id="Par715" class="Para">The example demonstrates the capabilities of NDK for application acceleration. However, the application implements only one local function and is unable to provide information to compare the effects of compiler optimizations. For this purpose, in this section you rebuild the application and use it to experiment with the effects of compiler optimizations; see Figure <span class="InternalRef"><a href="#Fig18">12-18</a></span>.<div class="Figure" id="Fig18"><div class="MediaObject" id="MO18"><img src="A978-1-4842-0100-8_12_Fig18_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig18_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-18.</span><div class="SimplePara">Extended version of <span class="EmphasisFontCategoryNonProportional">NdkExp</span>
                    </div></div></div></div>
            </div><div id="Par716" class="Para">The application has four buttons. When you click the Start Java Task button, the response code does not change. When you click the Start C Task or Start another C Task button, the application starts a local function running.</div><div id="Par717" class="Para">The code (the function body) of the two functions is the same. It calculates the values of π, but using different names. The first button calls the <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> function, and the second button calls the  function. These functions are located in the <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span> and <span class="EmphasisFontCategoryNonProportional">anothertask.c</span> files, respectively, and they correspond to the library files <span class="EmphasisFontCategoryNonProportional">libndkexp_extern_lib.so</span> and <span class="EmphasisFontCategoryNonProportional">libndkexp_another_lib.so</span> after being compiled. In this case, you compile <span class="EmphasisFontCategoryNonProportional">libndkexp_extern_lib.so</span> using the <span class="EmphasisFontCategoryNonProportional">-O0</span> option and <span class="EmphasisFontCategoryNonProportional">libndkexp_another_lib.so</span> using the <span class="EmphasisFontCategoryNonProportional">-O3</span> option, so one is compiled unoptimized and the other is compiled optimized.</div><div id="Par718" class="Para">Clicking Start C Task runs the unoptimized version of the C function, as shown in Figure <span class="InternalRef"><a href="#Fig20">12-20(b)</a></span>; and clicking Start Another C Task runs the optimized version, as shown in Figure <span class="InternalRef"><a href="#Fig20">12-20(c)</a></span>. After task execution, the system displays the calculated results to the consumption of time.</div><div id="Par719" class="Para">As you can see in Figure <span class="InternalRef"><a href="#Fig18">12-18</a></span>, regardless of whether the compiler optimizations are used, the running time of the local function is always shorter than the running time (12.522 seconds) of the Java function. The execution time (5.632 seconds) of the <span class="EmphasisFontCategoryNonProportional">-O3</span> optimization function is less than the execution time (7.321 seconds) of the unoptimized (<span class="EmphasisFontCategoryNonProportional">-O0</span> compiler option) function. From this result comparison, you can see that using compiler optimizations actually reduces application execution time. Not only that, it is even less than the original application running time (6.378 seconds) in section
C/C++: The Original Application Acceleration. This is because the original application without compiler options defaults to the <span class="EmphasisFontCategoryNonProportional">-O1</span> level of optimization, whereas the <span class="EmphasisFontCategoryNonProportional">-O3</span> optimization level is even higher than the original application, so it’s not surprising that it has the shortest running time.</div><div id="Par720" class="Para">This application is a modified and extended version of the original application <span class="EmphasisFontCategoryNonProportional">NdkExp</span>. The steps are as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par721" class="Para">Modify the main layout file. Add a <span class="EmphasisFontCategoryNonProportional">TextView</span> widget and a <span class="EmphasisFontCategoryNonProportional">Button</span> widget in a layout. Set the <span class="EmphasisFontCategoryNonProportional">Text</span> and <span class="EmphasisFontCategoryNonProportional">ID</span> properties, and adjust their size and position, as shown in Figure <span class="InternalRef"><a href="#Fig19">12-19</a></span>.</div></div><div class="ClearBoth"> </div></div></div>
              <div class="Figure" id="Fig19"><div class="MediaObject" id="MO19"><img src="A978-1-4842-0100-8_12_Fig19_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig19_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-19.</span><div class="SimplePara">Extended <span class="EmphasisFontCategoryNonProportional">NdkExp</span> layout</div></div></div></div>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par722" class="Para">Modify the class source code file <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span> of the main layout. The main changes are as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par724" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">...</span>
            </div><div id="Par725" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13.  public class MainActivity extends Activity {</span>
            </div><div id="Par726" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.      private JavaTaskThread javaTaskThread = null;</span>
            </div><div id="Par727" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.      private CCodeTaskThread cCodeTaskThread = null;</span>
            </div><div id="Par728" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">16.      private AnotherCCodeTaskThread anotherCCodeTaskThread = null;</span></span>
            </div><div id="Par729" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.      private TextView tv_JavaTaskOuputInfo;</span>
            </div><div id="Par730" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.      private TextView tv_CCodeTaskOuputInfo;</span>
            </div><div id="Par731" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">19.      private TextView tv_AnotherCCodeTaskOuputInfo;</span></span>
            </div><div id="Par732" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">......</span>
            </div><div id="Par733" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">182.     static {</span></span>
            </div><div id="Par734" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">183.         System.loadLibrary("ndkexp_extern_lib");</span></span>
            </div><div id="Par735" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">184.         System.loadLibrary("ndkexp_another_lib");</span></span>
            </div><div id="Par736" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">185.     }</span></span>
            </div><div id="Par737" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">186. }</span>
            </div><div id="Par739" class="Para">On line 16 and line 19 respectively, add the required variables for the new Start Other C Task button.</div><div id="Par740" class="Para">The key change is in line 184; here, in addition to loading the original shared library files, you also add another library file.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par741" class="Para">In the project, add a thread task class <span class="EmphasisFontCategoryNonProportional">AnotherCCodeTaskThread</span> that calls a local function to calculate π. Its source code file <span class="EmphasisFontCategoryNonProportional">AnotherCCodeTaskThread.java</span> reads as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par743" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  package com.example.ndkexp;</span>
            </div><div id="Par744" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  import android.os.Handler;</span>
            </div><div id="Par745" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  import android.os.Message;</span>
            </div><div id="Par747" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">4.  public class AnotherCCodeTaskThread extends Thread {</span></span>
            </div><div id="Par748" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">5.      private Handler mainHandler;</span>
            </div><div id="Par749" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">6.      public static final int MSG_FINISHED = 3;</span></span>
            </div><div id="Par750" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">// The message after the end of the task</span></span>
            </div><div id="Par751" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">7.      private native double anotherCCodeTask();</span></span>
            </div><div id="Par752" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">// Calling external C functions to complete computing tasks</span></span>
            </div><div id="Par754" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">8.      static String msTimeToDatetime(long msnum){</span>
            </div><div id="Par755" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">9.          long hh,mm,ss,ms, tt= msnum;</span>
            </div><div id="Par756" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">10.         ms = tt % 1000; tt = tt / 1000;</span>
            </div><div id="Par757" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">11.         ss = tt % 60; tt = tt / 60;</span>
            </div><div id="Par758" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">12.         mm = tt % 60; tt = tt / 60;</span>
            </div><div id="Par759" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">13.         hh = tt % 60;</span>
            </div><div id="Par760" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">14.         String s = "" + hh +"Hour "+mm+"Minute "+ss + "Second " + ms +"Millisecond";</span>
            </div><div id="Par761" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">15.         return s;</span>
            </div><div id="Par762" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">16.     }</span>
            </div><div id="Par764" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">17.     @Override</span>
            </div><div id="Par765" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">18.     public void run()</span>
            </div><div id="Par766" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">19.     {</span>
            </div><div id="Par767" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">20.         double pi = anotherCCodeTask();  // Calling external C function to complete the calculation</span></span>
            </div><div id="Par768" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">21.         Message msg = new Message();</span>
            </div><div id="Par769" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">22.         msg.what = MSG_FINISHED;</span>
            </div><div id="Par770" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">23.         Double dPi = Double.valueOf(pi);</span>
            </div><div id="Par771" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">24.         msg.obj = dPi;</span>
            </div><div id="Par772" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">25.         mainHandler.sendMessage(msg);</span>
            </div><div id="Par773" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">26.     }</span>
            </div><div id="Par775" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">27.     public CCodeTaskThread(Handler mh)</span>
            </div><div id="Par776" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">28.     {</span>
            </div><div id="Par777" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">29.         super();</span>
            </div><div id="Par778" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">30.         mainHandler = mh;</span>
            </div><div id="Par779" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">31.     }</span>
            </div><div id="Par780" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">32. }</span>
            </div><div id="Par782" class="Para">This code is almost identical to the code of the <span class="EmphasisFontCategoryNonProportional">CCodeTaskThread</span> class. It does a little processing by calling another external C function <span class="EmphasisFontCategoryNonProportional">anotherCCodeTask</span> to complete computing tasks in line 20. For this, in line 7 it provides appropriate instructions for local functions and changes the value of the message type in line 6. This way, it distinguishes itself from the previous C with a message. Line 4 shows the task class, inherited from the <span class="EmphasisFontCategoryNonProportional">Thread</span> class.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par783" class="Para">Build the project in Eclipse: just a build, not a run.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par784" class="Para">Modify the makefile file of <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span>, and rebuild library files. To do so, first modify the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file under the <span class="EmphasisFontCategoryNonProportional">jni</span> directory of the project, which reads as follows:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par786" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">1.  LOCAL_PATH      := $(call my-dir)</span>
            </div><div id="Par787" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2.  include $(CLEAR_VARS)</span>
            </div><div id="Par788" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">3.  LOCAL_MODULE    := ndkexp_extern_lib</span>
            </div><div id="Par789" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">4.  LOCAL_SRC_FILES := mycomputetask.c</span>
            </div><div id="Par790" class="Para ParaTypeProgramcode">
              <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">5.  LOCAL_CFLAGS    := -O0</span></span>
            </div><div id="Par791" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">6.  include $(BUILD_SHARED_LIBRARY)</span>
            </div><div id="Par793" class="Para">Unlike the original application, in line 5 you add parameters for the command <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> passed to <span class="EmphasisFontCategoryNonProportional">gcc</span>. The value <span class="EmphasisFontCategoryNonProportional">-O0</span> means no optimization.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><div id="Par794" class="Para">compile the C code file into the <span class="EmphasisFontCategoryNonProportional">.so</span> library file in the <span class="EmphasisFontCategoryNonProportional">lib</span> directory of the project.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><div id="Par795" class="Para">Save the <span class="EmphasisFontCategoryNonProportional">.so</span> library files in the <span class="EmphasisFontCategoryNonProportional">lib</span> directory of the project (in this example, the file is <span class="EmphasisFontCategoryNonProportional">libndkexp_extern_lib.so</span>) to some other directory, because the following operations will delete this <span class="EmphasisFontCategoryNonProportional">.so</span> library file.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">8.</span><div class="ItemContent"><div id="Par796" class="Para">Write the C implementation code for the <span class="EmphasisFontCategoryNonProportional">anotherCCodeTask</span> function. Copy the processing steps for the <span class="EmphasisFontCategoryNonProportional">cCodeTask</span> function in the previous section. Using the method in the section “NDK Examples,” compile the file into the <span class="EmphasisFontCategoryNonProportional">.so</span> library file. The main steps are as follows:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">a.</span><div class="ItemContent"><div id="Par797" class="Para">Create a C interface file. At the command line, go to the project directory, and then run the following command:</div></div><div class="ClearBoth"> </div></div></div>
                    </div><div id="Par799" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\NdkExp&gt; javah -classpath "D:\Android\android-sdk\platforms\android-15\android.jar";bin/classes com.example.ndkexp.AnotherCCodeTaskThread</span>
                    </div><div id="Par801" class="Para">This command generates a <span class="EmphasisFontCategoryNonProportional">com_example_ndkexp_AnotherCCodeTaskThread.h</span> file. The main contents of the file are as follows:</div><div id="Par803" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">......</span>
                    </div><div id="Par804" class="Para ParaTypeProgramcode">
                      <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">23. JNIEXPORT jdouble JNICALL Java_com_example_ndkexp_AnotherCCodeTaskThread_anotherCCodeTask</span></span>
                    </div><div id="Par805" class="Para ParaTypeProgramcode">
                      <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">24.   (JNIEnv *, jobject);</span></span>
                    </div><div id="Par806" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">......</span>
                    </div><div id="Par808" class="Para">Lines 23–24 define the local function, which is  prototype.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">b.</span><div class="ItemContent"><div id="Par810" class="Para">Based on the previously mentioned header files in the project <span class="EmphasisFontCategoryNonProportional">Jni</span> directory, establish corresponding C code files, in this case <span class="EmphasisFontCategoryNonProportional">anothertask.c</span>. The content is a modification of <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span>:</div></div><div class="ClearBoth"> </div></div></div>
                    </div><div id="Par812" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">1.  #include &lt;jni.h&gt;</span>
                    </div><div id="Par813" class="Para ParaTypeProgramcode">
                      <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">2.  jdouble Java_com_example_ndkexp_AnotherCCodeTaskThread_anotherCCodeTask (JNIEnv* env,  jobject thiz )</span></span>
                    </div><div id="Par814" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">3.  {</span>
                    </div><div id="Par815" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">......</span>
                    </div><div id="Par816" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">17. }</span>
                    </div><div id="Par818" class="Para">The second line of <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span> is replaced by the prototype of the <span class="EmphasisFontCategoryNonProportional">anotherCCodeTask</span> function. This is the same function prototype copied from that in the <span class="EmphasisFontCategoryNonProportional">.h</span> file created in the previous step, with minor revisions. The final form is in line 2.
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">c.</span><div class="ItemContent"><div id="Par820" class="Para">Modify the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file in the <span class="EmphasisFontCategoryNonProportional">jni</span> directory as follows:</div></div><div class="ClearBoth"> </div></div></div>
                    </div><div id="Par822" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">1.  LOCAL_PATH      := $(call my-dir)</span>
                    </div><div id="Par823" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">2.  include $(CLEAR_VARS)</span>
                    </div><div id="Par824" class="Para ParaTypeProgramcode">
                      <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">3.  LOCAL_MODULE    := ndkexp_another_lib</span></span>
                    </div><div id="Par825" class="Para ParaTypeProgramcode">
                      <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">4.  LOCAL_SRC_FILES := anothertask.c</span></span>
                    </div><div id="Par826" class="Para ParaTypeProgramcode">
                      <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">5.  LOCAL_CFLAGS    := -O3</span></span>
                    </div><div id="Par827" class="Para ParaTypeProgramcode">
                      <span class="EmphasisFontCategoryNonProportional">6.  include $(BUILD_SHARED_LIBRARY)</span>
                    </div><div id="Par829" class="Para">In line 4, the value is replaced with the new C code file <span class="EmphasisFontCategoryNonProportional">anothertask.c</span>. In line 3, the value is replaced with a new library file name consistent with the parameters of the <span class="EmphasisFontCategoryNonProportional">System.loadLibrary</span> function, which is in line 184 of the <span class="EmphasisFontCategoryNonProportional">MainActivity.java</span> file. In line 5, the value of the <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> parameter for the passed <span class="EmphasisFontCategoryNonProportional">gcc</span> command is replaced with <span class="EmphasisFontCategoryNonProportional">-O3</span>, which represents the highest level of optimization.<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">d.</span><div class="ItemContent"><div id="Par831" class="Para">Follow the method described in section 3.1 to compile the C code file into the <span class="EmphasisFontCategoryNonProportional">.so</span> library file under the <span class="EmphasisFontCategoryNonProportional">lib</span> directory of the project. The <span class="EmphasisFontCategoryNonProportional">libndkexp_extern_lib.so</span> documents in the <span class="EmphasisFontCategoryNonProportional">lib</span> directory disappear and are replaced by a newly generated <span class="EmphasisFontCategoryNonProportional">libndkexp_another_lib.so</span> file. So, it is very important to save the library files.</div></div><div class="ClearBoth"> </div></div></div>
                    </div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">9.</span><div class="ItemContent"><div id="Par832" class="Para">Put the previously saved <span class="EmphasisFontCategoryNonProportional">libndkexp_extern_lib.so</span> library file back into the <span class="EmphasisFontCategoryNonProportional">libs</span> directory. There are now two files in the directory. You can use the <span class="EmphasisFontCategoryNonProportional">dir</span> command to verify:</div></div><div class="ClearBoth"> </div></div></div>
            </div><div id="Par834" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">E:\temp\Android Dev\workspace\NdkExp&gt;dir libs\x86</span>
            </div><div id="Par835" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2013-02-28  00:31     5,208 libndkexp_another_lib.so</span>
            </div><div id="Par836" class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">2013-02-28  00:23     5,208 libndkexp_extern_lib.so</span>
              <div class="OrderedList"><div class="ListItem"><span class="ItemNumber">10.</span><div class="ItemContent"><div id="Par838" class="Para">Run the project.</div></div><div class="ClearBoth"> </div></div></div>
            </div></div><div id="Sec24" class="Section2 RenderAsSection2"><h3 class="Heading">Comparing Compiler Optimizations</h3><div id="Par839" class="Para">Through this case study, you have learned the effects of compiler optimization. The task execution time was shortened from 7.321 seconds before optimization to 5.632 seconds after optimization. But you only compared the difference between the <span class="EmphasisFontCategoryNonProportional">gcc -O3</span> and <span class="EmphasisFontCategoryNonProportional">-O0</span> command options in the example. You can extend this configuration by modifying the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file content when compiling the two files <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span> and <span class="EmphasisFontCategoryNonProportional">anothertask.c</span>
              <span class="EmphasisTypeItalic">,</span> and compare the difference in the optimizing effects when using different compiler command options. To modify the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file, you only need to modify the value of the <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS</span> item; you can select many <span class="EmphasisFontCategoryNonProportional">gcc</span> command options to compare. Let’s look at an example.</div><div id="Sec25" class="Section3 RenderAsSection3"><h4 class="Heading">Example 1. Comparing Optimization Results Using SSE Instructions</h4><div id="Par840" class="Para">Compile the Start C Task button corresponding to the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file of <span class="EmphasisFontCategoryNonProportional">mycomputetask.c</span>:</div><div id="Par842" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS := -mno-sse</span>
              </div><div id="Par844" class="Para">And compile the Start other C Task button corresponding to the <span class="EmphasisFontCategoryNonProportional">Android.mk</span> file of <span class="EmphasisFontCategoryNonProportional">anothertask.c</span>:</div><div id="Par846" class="Para ParaTypeProgramcode">
                <span class="EmphasisFontCategoryNonProportional">LOCAL_CFLAGS := -msse3</span>
              </div><div id="Par848" class="Para">The former tells the compiler not to compile SSE instructions; the latter allows the compiler to program into SSE3 instructions. The reason to choose SSE3 instructions is that SSE3 is the highest level of instructions the Intel Atom processor supports.</div><div id="Par849" class="Para">The results of running the application are shown in Figure <span class="InternalRef"><a href="#Fig20">12-20</a></span>.<div class="Figure" id="Fig20"><div class="MediaObject" id="MO20"><img src="A978-1-4842-0100-8_12_Fig20_HTML.jpg" alt="A978-1-4842-0100-8_12_Fig20_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-20.</span><div class="SimplePara">Optimization comparison of compiler SSE instructions for NdkExp</div></div></div></div>
              </div><div id="Par850" class="Para">The same task using an SSE instruction has a shorter execution time than not using an SSE instruction. The execution time is shortened from the original 6.759 seconds to 5.703 seconds.</div><div id="Par851" class="Para">Noted that, in this example, we finished modifying <span class="EmphasisFontCategoryNonProportional">Android.mk</span> and reran <span class="EmphasisFontCategoryNonProportional">ndk-build</span> to generate the <span class="EmphasisFontCategoryNonProportional">.so</span> library file. We immediately deployed and ran the <span class="EmphasisFontCategoryNonProportional">NdkExp</span> project but found out that we could not achieve the desired effect because only the <span class="EmphasisFontCategoryNonProportional">.so</span> library files are updated. The Eclipse project manager does not detect that that the project needs to rebuild. As a result, the <span class="EmphasisFontCategoryNonProportional">.apk</span> was not updated, and <span class="EmphasisFontCategoryNonProportional">NdkExp</span> on the target machine would not run updates or the original code. Considering this situation, you can use the following methods to avoid this problem:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div id="Par852" class="Para">Uninstall the application from the phone.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div id="Par853" class="Para">Delete the three documents <span class="EmphasisFontCategoryNonProportional">classes.dex</span>, <span class="EmphasisFontCategoryNonProportional">jarlist.cache</span>, and <span class="EmphasisFontCategoryNonProportional">NdkExp.apk</span> in the <span class="EmphasisFontCategoryNonProportional">bin</span> subdirectory of the host project directory.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div id="Par854" class="Para">Delete the project in Eclipse.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><div id="Par855" class="Para">In Eclipse, re-import the project.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><div id="Par856" class="Para">Re-deploy and run the projects.</div></div><div class="ClearBoth"> </div></div></div>
              </div><div id="Par857" class="Para">Here you only compared the effect of SSE instructions. You can try other <span class="EmphasisFontCategoryNonProportional">gcc</span> compiler options and compare their operating results.</div><div id="Par858" class="Para">In addition, the previous examples are only concerned with the NDK effect, so the C functions still use single-threaded code. You can combine the NDK optimization knowledge from this chapter with the multithreading optimization from the previous chapter and change the C function to multithreading, and implement it along with the compiler optimization. Such a set of written optimization techniques in a variety of applications will allow the applications to run faster.</div></div></div></div><div id="Sec26" class="Section1 RenderAsSection1"><h2 class="Heading">Summary</h2><div id="Par859" class="Para">This chapter introduced the Android NDK for C/C++ application development, along with related optimization methods, and optimization tools. The Intel mobile hardware and software provide a basis for low-power design. The Intel Atom processor provides hardware support for low power, which is a major feature of the Android operating system.</div><div id="Par860" class="Para">The next chapter presents an overview of low-power design. It also discusses the Android power-control mechanisms and how to achieve the goal of low-power application design.</div></div></div></body></html>
