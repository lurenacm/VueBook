<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Authenticating Web Services</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="Chap11"><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">R. Nigel Horspool</span> and </span><span class="Author"><span class="AuthorName">Nikolai Tillmann</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">TouchDevelop: Programming on the Go</span><span class="BookEdition">Third Edition</span></span><span class="ChapterDOI">10.1007/978-1-4302-6137-7_11</span><span class="ChapterCopyright">© R. Nigel Horspool 2013</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">11. Authenticating Web Services</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">R. Nigel Horspool</span><sup>1 <span class="ContactIcon"/></sup> and </span><span class="Author"><span class="AuthorName">Nikolai Tillmann</span><sup>2 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff1"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Canada, USA</div></div><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(2)</span><div class="AffiliationText">TU Berlin, Germany</div></div><div class="ClearBoth"> </div></div></div><div class="ArticleOrChapterToc"><div class="TocLine"><a href="#Sec1">11.1 Registering your app</a></div><div class="TocLine"><a href="#Sec2">11.2 Authenticating</a></div><div class="TocLine"><a href="#Sec3">11.3 Libraries</a></div><div class="TocLine"><a href="#Sec4">11.4 Advanced topics</a></div></div><div class="Abstract" id="Abs1" xml:lang="en"><div class="Heading">Abstract</div><div class="Para">There are many web services on the internet which allow client applications to query and store all kinds of structured information. Some web services require the user to authenticate in order to use protected resources.</div></div><!--End Abstract--><div class="Fulltext"><div class="Para">There are many web services on the internet which allow client applications to query and store all kinds of structured information. Some web services require the user to authenticate in order to use protected resources.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">11.1 Registering your app</h2><div class="Para">A common source of web service calls is to Facebook’s Graph API<a href="#Fn1" id="Fn1_source"><sup>1</sup></a>. With this API, you can query and submit pictures, status updates, comments, and more. All interactions are done on behalf of a particular Facebook user. The user has to give permission to the application to access any part of the user’s information.</div><div class="Para">OAuth v2.0 is a common authentication mechanism for web services supported by Microsoft, Facebook, Google, and other companies. TouchDevelop supports the OAuth 2.0 <span class="EmphasisTypeItalic">Implicit Grant</span> flow protocol as defined in section 4.2 of the specification (<span class="ExternalRef"><a href="http://tools.ietf.org/html/rfc6749"><span class="RefSource">http:​/​/​tools.​ietf.​org/​html/​rfc6749</span></a></span>). Other protocols are not currently supported. After having negotiated an access token for a protected web services, TouchDevelop offers the ability to process and create structured data in formats such as JSON and XML.</div><div class="Para">Before you can use the OAuth mechanism to access a web service, you need to register the app you are working on with the provider of the web service. Every web service has its own registration mechanism; you must find and follow the instructions provided by the service you want to use.</div><div class="Para">Somewhere during the registration process you will be asked for a “redirect URI”. You MUST enter the following redirect URI precisely.</div><div class="Para ParaTypeProgramcode">   <span class="ExternalRef"><a href="https://www.touchdevelop.com/%5buserid%5d/oauth"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://www.touchdevelop.com/[userid]/oauth</span>
              </span></a></span>
          </div><div class="Para">where <span class="EmphasisFontCategoryNonProportional">[userid]</span> is your TouchDevelop user id. This is a short letter combination such as <span class="EmphasisFontCategoryNonProportional">pboj</span> which happens to be the userid for the TouchDevelop Samples user. Point your browser at <span class="ExternalRef"><a href="https://www.touchdevelop.com/me"><span class="RefSource">https:​/​/​www.​touchdevelop.​com/​me</span></a></span> to find out your user id. You will be redirected to a new URL, possibly after being asked to log in. The new URL has the form <span class="ExternalRef"><a href="https://www.touchdevelop.com/%5buserid"><span class="RefSource">https:​/​/​www.​touchdevelop.​com/​[userid</span></a></span>].</div><div class="Para">Only TouchDevelop scripts published under your account will be able to use this redirect URI. See the later section on unique redirect URIs for instructions on how to handle the situation where the OAuth provider you want to use requires unique URIs for each application.</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">11.2 Authenticating</h2><div class="Para">The OAuth 2.0 authentication is handled through the <span class="EmphasisFontCategoryNonProportional">web</span>→<span class="EmphasisFontCategoryNonProportional">oauth v2</span> action. The action takes the OAuth URL including the <span class="EmphasisFontCategoryNonProportional">client_id</span> and optional scope or other arguments. Do NOT include the state and <span class="EmphasisFontCategoryNonProportional">redirect_uri</span> arguments; they are automatically added by TouchDevelop.</div><div class="Para ParaTypeProgramcode">     <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">var</span></span>
            <span class="EmphasisFontCategoryNonProportional">oauth res := web → oauth v2(url)</span>
          </div><div class="Para">The response contains the access token or the details about the error, if any. You can then use the access token to sign each request as specified by the service.</div><div class="Para ParaTypeProgramcode">     <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">var</span></span>
            <span class="EmphasisFontCategoryNonProportional">access token := oauth res → access token</span>
          </div><div class="Para ParaTypeProgramcode">     <span class="EmphasisTypeBold"><span class="EmphasisFontCategoryNonProportional">var</span></span>
            <span class="EmphasisFontCategoryNonProportional">call := "http://....?access_token=" ∥ web → url encode(access token)</span>
          </div><div class="Para">You can use the <span class="EmphasisFontCategoryNonProportional">is expiring</span> action to easily test if an access token is missing or (almost expired).</div><div class="Para ParaTypeProgramcode">     <span class="EmphasisTypeBold">if</span> oauth res → is expiring(100) <span class="EmphasisTypeBold">then</span>
          </div><div class="Para ParaTypeProgramcode">          // Oops, better ask for a new token.</div><div class="Para ParaTypeProgramcode">     <span class="EmphasisTypeBold">else</span> do nothing</div><div class="Para">
            <div id="Tab1" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 11-1</span><div class="SimplePara">General methods related to OAuth 2.0</div></div></div><table border="1"><colgroup><col align="left"/><col align="left"/></colgroup><thead><tr class="header"><th align="left"><div class="SimplePara">Method</div></th><th align="left"><div class="SimplePara">Description</div></th></tr></thead><tbody><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">web → oauth v2(oauth url : String) : OAuth Response</span>
                      </div></td><td align="left"><div class="SimplePara">Authenticate with OAuth 2.0 and receive the access token or error.</div></td></tr></tbody></table></div>
            <div id="Tab2" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 11-2</span><div class="SimplePara">Properties of the OAuth Response type</div></div></div><table border="1"><colgroup><col align="left"/><col align="left"/></colgroup><thead><tr class="header"><th align="left"><div class="SimplePara">Method</div></th><th align="left"><div class="SimplePara">Description</div></th></tr></thead><tbody><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">access token : String</span>
                      </div></td><td align="left"><div class="SimplePara">The access token issued by the authorization server.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">error : String</span>
                      </div></td><td align="left"><div class="SimplePara">A single ASCII [USASCII] error code.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">error description : String</span>
                      </div></td><td align="left"><div class="SimplePara">(Optional) A human readable error code.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">error uri : String</span>
                      </div></td><td align="left"><div class="SimplePara">(Optional) A URI identifying a human-readable web page with information about the error, used to provide the client developer with additional information about the error.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">expires in : Number</span>
                      </div></td><td align="left"><div class="SimplePara">(Optional) The lifetime in seconds of the access token.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">is error : Boolean</span>
                      </div></td><td align="left"><div class="SimplePara">Indicates if this response is an error.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">is expiring(lookup : Number) : Boolean</span>
                      </div></td><td align="left"><div class="SimplePara">(Optional) Indicates if the token might expire within the next seconds.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">is invalid : Boolean</span>
                      </div></td><td align="left"><div class="SimplePara">Returns true if the current instance is useless</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">others : String Map</span>
                      </div></td><td align="left"><div class="SimplePara">(Optional) Additional key-value pairs not covered by the OAuth 2.0 specification.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">post to wall</span>
                      </div></td><td align="left"><div class="SimplePara">Displays the response.</div></td></tr><tr class="noclass"><td align="left"><div class="SimplePara">
                        <span class="EmphasisFontCategoryNonProportional">action scope : String</span>
                      </div></td><td align="left"><div class="SimplePara">(Optional) Optional if identical to the scope requested by the client; otherwise, the scope of the access token as described by Section 3.3 of the OAuth 2.0 specification.</div></td></tr></tbody></table></div>
          </div><div class="Para">Figure <span class="InternalRef"><a href="#Fig1">11-1</a></span> shows how to use the OAuth functionality provided by TouchDevelop in order to post a message to Facebook:
<div class="OrderedList"><div class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div class="Para">It builds a URL that will trigger the Facebook authentication process for your app, for a particular “scope” which defines what kind of permissions your app is requesting.</div></div><div class="ClearBoth"> </div></div><div class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div class="Para">Then it sends the actual message with the text to post. Note how not only the message text is encoded in a URL, but also the <span class="EmphasisFontCategoryNonProportional">access_token</span> that was obtained by the earlier authentication call.</div></div><div class="ClearBoth"> </div></div></div>
          </div><div class="Para">If you use a different web service, or want to post other kind of information, it might be the case that you need to pass the <span class="EmphasisFontCategoryNonProportional">access_token</span> in a header field of the web request, and you might have to send the payload in the body of a POST web request. Consult the documentation of the web service you want to use.
<div class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img src="A978-1-4302-6137-7_11_Fig1_HTML.jpg" alt="A978-1-4302-6137-7_11_Fig1_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-1</span><div class="SimplePara">Post a message to Facebook with OAuth</div></div></div></div>
          </div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">11.3 Libraries</h2><div class="Para">The following TouchDevelop libraries already implement the OAuth 2.0 authentication for a number of APIs. Each library contains detailed instructions on how to register an application in order to use them. Just search for the name of a library in the add-library-reference dialog.</div><div class="Para">Microsoft Live</div><div class="Para">Facebook</div><div class="Para">Google</div><div class="Para">Yammer</div><div class="Para">FourSquare</div><div class="Para">Instagram</div><div class="Para">Meetup</div><div class="Para">Figure <span class="InternalRef"><a href="#Fig2">11-2</a></span> shows how to use the Facebook library provided by TouchDevelop in order to post a message on Facebook. Before you can use the <span class="EmphasisFontCategoryNonProportional">♻ facebook</span> expression, you must add a reference to the Facebook library in your script.
<div class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img src="A978-1-4302-6137-7_11_Fig2_HTML.jpg" alt="A978-1-4302-6137-7_11_Fig2_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-2</span><div class="SimplePara">Using Facebook Library</div></div></div></div>
          </div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">11.4 Advanced topics</h2><div id="Sec5" class="Section2 RenderAsSection2"><h3 class="Heading">11.4.1 Unique redirect URIs</h3><div class="Para">Some OAuth providers, such as Microsoft Live, require unique redirect URIs with unique domain names for each application. In those cases the basic redirect URI that is just specific to your user id does not work. Instead, you can use the following redirect URI scheme:</div><div class="Para ParaTypeProgramcode">                      <span class="EmphasisFontCategoryNonProportional">https://[rdid]-[userid].users.touchdevelop.com/oauth</span>
            </div><div class="Para">where [<span class="EmphasisFontCategoryNonProportional">rdid</span>] is a unique identifier for the app (“redirect domain id”, fewer than 64 lower case alphanumeric ASCII characters) that you can choose, and [userid] is your TouchDevelop user id as before.</div><div class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">oauth res := web → oauth v2(url ∥ "&amp;tdredirectdomainid=[rdid]")</span>
            </div><div class="Para">When passing the authentication URL to <span class="EmphasisFontCategoryNonProportional">web</span>→<span class="EmphasisFontCategoryNonProportional">oauth v2</span>, add a <span class="EmphasisFontCategoryNonProportional">tdredirectdomainid</span> query argument to specify your [<span class="EmphasisFontCategoryNonProportional">rdid</span>].</div></div><div id="Sec6" class="Section2 RenderAsSection2"><h3 class="Heading">11.4.2 State variable in redirect URI</h3><div class="Para">Some OAuth providers fail to pass the state argument in the redirect URI, and this breaks the TouchDevelop OAuth support. In such case, add a <span class="EmphasisFontCategoryNonProportional">tdstateinredirecturi=true</span> query argument to the authentication URL.</div><div class="Para ParaTypeProgramcode">
              <span class="EmphasisFontCategoryNonProportional">oauth res := web → oauth v2(url ∥ "&amp;tdstateinredirecturi=true")</span>
            </div></div></div><div class="FootnoteSection"><div class="Heading">Footnotes</div><div class="Footnote" id="Fn1"><span class="FootnoteNumber"><a href="#Fn1_source">1</a></span><div class="FootnoteParas"><div class="Para">
                <span class="ExternalRef"><a href="http://developers.facebook.com/docs/reference/api/"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">http://developers.facebook.com/docs/reference/api/</span>
                  </span></a></span>
              </div></div><div class="ClearBoth"> </div></div></div></div></body></html>
